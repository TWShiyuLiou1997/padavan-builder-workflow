name: Build firmware (Ultimate Fix - Early Size Check)

permissions:
  contents: write

on:
  workflow_dispatch:
    inputs:
      target_select:
        description: "é¸æ“‡æ©Ÿå‹ (Target Model)"
        required: true
        default: 'TL_C2-V1'
        type: choice
        options:
          - TL_C2-V1
          - HC5661A
      
      nanoversion:
        description: "é–‹å•Ÿæ¥µé™ç˜¦èº« (Nano Optimization)"
        type: boolean
        default: true

      customization:
        description: 'è‡ªå®šç¾©é…ç½® JSON (Wi-Fi/å¯†ç¢¼/IP)'
        required: true
        type: string
        default: '{"lanip":"192.168.0.1","signaccount":"admin","signpassword":"admin","wifi2gssid":"Padavan","wifi2gpsk":"1234567890","wifi5gssid":"Padavan-5G","wifi5gpsk":"1234567890"}'

  push:
    tags:
      - '*'

jobs:
  build:
    runs-on: ubuntu-latest
    container: registry.gitlab.com/hadzhioglu/padavan-ng
    defaults: { run: { shell: bash } }
    
    steps:
      - name: Checkout Workflow
        uses: actions/checkout@v4

      # 0. ç’°å¢ƒåˆæª¢
      - name: Debug - Initial Environment Check
        run: |
          echo "::group::System Info"
          echo "User: $(whoami)"
          echo "PWD: $(pwd)"
          df -h
          echo "::endgroup::"

      # 1. å®‰è£ä¾è³´
      - name: Install Dependencies & Fix Timezone
        run: |
          echo "::group::Apt Update & Install"
          set -x 
          apt-get update
          DEBIAN_FRONTEND=noninteractive apt-get install -y tzdata autoconf autoconf-archive automake autopoint bison build-essential \
          ca-certificates cmake cpio curl dos2unix doxygen fakeroot flex gawk gettext git gperf \
          help2man htop kmod libarchive-tools libblkid-dev libc-ares-dev libcurl4-openssl-dev \
          libdevmapper-dev libev-dev libevent-dev libexif-dev libflac-dev libgmp3-dev \
          libid3tag0-dev libidn2-dev libjpeg-dev libkeyutils-dev libltdl-dev libmpc-dev \
          libmpfr-dev libncurses5-dev libogg-dev libsqlite3-dev libssl-dev libsystemd-dev \
          libtool libtool-bin libudev-dev libunbound-dev libvorbis-dev libxml2-dev locales \
          mc nano pkg-config ppp-dev python3 python3-docutils sshpass texinfo unzip uuid \
          uuid-dev vim wget xxd zlib1g-dev jq zip
          set +x
          echo "::endgroup::"

          echo "::group::Timezone Configuration"
          ln -fs /usr/share/zoneinfo/Asia/Taipei /etc/localtime
          dpkg-reconfigure -f noninteractive tzdata
          echo "BUILD_TIME=$(date +%Y%m%d-%H%M)" >> $GITHUB_ENV
          echo "::endgroup::"

      # 2. è¨­å®šè®Šæ•¸
      - name: Get variables
        run: |
          echo "::group::Variable Loading"
          if [ -f "variables" ]; then
            sed -i 's|\r$||g' variables
            . variables
          fi
          
          echo "PADAVAN_REPO=https://github.com/TWShiyuLiou1997/padavan-ng" >> $GITHUB_ENV
          echo "PADAVAN_BRANCH=master" >> $GITHUB_ENV
          echo "PADAVAN_COMMIT=HEAD" >> $GITHUB_ENV
          
          if [ -z "$PADAVAN_THEMES_REPO" ]; then
            echo "PADAVAN_THEMES_REPO=https://gitlab.com/hadzhioglu/padavan-themes.git" >> $GITHUB_ENV
            echo "PADAVAN_THEMES_BRANCH=main" >> $GITHUB_ENV
          fi
          
          for v in "${!PADAVAN_@}" "${!CONFIG_@}"; do
            echo "$v=${!v}" >> $GITHUB_ENV
          done
          echo "::endgroup::"

      # 3. ä¸‹è¼‰æºç¢¼
      - name: Download sources and toolchain
        run: |
          echo "::group::Git Clone"
          git config --global --add safe.directory '*'
          git clone -b "$PADAVAN_BRANCH" "$PADAVAN_REPO"
          if [ "$PADAVAN_COMMIT" != "HEAD" ] && [ ! -z "$PADAVAN_COMMIT" ]; then
            git -C padavan-ng checkout "$PADAVAN_COMMIT"
          fi
          wget -qO- "$PADAVAN_TOOLCHAIN_URL" | tar -C padavan-ng --zstd -xf -
          echo "::endgroup::"

      # 4. ç”Ÿæˆ Config
      - name: Generate build.config & Apply Nano
        run: |
          TNAME="${{ inputs.target_select }}"
          [ -z "$TNAME" ] && TNAME="TL_C2-V1"
          echo "::group::Template Search & Config Gen"
          
          TEMPLATE_DIR="padavan-ng/trunk/configs/templates"
          PATTERN_A=$(echo "$TNAME" | sed 's/-/_/g')
          PATTERN_B=$(echo "$TNAME")
          TARGET_FILE=$(find "$TEMPLATE_DIR" -maxdepth 2 \( -iname "${PATTERN_A}.config" -o -iname "${PATTERN_B}.config" \) | head -n 1)
          
          if [ -z "$TARGET_FILE" ]; then
            echo "::warning:: Template not found, using fallback..."
            TARGET_FILE="padavan-ng/trunk/configs/templates/tplink/tl_c2-v1.config"
          fi
          
          if [ ! -f "$TARGET_FILE" ]; then
            echo "::error:: Config file not found: $TARGET_FILE"
            exit 1
          fi
          cp -f "$TARGET_FILE" build.config
          FINAL_CONFIG="build.config"
          echo "::endgroup::"
          
          # === æ¥µé™ç˜¦èº«é‚è¼¯ (Ultimate Nano - TC/Cake Ready) ===
          if [ "${{ inputs.nanoversion }}" == "true" ]; then
            echo "::group::Nano Optimization - Final Execution"
         
            # 1. [é«”ç©å„ªåŒ–] å¼·åˆ¶é–‹å•Ÿ Size Optimization
            sed -i "s/#CONFIG_CC_OPTIMIZE_FOR_SIZE=y/CONFIG_CC_OPTIMIZE_FOR_SIZE=y/g" "$FINAL_CONFIG"
         
            # 2. [åŸºç¤åˆ‡é™¤] åœç”¨ USB, æª”æ¡ˆç³»çµ±, Swap, åª’é«”é©…å‹•
            for feat in USB ANTFS FAT EXFAT EXT2 EXT3 EXT4 XFS HFS FUSE SWAP BACKPORTED; do
              sed -i "s/CONFIG_FIRMWARE_ENABLE_${feat}=y/CONFIG_FIRMWARE_ENABLE_${feat}=n/gi" "$FINAL_CONFIG"
            done
         
            # 3. [èªè¨€åŒ…ç²¾æº–æ§åˆ¶] 
            sed -i "s/CONFIG_FIRMWARE_INCLUDE_LANG_EN=n/CONFIG_FIRMWARE_INCLUDE_LANG_EN=y/g" "$FINAL_CONFIG"
            sed -i "s/#CONFIG_FIRMWARE_INCLUDE_LANG_CN=y/CONFIG_FIRMWARE_INCLUDE_LANG_CN=y/g" "$FINAL_CONFIG"
            sed -i "s/CONFIG_FIRMWARE_INCLUDE_LANG_CN=n/CONFIG_FIRMWARE_INCLUDE_LANG_CN=y/g" "$FINAL_CONFIG"
            sed -i "s/CONFIG_FIRMWARE_INCLUDE_LANG_RU=y/CONFIG_FIRMWARE_INCLUDE_LANG_RU=n/g" "$FINAL_CONFIG"
            sed -i "s/CONFIG_FIRMWARE_INCLUDE_LANG_UK=y/CONFIG_FIRMWARE_INCLUDE_LANG_UK=n/g" "$FINAL_CONFIG"
         
            # 4. [åœ°æ¯¯å¼ç§»é™¤ - ç©¶æ¥µé˜²æ¼ç‰ˆ]
            # ç›®æ¨™ï¼šä¸ç®¡è©²é¸é …åŸæœ¬æ˜¯ =y, =m, é‚„æ˜¯ # is not setï¼Œé€šé€šå¼·åˆ¶æ”¹ç‚º =n
            echo "::group::Absolute Disable Modules"
            modules=(
              CIFS NTFS_3G LPRD U2EC USBIP HDPARM PARTED SMBD WINS SMBD_SYSLOG TESTPARM 
              FTPD FTPD_SSL NFSD NFSC
              UVC HID SERIAL AUDIO FIREFLY XUPNPD MINIDLNA FFMPEG_NEW 
              RPL2TP EAP_PEAP OPENVPN SSWAN WIREGUARD AMNEZIAWG ZEROTIER EOIP XFRM
              SHADOWSOCKS XRAY V2RAY TROJAN SSOBFS SINGBOX NAIVEPROXY
              REDSOCKS SRELAY MENTOHUST FRPC FRPS TOR TOR_GEOIP TOR_GEOIPV6
              PRIVOXY NFQWS
              IPSET DNSCRYPT STUBBY DOH QUIC QUIC_NGTCP2 NDISC6_RDISC6
              ADBYBY DNSFORWARDER SMARTDNS ADGUARDHOME WPAD
              LRZSZ IPERF3 DUMP1090 RTL_SDR SOCAT MTR 
              IMQ IFB
              ZRAM ADB LUA SQM ALDRIVER SCUTCLIENT GDUT_DRCOM DOGCOM MINIEAP 
              NJIT_CLIENT SOFTETHERVPN_SERVER SOFTETHERVPN_CLIENT SOFTETHERVPN_CMD
              DROPBEAR DROPBEAR_FAST_CODE VLMCSD TTYD MSD_LITE
              DDNS_SSL
            )
         
            for mod in "${modules[@]}"; do
              CFG_KEY="CONFIG_FIRMWARE_INCLUDE_${mod}"
              
              if grep -q "$CFG_KEY" "$FINAL_CONFIG"; then
                # å¦‚æœæ‰¾åˆ°è©²è¨­å®š (ä¸è«–æ˜¯é–‹å•Ÿã€é—œé–‰æˆ–è¨»è§£)ï¼Œæ•´è¡Œå¼·åˆ¶æ›¿æ›ç‚º =n
                sed -i "s|^.*$CFG_KEY.*$|$CFG_KEY=n|" "$FINAL_CONFIG"
                echo "   ğŸš« Forced Disabled: $mod (Overwritten)"
              else
                # å¦‚æœå®Œå…¨æ²’æ‰¾åˆ°ï¼Œå‰‡ä¸»å‹•è¿½åŠ  =n (é˜²æ­¢é»˜èªé–‹å•Ÿ)
                echo "$CFG_KEY=n" >> "$FINAL_CONFIG"
                echo "   ğŸš« Forced Disabled: $mod (Added)"
              fi
            done
            
            echo "::endgroup::"
          fi

          echo "::group::Core Modules Enforcement"
          # 5. å¼·åˆ¶ä¿ç•™ä¸¦é–‹å•Ÿçš„æ ¸å¿ƒæ¨¡çµ„
          keep_modules=(OPENSSH SFTP TCPDUMP CURL HTTPS OPENSSL_EC OPENSSL_EXE SHORTCUT_FE QOS)

          for kmod in "${keep_modules[@]}"; do
            sed -i "/CONFIG_FIRMWARE_INCLUDE_${kmod}/d" "$FINAL_CONFIG"
            echo "CONFIG_FIRMWARE_INCLUDE_${kmod}=y" >> "$FINAL_CONFIG"
          done
          echo "::endgroup::"

      # 5. æ‡‰ç”¨è‡ªå®šç¾©è¨­å®š (JSON)
      - name: Apply Custom Settings
        run: |
          echo "::group::JSON Parsing"
          echo '${{ inputs.customization }}' | jq -r 'to_entries[] | "\(.key)=\(.value)"' | while IFS='=' read -r k v; do
            export "${k^^}=$v"
          done
          
          LANIP=$(echo '${{ inputs.customization }}' | jq -r .lanip)
          SIGNACCOUNT=$(echo '${{ inputs.customization }}' | jq -r .signaccount)
          SIGNPASSWORD=$(echo '${{ inputs.customization }}' | jq -r .signpassword)
          WIFI2GSSID=$(echo '${{ inputs.customization }}' | jq -r .wifi2gssid)
          WIFI2GPSK=$(echo '${{ inputs.customization }}' | jq -r .wifi2gpsk)
          WIFI5GSSID=$(echo '${{ inputs.customization }}' | jq -r .wifi5gssid)
          WIFI5GPSK=$(echo '${{ inputs.customization }}' | jq -r .wifi5gpsk)
          
          export LANIP SIGNACCOUNT SIGNPASSWORD WIFI2GSSID WIFI2GPSK WIFI5GSSID WIFI5GPSK
          
          if [ -d "padavan-ng/trunk/custom/scripts" ]; then
            cd padavan-ng
            chmod +x trunk/custom/scripts/*.sh
            [ ! -z "$LANIP" ] && bash trunk/custom/scripts/setip.sh "$LANIP" trunk/user/shared/defaults.h trunk/user/www/dict/CN.dict || true
            [ ! -z "$SIGNACCOUNT" ] && bash trunk/custom/scripts/setaccount.sh "$SIGNACCOUNT" "$SIGNPASSWORD" trunk/user/shared/defaults.h || true
            [ ! -z "$WIFI2GSSID" ] && bash trunk/custom/scripts/setwifi.sh "$WIFI2GSSID" "$WIFI2GPSK" "$WIFI5GSSID" "$WIFI5GPSK" trunk/user/shared/defaults.h || true
          fi
          echo "::endgroup::"

      # 6. å®‰è£ Themes
      - name: Install themes
        run: |
          echo "::group::Themes Installation"
          if [ -f "variables" ]; then . variables; fi
          if [[ -n "${PADAVAN_THEMES[*]}" ]]; then
            git clone --depth 1 -b "$PADAVAN_THEMES_BRANCH" "$PADAVAN_THEMES_REPO" themes
            cp -r themes/common-theme themes/jquery.js padavan-ng/trunk/user/www/n56u_ribbon_fixed
            for theme in "${PADAVAN_THEMES[@]}"; do
              [ -d "themes/$theme-theme" ] && cp -r "themes/$theme-theme" padavan-ng/trunk/user/www/n56u_ribbon_fixed
            done
          fi
          echo "::endgroup::"

      # 7. ä¿®æ­£ mkimage
      - name: Fix mkimage
        run: |
          MKIMAGE_FILE="padavan-ng/trunk/tools/mkimage/mkimage.c"
          if [ -f "$MKIMAGE_FILE" ]; then
            sed -i 's/"%d\.%d"/"%hhd.%hhd"/g' "$MKIMAGE_FILE"
            sed -i 's/"%d\.%d%c"/"%hhd.%hhd%c"/g' "$MKIMAGE_FILE"
          fi

      # =======================================================
      # 7.5. [å…¨å±€ä¿®å¾©] å‡ç´š iptables 1.8.11 + ä¿®å¾©æ‰€æœ‰ä¾è³´åŒ…è·¯å¾‘ + å¥—ç”¨ Upstream Patches
      # =======================================================
      - name: ğŸ”¥ Auto Upgrade iptables 1.8.11 & Patch
        run: |
          set +e  # é—œé–‰éŒ¯èª¤ä¸­æ–·ï¼Œç¢ºä¿è·‘å®Œå…¨ç¨‹
          set -x  # å¦‚æœéœ€è¦æ¥µè‡´ Debug å¯æ‰“é–‹æ­¤è¡Œ
          
          echo "::group::Iptables Upgrade & Patching (1.8.11 Collector Mode)"
          
          NEW_VER="iptables-1.8.11"
          
          # --- Part 1: è™•ç† iptables æœ¬é«” ---
          IPT_MAKEFILE=$(find padavan-ng/trunk/user/iptables -name Makefile | head -n 1)
          IPT_DIR=$(dirname "$IPT_MAKEFILE")
          echo "âœ… é–å®š iptables Makefile: $IPT_MAKEFILE"
          
          # å¾ Makefile è£¡é¢æŠ“å‡ºç›®å‰çš„ç‰ˆæœ¬ (ä¾‹å¦‚ iptables-1.8.10)
          OLD_VER_STR=$(grep -o 'iptables-[0-9.]*' "$IPT_MAKEFILE" | head -n 1)
          echo "âœ… åµæ¸¬åˆ°èˆŠç‰ˆæœ¬: $OLD_VER_STR"
          echo "âœ… æº–å‚™å‡ç´šè‡³: $NEW_VER"
          
          # 1. ä¿®æ”¹ä¸» Makefile çš„ç‰ˆæœ¬è™Ÿ
          sed -i "s/$OLD_VER_STR/$NEW_VER/g" "$IPT_MAKEFILE"
          
          # 2. æ¢å¾©æ­£å¸¸çš„æ§‹å»ºæµç¨‹ (è§£æ±º cd error)
          sed -i 's/^all: config_test/all: download_test extract_test config_test/' "$IPT_MAKEFILE"
          
          # 3. ç§»é™¤ autogen.sh (è§£æ±º not found error)
          sed -i '/.\/autogen.sh/d' "$IPT_MAKEFILE"
          
          # 4. æ¸…ç†éæ™‚çš„ extensions/disabled è¤‡è£½æŒ‡ä»¤ (è§£æ±º copy error)
          sed -i '/extensions\/disabled\//d' "$IPT_MAKEFILE"

          # =======================================================
          # 5. [æ–°å¢] å®šç¾© Patch ä¸‹è¼‰å‡½æ•¸èˆ‡æ¸…å–® (V4 çµ‚æ¥µç‰ˆ)
          # =======================================================
          IPT_ROOT="padavan-ng/trunk/user/iptables/iptables-1.8.11" # æ³¨æ„ï¼šæ­¤æ™‚ç›®éŒ„å¯èƒ½å°šæœªè§£å£“ï¼Œä½†æˆ‘å€‘å…ˆæº–å‚™å¥½è·¯å¾‘
          # é€™è£¡æˆ‘å€‘å°‡ Patch ä¸‹è¼‰åˆ° Makefile åŒç´šç›®éŒ„ä¸‹çš„ patches_archive
          PATCH_DIR="$IPT_DIR/patches_archive"
          mkdir -p "$PATCH_DIR"
          LOG_FILE="$IPT_DIR/patch_summary.log"
          touch "$LOG_FILE"
          
          # âš™ï¸ è¨­å®šå€
          APPLY_PATCHES=true
          
          # å„ªåŒ–å…¨å±€ç¶²è·¯è¨­ç½®
          git config --global http.postBuffer 524288000
          git config --global http.lowSpeedLimit 0
          git config --global http.lowSpeedTime 999999
          git config --global http.sslVerify false

          # ğŸ› ï¸ V4 çµ‚æ¥µå‡½æ•¸: æ··åˆç­–ç•¥ (ä½é »è«‹æ±‚ + å‹•æ…‹å½è£ + è‡ªå‹•æ¸…æ´—)
          download_and_process() {
              local DATE=$1
              local RAW_NAME=$2
              local URL=$3
              local COUNT=$4
              
              # å‘½åæ¸…æ´—
              local SAFE_NAME=$(echo "$RAW_NAME" | sed 's/[^a-zA-Z0-9]/_/g')
              local PATCH_FILENAME="$PATCH_DIR/${COUNT}_${DATE}_${SAFE_NAME}.patch"
              local COOKIE_FILE="$IPT_DIR/cookies.txt"
              
              echo "---------------------------------------------------"
              echo "Processing Patch #$COUNT: $RAW_NAME"

              # [æˆ°ç•¥ 1] é™ä½ç‰¹å¾µè®Šæ›´é »ç‡ï¼šæ¯ 10 å€‹æª”æ¡ˆæ‰æ›ä¸€æ¬¡ UA
              if [ $((COUNT % 10)) -eq 1 ] || [ ! -f "$IPT_DIR/ua_cache.txt" ]; then
                  local MINOR_VER=$((RANDOM % 100))
                  echo "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/144.0.${MINOR_VER}.0 Safari/537.36" > "$IPT_DIR/ua_cache.txt"
                  rm -f "$COOKIE_FILE"
                  echo "ğŸ”„ Session Rotate: New UA & Cookies generated."
              fi
              local UA=$(cat "$IPT_DIR/ua_cache.txt")

              # [æˆ°ç•¥ 2] Header å›ºå®šåŒ–
              local H_SEC_CH_UA='"Not(A:Brand";v="8", "Chromium";v="144", "Google Chrome";v="144"'
              local H_SEC_PLATFORM='"Windows"'
              local H_LANG="en-US,en;q=0.9" 
              local ACCEPT_FILE="text/x-diff,text/plain,application/octet-stream;q=0.9,*/*;q=0.8"
              
              local COMMIT_URL=$(echo "$URL" | sed 's|/patch/|/commit/|')
              local LOG_URL="https://git.netfilter.org/iptables/log/"
              
              # [æˆ°ç•¥ 3] éš¨æ©Ÿé•·ä¼‘æ¯
              if [ $((COUNT % 30)) -eq 0 ]; then
                  local SLEEP_LONG=$(shuf -i 20-40 -n 1)
                  echo "â˜• Coffee Break: Sleeping for ${SLEEP_LONG}s..."
                  sleep $SLEEP_LONG
              else
                  sleep $(shuf -i 2-4 -n 1)
              fi

              local MAX_RETRIES=5
              local DOWNLOAD_SUCCESS=false

              for ((i=1; i<=MAX_RETRIES; i++)); do
                  local BACKOFF_TIME=$((5 * i + 5))
                  
                  local PREFLIGHT_DONE=false
                  if [ $((RANDOM % 5)) -eq 0 ] || [ $i -gt 1 ]; then
                      echo "ğŸ­ Performing Pre-flight check (Visiting Commit Page)..."
                      curl -k -L -s -o /dev/null \
                           -c "$COOKIE_FILE" -b "$COOKIE_FILE" \
                           -H "User-Agent: $UA" \
                           -H "Referer: $LOG_URL" \
                           "$COMMIT_URL"
                      sleep 1
                      PREFLIGHT_DONE=true
                  fi

                  if [ "$PREFLIGHT_DONE" = true ]; then
                      local CUR_REFERER="$COMMIT_URL"
                  else
                      local CUR_REFERER="$LOG_URL"
                  fi

                  # å˜—è©¦ä¸‹è¼‰ (Curl)
                  if curl -k -L -s \
                        -c "$COOKIE_FILE" -b "$COOKIE_FILE" \
                        -H "User-Agent: $UA" \
                        -H "Accept: $ACCEPT_FILE" \
                        -H "Accept-Language: $H_LANG" \
                        -H "Referer: $CUR_REFERER" \
                        -H "sec-ch-ua: $H_SEC_CH_UA" \
                        -H "sec-ch-ua-platform: $H_SEC_PLATFORM" \
                        --connect-timeout 20 \
                        --retry 2 \
                        -o "$PATCH_FILENAME" "$URL"; then
                      
                      if [ -s "$PATCH_FILENAME" ] && grep -qE "^diff --git|^--- a/" "$PATCH_FILENAME"; then
                          echo "âœ… [Attempt $i] Download Success"
                          DOWNLOAD_SUCCESS=true
                          break
                      else
                          echo "âš ï¸ Invalid content detected. Rotating identity..."
                          rm -f "$COOKIE_FILE" "$IPT_DIR/ua_cache.txt"
                      fi
                  fi
                  
                  # ç­–ç•¥ B: Wget (Clean Request)
                  echo "âš ï¸ Curl failed. Switching to Wget..."
                  rm -f "$PATCH_FILENAME"
                  
                  if wget --no-check-certificate -q \
                        --user-agent="$UA" \
                        --header="Accept: $ACCEPT_FILE" \
                        --header="Referer: $COMMIT_URL" \
                        --header="sec-ch-ua: $H_SEC_CH_UA" \
                        --header="sec-ch-ua-platform: $H_SEC_PLATFORM" \
                        -O "$PATCH_FILENAME" "$URL"; then
                        
                      if [ -s "$PATCH_FILENAME" ] && grep -qE "^diff --git|^--- a/" "$PATCH_FILENAME"; then
                          echo "âœ… [Attempt $i] Download Success (Wget)"
                          DOWNLOAD_SUCCESS=true
                          break
                      fi
                  fi
                  
                  echo "âŒ [Attempt $i] Failed. Cooling down ${BACKOFF_TIME}s..."
                  rm -f "$PATCH_FILENAME"
                  if [ $i -lt $MAX_RETRIES ]; then
                      sleep $BACKOFF_TIME
                  fi
              done

              if [ "$DOWNLOAD_SUCCESS" = false ]; then
                  echo "âŒ DOWNLOAD FAILED: $RAW_NAME"
                  echo "[$DATE] #$COUNT DOWNLOAD_FAIL : $RAW_NAME" >> "$LOG_FILE"
                  return 0
              fi
              
              # å¦‚æœé–‹é—œé–‹å•Ÿï¼ŒåŸ·è¡Œ Patch å¥—ç”¨
              if [ "$APPLY_PATCHES" = true ]; then
                  echo "ğŸ“¦ Patch downloaded and ready for Makefile injection."
              else
                  echo "ğŸ“¦ Patch downloaded (Collection Mode)."
              fi
          }

          # å¯«å…¥ Patch æ¸…å–® (Oldest -> Newest)
          cat << 'EOL' > "$IPT_DIR/patch_list.txt"
          2024-11-08|configure: Bump version for 1.8.11 release|https://git.netfilter.org/iptables/patch/?id=0506bea1dcc8f12d94e7c32bf2fb04abb3fdd269
          2024-11-12|ip[6]tables-translate: fix test failures when WESP is defined|https://git.netfilter.org/iptables/patch/?id=e6e232d0ae252b0b86278455b18d9475b95db8f0
          2024-11-19|nft: fix interface comparisons in -C commands|https://git.netfilter.org/iptables/patch/?id=40406dbfaefbc204134452b2747bae4f6a122848
          2024-11-19|nft: Drop interface mask leftovers from post_parse callbacks|https://git.netfilter.org/iptables/patch/?id=b3f3e256c263b9a1db49732696aba0dde084ef5e
          2025-01-28|configure: Avoid addition assignment operators|https://git.netfilter.org/iptables/patch/?id=6310639f697d4a570286960c470a6ec8c324be89
          2025-04-10|nft: Make add_log() static|https://git.netfilter.org/iptables/patch/?id=17fb168f007eb4200a1d3325898cf5256a029d81
          2025-04-10|nft: ruleparse: Introduce nft_parse_rule_expr()|https://git.netfilter.org/iptables/patch/?id=d84b1647514f3121bd4a6adfca9a977751c39bbc
          2025-04-10|nft: __add_{match,target}() can't fail|https://git.netfilter.org/iptables/patch/?id=2db8bf2fbf080f6a054b658df65c468bfa0db68d
          2025-04-10|nft: Introduce UDATA_TYPE_COMPAT_EXT|https://git.netfilter.org/iptables/patch/?id=f6f0f4f55794a5f1add6f728f80f29f12f36ecd5
          2025-04-10|nft-ruleparse: Fallback to compat expressions in userdata|https://git.netfilter.org/iptables/patch/?id=ff5f6a208efccd4e2bd8d4fdaf5d284ce54ff69e
          2025-04-10|nft: Pass nft_handle into add_{action,match}()|https://git.netfilter.org/iptables/patch/?id=739d9bd57ad26bd52bed569264daa97b5943e08d
          2025-04-10|nft: Embed compat extensions in rule userdata|https://git.netfilter.org/iptables/patch/?id=7746fa0b1619e1bd8465c9a98bdbead628ed428a
          2025-04-10|tests: iptables-test: Add nft-compat variant|https://git.netfilter.org/iptables/patch/?id=fdb541cddad0681ea3ab1fca8a3949dcf49fb194
          2025-04-23|extensions: icmp: Support info-request/-reply type names|https://git.netfilter.org/iptables/patch/?id=1e6a2812971a268428b04b03520cd68cb61d76e3
          2025-04-23|xshared: Accept an option if any given command allows it|https://git.netfilter.org/iptables/patch/?id=192c3a6bc18f206895ec5e38812d648ccfe7e281
          2025-07-04|extensions: sctp: Translate bare -m sctp match|https://git.netfilter.org/iptables/patch/?id=12e6b5ed65fd91ea413a2e45201289c3d01c4e29
          2025-07-17|extensions: libebt_redirect: prevent translation|https://git.netfilter.org/iptables/patch/?id=d33c6ad308cf7b9f627aeed48a5163c0374b5035
          2025-07-22|libxtables: Promote xtopt_esize_by_type() as xtopt_psize getter|https://git.netfilter.org/iptables/patch/?id=786b75f7c9b9feaa294da097c2e9727747162c79
          2025-07-22|Revert libxtables: Promote xtopt_esize_by_type() as xtopt_psize getter|https://git.netfilter.org/iptables/patch/?id=f66687b6cb5fd0bb36107c30339aa7f4ff75e98e
          2025-07-22|xtables-monitor: Print -X command for base chains, too|https://git.netfilter.org/iptables/patch/?id=8cb0c13b7777e72ca6f4265845dc99eff7cdf679
          2025-08-21|extensions: man: Add a note about route_localnet sysctl|https://git.netfilter.org/iptables/patch/?id=102e9607c63266c7f3413f8dcae51d9476e396e4
          2025-08-25|man: iptables-restore.8: document flush behaviour for user-defined chains|https://git.netfilter.org/iptables/patch/?id=c3d5053db05f99bd72219aebeefc7fb0195ac041
          2025-11-27|nft: Support replacing a rule added in the same batch|https://git.netfilter.org/iptables/patch/?id=78d7a5f8619f3965ec2da13003a876c808c40cfb
          EOL

          # åŸ·è¡Œä¸‹è¼‰
          count=0
          while IFS='|' read -r p_date p_name p_url; do
              [ -z "$p_date" ] && continue
              count=$((count+1))
              # è£œé›¶ä»¥ç¢ºä¿ glob æ’åºæ­£ç¢º (01, 02... 23)
              count_str=$(printf "%02d" $count)
              download_and_process "$p_date" "$p_name" "$p_url" "$count_str"
          done < "$IPT_DIR/patch_list.txt"

          echo "ğŸ‰ Patch processing cycle completed!"
          
          if [ -s "$LOG_FILE" ]; then
              echo "âš ï¸ ================= SUMMARY ================="
              cat "$LOG_FILE"
              echo "=========================================="
          else
              echo "âœ… Perfect! No errors recorded."
          fi

          # =======================================================
          # [ç¬¬100è™Ÿ Patch] æ‡‰ç”¨å±è”½è­¦å‘Šè£œä¸ (å¯¬å®¹æ¨¡å¼)
          # =======================================================
          echo "ğŸ”§ Generating warning suppression patch (Patch #100)..."
          
          PATCH_100="$PATCH_DIR/100_Custom_Suppress_Warnings.patch"
          
          cat << 'END_PATCH' > "$PATCH_100"
          --- a/libxtables/xtables.c
          +++ b/libxtables/xtables.c
          @@ -809,9 +809,11 @@
           		dptr = &((*dptr)->next);
           	}
           
          +#if 0
           	if (seen && !found)
           		fprintf(stderr,
           			"Warning: Extension %s is not supported, missing kernel module?\n",
           			name);
          +#endif
           
           	for (ptr = xtables_matches; ptr; ptr = ptr->next) {
          @@ -939,9 +941,11 @@
           		dptr = &((*dptr)->next);
           	}
           
          +#if 0
           	if (seen && !found)
           		fprintf(stderr,
           			"Warning: Extension %s is not supported, missing kernel module?\n",
           			name);
          +#endif
           
           	for (ptr = xtables_targets; ptr; ptr = ptr->next) {
          END_PATCH

          # åªæœ‰åœ¨é–‹å•Ÿå¥—ç”¨æ¨¡å¼æ™‚æ‰åŸ·è¡Œ
          if [ "$APPLY_PATCHES" = true ]; then
              echo "ğŸ©¹ Applying Custom Patch #100..."
              # ä½¿ç”¨ fuzz åƒæ•¸å…è¨±äº›å¾®çš„è¡Œè™Ÿå·®ç•°ï¼Œå¢åŠ æˆåŠŸç‡
              # é€™è£¡é‡å°æºç¢¼é€²è¡Œä¹¾è·‘æ¸¬è©¦ï¼Œæˆ–æ˜¯åœ¨ç¨å¾Œçš„ Makefile éšæ®µçµ±ä¸€è™•ç†
              # ä½†ç‚ºäº†é©—è­‰å…§å®¹ï¼Œæˆ‘å€‘å¯ä»¥å˜—è©¦æ¨¡æ“¬æª¢æŸ¥ (å¦‚æœ libxtables/xtables.c å·²å­˜åœ¨)
              TARGET_FILE="libxtables/xtables.c"
              
              if [ -f "$IPT_DIR/$TARGET_FILE" ]; then
                  if patch -t -N -l -F 10 -p1 --no-backup-if-mismatch --dry-run < "$PATCH_100" > /dev/null; then
                      echo "âœ… Patch #100 Check: Looks applicable."
                  else
                      echo "âš ï¸ Patch #100 Check: Might fail (Context mismatch or already applied)."
                  fi
              fi
              
              # 7. æ³¨å…¥è£œä¸æ‡‰ç”¨é‚è¼¯
              # ä½¿ç”¨ sort ç¢ºä¿è£œä¸ä¾æª”åé †åºå¥—ç”¨ (01, 02 ... 23, 99)
              # æ³¨æ„ï¼šæˆ‘å€‘å°‡ patch -d æŒ‡å‘ SRC_NAME (è§£å£“å¾Œçš„ç›®éŒ„)ï¼Œä¸¦ä½¿ç”¨ ../patches_archive/ ä¸‹çš„æª”æ¡ˆ
              sed -i 's|tar xJf $(SRC_NAME).tar.xz;|tar xJf $(SRC_NAME).tar.xz \&\& echo "ğŸ©¹ Patching..." \&\& for p in `ls ../patches_archive/*.patch | sort`; do echo "   - Applying $$p"; patch -d $(SRC_NAME) -p1 < $$p || exit 1; done;|' "$IPT_MAKEFILE"
              
              echo "âœ… Iptables æœ¬é«”ä¿®å¾©èˆ‡ Patch æ³¨å…¥å®Œæˆ (Makefile Modified)."
          else
              echo "ğŸ“¦ Custom Patch #100 generated but NOT applied."
              echo "ğŸš« Skipping Makefile injection (APPLY_PATCHES=false)"
          fi
          
          # =======================================================
          # ğŸ” ç„¡æ¢ä»¶é©—è­‰ä»£ç¢¼å…§å®¹ (ç¢ºä¿ç„¡è«–æ˜¯å¦ Patchï¼Œç‹€æ…‹éƒ½é€æ˜)
          # =======================================================
          echo "ğŸ” Verifying code content (Checking for applied changes)..."
          # æ³¨æ„ï¼šæ­¤æ™‚æºç¢¼å¯èƒ½å°šæœªè§£å£“ï¼Œå¦‚æœå°šæœªè§£å£“ï¼Œé€™è£¡æœƒæç¤ºæ‰¾ä¸åˆ°æª”æ¡ˆï¼Œé€™æ˜¯æ­£å¸¸çš„ã€‚
          # ä½†å¦‚æœæˆ‘å€‘æ˜¯åœ¨æœ¬åœ°ç’°å¢ƒå¤šæ¬¡åŸ·è¡Œï¼Œæˆ–è€…å·²ç¶“æœ‰è§£å£“å¾Œçš„æºç¢¼ï¼Œé€™è£¡å°±èƒ½æ´¾ä¸Šç”¨å ´ã€‚
          # è‹¥è¦é©—è­‰æœ€çµ‚çµæœï¼Œé€šå¸¸è¦ç­‰åˆ°ç·¨è­¯å¾Œã€‚é€™è£¡çš„é©—è­‰ä¸»è¦é‡å°ã€Œå¦‚æœæª”æ¡ˆå­˜åœ¨ã€ã€‚
          VERIFY_TARGET="libxtables/xtables.c"
          
          # ä½¿ç”¨ IPT_DIR è®Šæ•¸ç¢ºä¿è·¯å¾‘æ­£ç¢º
          if [ -f "$IPT_DIR/$VERIFY_TARGET" ]; then
              # æª¢æŸ¥æ˜¯å¦å«æœ‰ç‰¹å¾µç¢¼ (#if 0 åŒ…è£¹è‘— Warning)
              if grep -q "#if 0" "$IPT_DIR/$VERIFY_TARGET" && grep -q "Warning: Extension %s is not supported" "$IPT_DIR/$VERIFY_TARGET"; then
                  echo "âœ… Verification Passed: Code IS patched/modified (Warnings suppressed)."
                  echo "ğŸ‘‡ Current Code Snippet (Looks Good):"
                  # é¡¯ç¤ºåŒ¹é…è¡ŒåŠå…¶ä¸Šä¸‹ 3 è¡Œï¼Œæ–¹ä¾¿äººå·¥ç¢ºèª
                  grep -nC 3 "Warning: Extension %s is not supported" "$IPT_DIR/$VERIFY_TARGET"
              else
                  echo "âš ï¸ Verification Result: Code is UNPATCHED (Warnings active)."
                  echo "ğŸ‘‡ Current Code Snippet (Original/Unpatched):"
                  grep -nC 3 "Warning: Extension %s is not supported" "$IPT_DIR/$VERIFY_TARGET"
              fi
          else
              echo "â„¹ï¸ Verification skipped: Source file $VERIFY_TARGET not found yet (will be extracted during build)."
              echo "   (This is normal for a clean build before compilation starts)"
          fi
          
          # --- Part 2: [æ–°å¢] ä¿®å¾©æ‰€æœ‰ä¾è³´ iptables çš„å…¶ä»–è»Ÿé«” (MiniUPnPD ç­‰) ---
          echo "ğŸ” é–‹å§‹æƒæä¸¦ä¿®å¾©ä¾è³´èˆŠç‰ˆ iptables çš„å…¶ä»–å¥—ä»¶..."
          
          # æœå°‹ trunk/user ä¸‹æ‰€æœ‰å«æœ‰ "iptables-1.8.10" å­—ä¸²çš„ Makefile
          grep -rl "$OLD_VER_STR" padavan-ng/trunk/user/ | while read -r file ; do
              echo "  - ä¿®å¾©è·¯å¾‘: $file"
              sed -i "s/$OLD_VER_STR/$NEW_VER/g" "$file"
          done
          
          echo "ğŸ‰ å…¨å±€è·¯å¾‘æ›¿æ›å®Œæˆï¼æ‰€æœ‰å¥—ä»¶ç¾åœ¨éƒ½æŒ‡å‘ $NEW_VER"
          echo "::endgroup::"

      # 7.6 [ç¶²è·¯å·¥å…·] æ™ºæ…§ç·¨è­¯ æ–°å¢ Arptables
      - name: ğŸ”¥ Network Tools (Smart Compile Arptables)
        run: |
          echo "::group::Smart Compile Network Tools"
          
          # === è¨­å®šè·¯å¾‘ ===
          BASE_DIR="$GITHUB_WORKSPACE/padavan-ng/trunk/user"
          ARP_ROOT="$BASE_DIR/arptables"
          
          # ========================================
          # 1. æ–°å¢ Arptables v0.0.5
          # ========================================
          echo "â¬‡ï¸ Processing Arptables..."
          
          mkdir -p "$ARP_ROOT"
          cd "$ARP_ROOT" || exit 1
          
          # æª¢æŸ¥æ˜¯å¦å·²ç¶“è¨­å®šéï¼Œé¿å…é‡è¤‡åŸ·è¡Œ
          if [ ! -f "Makefile" ] || ! grep -q "arptables" "Makefile"; then
            
            ARP_TAR="arptables-0.0.5.tar.gz"
            ARP_URL="https://www.netfilter.org/pub/arptables/arptables-0.0.5.tar.gz"
            
            echo "   Downloading $ARP_URL ..."
            wget --no-check-certificate "$ARP_URL" -O "$ARP_TAR" || exit 1
            tar -xf "$ARP_TAR" || exit 1
            rm -f "$ARP_TAR"
            
            # æ‰¾å‡ºè§£å£“å¾Œçš„ç›®éŒ„åç¨±
            ARP_SRC_NAME=$(ls -d arptables-0*/ | head -n 1 | sed 's/\///')
            echo "   Detected source: [$ARP_SRC_NAME]"
            chmod -R u+w "$ARP_SRC_NAME"
          
            echo "ğŸ”§ Creating Arptables Wrapper Makefile..."
            
            # å»ºç«‹å¤–å±¤ Makefileï¼Œè®“ç·¨è­¯ç³»çµ±çŸ¥é“å¦‚ä½•ç·¨è­¯å®ƒ
            cat << EOF > Makefile
          SRC_NAME=$ARP_SRC_NAME
          
          all:
          	\$(MAKE) -C \$(SRC_NAME) \
          		CC="\$(CC)" \
          		AR="\$(AR)" \
          		KERNEL_DIR=\$(KERNEL_HEADERS_PATH) \
          		COPT_FLAGS="-Os -static" \
          		LDFLAGS="-static" \
          		arptables-legacy
          
          romfs:
          	\$(ROMFSINST) \$(SRC_NAME)/arptables-legacy /bin/arptables
          
          clean:
          	\$(MAKE) -C \$(SRC_NAME) clean
          EOF
          
            echo "ğŸ”§ Registering arptables in trunk/user/Makefile..."
            cd "$BASE_DIR" || exit 1
            
            # å°‡ arptables åŠ å…¥ç·¨è­¯åˆ—è¡¨
            # é‚è¼¯ï¼šå¦‚æœåœ¨ Makefile è£¡é‚„æ²’çœ‹åˆ° arptablesï¼Œå°±åŠ é€²å»
            if ! grep -q "dir_y += arptables" Makefile; then
                # å˜—è©¦åŠ åœ¨ ebtables å¾Œé¢ï¼Œä¿æŒæ•´é½Š
                if grep -q "dir_y += ebtables" Makefile; then
                    sed -i '/dir_y += ebtables/a dir_y += arptables' Makefile
                else
                    # æ‰¾ä¸åˆ° ebtables å°±åŠ åœ¨æª”æ¡ˆæœ€å¾Œ
                    echo "dir_y += arptables" >> Makefile
                fi
                echo "   âœ… Added to compilation list."
            else
                echo "   âš ï¸ Already in compilation list."
            fi
            
          else
            echo "âš ï¸ Arptables seems already configured. Skipping."
          fi

          # ========================================
          # 2. æ ¸å¿ƒæ”¯æ´ (ç©¶æ¥µåš´è¬¹ Kernel Config)
          # ========================================
          echo "ğŸ”§ Deep-Cleaning & Enabling Kernel modules..."
          cd "$GITHUB_WORKSPACE"
          TARGET_KCONF="padavan-ng/trunk/linux-3.4.x/.config"
          
          if [ -f "$TARGET_KCONF" ]; then
             MODULES="CONFIG_IP_NF_ARPTABLES CONFIG_IP_NF_ARPFILTER CONFIG_IP_NF_ARP_MANGLE CONFIG_NF_LOG_ARP CONFIG_BRIDGE_EBT_ARP CONFIG_BRIDGE_EBT_ARPREPLY"
             for mod in $MODULES; do
                if grep -q "$mod" "$TARGET_KCONF"; then
                   sed -i "s|^.*$mod.*$|$mod=m|" "$TARGET_KCONF"
                   echo "   âœ… Forced $mod=m (Updated)"
                else
                   echo "$mod=m" >> "$TARGET_KCONF"
                   echo "   âœ… Forced $mod=m (Added)"
                fi
             done
          fi
          
          echo "::endgroup::"

          # 7.7 [é©…å‹•é­”æ”¹] é›™é‡é–å®šï¼šä¿®å¾© Beacon è¶…æ™‚ + é˜²æ­¢ Peer è¸¢é™¤å¾Œå¤±æ†¶ (å¢å¼·ç‰ˆ)
      - name: ğŸ”¥ Patch MT7610E Driver (Anti-Disconnect & Fast Reconnect)
        run: |
          echo "::group::Applying Ultimate Driver Patch"
          
          # 1. ç²¾æº–æœå°‹ç›®æ¨™æª”æ¡ˆ
          # ---------------------------------------------------
          # æœå°‹ mt7610 ç›®éŒ„ä¸‹çš„ ap_apcli.c (Beaconæ§åˆ¶)
          TARGET_APCLI=$(find padavan-ng/trunk/proprietary/rt_wifi/rtpci/3.0.X.X -type f -name "ap_apcli.c" | grep "mt7610" | head -n 1)
          
          # æœå°‹ mt7610 ç›®éŒ„ä¸‹çš„ apcli_ctrl.c (é€£ç·šæ§åˆ¶)
          # æ³¨æ„ï¼šç›´æ¥æœå°‹æª”æ¡ˆï¼Œä¸ä¾è³´ dirname æ¨ç®—
          TARGET_CTRL=$(find padavan-ng/trunk/proprietary/rt_wifi/rtpci/3.0.X.X -type f -name "apcli_ctrl.c" | grep "mt7610" | head -n 1)

          if [ -f "$TARGET_APCLI" ] && [ -f "$TARGET_CTRL" ]; then
            echo "âœ… æ‰¾åˆ°é©…å‹•æ ¸å¿ƒæª”æ¡ˆï¼š"
            echo "   - Beaconæ§åˆ¶: $TARGET_APCLI"
            echo "   - é€£ç·šæ§åˆ¶:   $TARGET_CTRL"
          else
            echo "::error:: âŒ æ‰¾ä¸åˆ°é©…å‹•æª”æ¡ˆï¼è«‹æª¢æŸ¥è·¯å¾‘ã€‚"
            exit 1
          fi

          # 2. ä¿®å¾© Beacon è¶…æ™‚ (ç¶­æŒåŸé‚è¼¯)
          # ---------------------------------------------------
          echo "ğŸ”§ Patching Beacon Timeout..."
          cp "$TARGET_APCLI" "${TARGET_APCLI}.bak"
          
          # å°‡ 12 * OS_HZ æ”¹ç‚º 60 * OS_HZ
          sed -i 's/12[[:space:]]*\*[[:space:]]*OS_HZ/60 * OS_HZ/g' "$TARGET_APCLI"
          
          if grep -q "60 \* OS_HZ" "$TARGET_APCLI"; then
             echo "   âœ… Beacon Timeout patch applied."
          else
             echo "::error:: âŒ Beacon patch failed. (Pattern not found)"
             exit 1
          fi

          # 3. ä¿®å¾© Peer Disconnect (æ®­å±é‡é€£æ¨¡å¼)
          # ---------------------------------------------------
          echo "ğŸ”§ Patching Peer Disconnect Logic..."
          cp "$TARGET_CTRL" "${TARGET_CTRL}.bak"
          
          # ä½¿ç”¨ sed è¨»è§£æ‰æ¸…é™¤ SSID/BSSID çš„ä»£ç¢¼
          # ä½¿ç”¨ [[:space:]]* å¿½ç•¥ç©ºæ ¼/Tabå·®ç•°ï¼Œä¸¦åŒ¹é… NdisZeroMemory
          
          # A. ç¦æ­¢æ¸…é™¤ BSSID
          sed -i 's/^[[:space:]]*NdisZeroMemory.*ApCliMlmeAux.Bssid/\/\/&/' "$TARGET_CTRL"
          
          # B. ç¦æ­¢æ¸…é™¤ SSID é•·åº¦
          sed -i 's/^[[:space:]]*.*ApCliMlmeAux.SsidLen[[:space:]]*=[[:space:]]*0/\/\/&/' "$TARGET_CTRL"
          
          # C. ç¦æ­¢æ¸…é™¤ SSID å­—ä¸²
          sed -i 's/^[[:space:]]*NdisZeroMemory.*ApCliMlmeAux.Ssid,/\/\/&/' "$TARGET_CTRL"
          
          # D. ç¦æ­¢æ¸…é™¤ RSSI
          sed -i 's/^[[:space:]]*.*ApCliMlmeAux.Rssi[[:space:]]*=[[:space:]]*0/\/\/&/' "$TARGET_CTRL"

          # 4. é©—è­‰ä¿®å¾©çµæœ
          # ---------------------------------------------------
          echo "ğŸ” Verifying apcli_ctrl.c changes..."
          
          # æª¢æŸ¥æ˜¯å¦æœ‰ä»»ä½•ä¸€è¡Œè¢«è¨»è§£æ‰ (å«æœ‰ //NdisZeroMemory...ApCliMlmeAux)
          if grep -q "//.*NdisZeroMemory.*ApCliMlmeAux" "$TARGET_CTRL"; then
             echo "ğŸ‰ Ultimate Fix Applied! (Fast Reconnect Mode Enabled)"
             echo "--------------------------------------"
             # é¡¯ç¤ºä¿®æ”¹å¾Œçš„é—œéµç‰‡æ®µä¾›ç¢ºèª
             grep -n "//.*NdisZeroMemory" "$TARGET_CTRL" | head -n 5
             echo "--------------------------------------"
          else
             echo "::error:: âŒ apcli_ctrl.c patch failed!"
             echo "DEBUG: åŸå§‹æª”æ¡ˆå…§å®¹ç‰‡æ®µ (ä¾›æª¢æŸ¥):"
             grep -C 2 "ApCliMlmeAux.Bssid" "$TARGET_CTRL" | head -n 10
             exit 1
          fi
          
          echo "::endgroup::"

      # 8. é–‹å§‹ç·¨è­¯
      - name: Build firmware
        run: |
          echo "::group::Build Process"
          cp build.config padavan-ng/trunk/.config
          cd padavan-ng/trunk
          
          ./clear_tree.sh > /dev/null 2>&1
          rm -rf tmp staging
          
          echo "Starting build... Logs will be saved to build.log"
          set -o pipefail
          ./build_firmware.sh 2>&1 | tee build.log
          echo "::endgroup::"

      # 9. æ™ºæ…§æ‰“åŒ…èˆ‡ç”¢ç‰©åµæ¸¬ (å« iptables Debug æª”æ¡ˆ)
      - name: Smart-Pack & Debug Collection
        run: |
          echo "::group::Smart Packing"
          
          # 0. è¼‰å…¥ç·¨è­¯å¾Œçš„è®Šæ•¸ (ä¿®å¾© Partition Check è­¦å‘Š)
          if [ -f "padavan-ng/trunk/.config" ]; then
            source "padavan-ng/trunk/.config"
          fi

          # 1. å®šç¾©çµ•å°è·¯å¾‘
          WORK_DIR=$(pwd)
          PACK_DIR="$WORK_DIR/output_pack"
          IMAGES_DIR="$WORK_DIR/padavan-ng/trunk/images"
          PARTITIONS_FILE="$WORK_DIR/padavan-ng/trunk/configs/boards/$CONFIG_VENDOR/$CONFIG_FIRMWARE_PRODUCT_ID/partitions.config"
          
          mkdir -p "$PACK_DIR"
          
          # åˆå§‹åŒ–å ±å‘Š
          REPORT_FILE="$PACK_DIR/file_report.txt"
          touch "$REPORT_FILE"
          
          echo "Packing Artifacts to: $PACK_DIR"
          
          # 2. å‚™ä»½é—œéµé…ç½®æª”
          echo "Collecting Debug Configurations..."
          [ -f "padavan-ng/trunk/.config" ] && cp "padavan-ng/trunk/.config" "$PACK_DIR/build.config"
          [ -f "padavan-ng/trunk/user/shared/defaults.h" ] && cp "padavan-ng/trunk/user/shared/defaults.h" "$PACK_DIR/defaults.h.txt"
          [ -f "padavan-ng/trunk/user/www/dict/CN.dict" ] && cp "padavan-ng/trunk/user/www/dict/CN.dict" "$PACK_DIR/CN.dict.txt"
          [ -f "padavan-ng/trunk/linux-3.4.x/.config" ] && cp "padavan-ng/trunk/linux-3.4.x/.config" "$PACK_DIR/kernel.config"
          [ -f "padavan-ng/trunk/build.log" ] && cp "padavan-ng/trunk/build.log" "$PACK_DIR/build.log"

          # =======================================================
          # ğŸ”¥ å¼·åŒ–ï¼šæ”¶é›† iptables ç›¸é—œç”¢ç‰© (æ™ºæ…§é©—è­‰ç‰ˆ)
          # =======================================================
          IPT_SRC_DIR="padavan-ng/trunk/user/iptables/iptables-1.8.11"
          IPT_BASE_DIR="padavan-ng/trunk/user/iptables"
          DEBUG_DIR="$PACK_DIR/debug_iptables"
          
          mkdir -p "$DEBUG_DIR"
          
          # 2.1 æ”¶é›† Patch æª”æ¡ˆ
          if [ -d "$IPT_BASE_DIR/patches_archive" ]; then
              cp "$IPT_BASE_DIR/patches_archive"/*.patch "$DEBUG_DIR/"
              echo "- ğŸ›¡ï¸ **Patches**: All patches collected in debug_iptables" >> "$REPORT_FILE"
          else
              echo "âš ï¸ Warning: patches directory not found in $IPT_BASE_DIR"
              echo "- âš ï¸ **Patches**: Not found (Collection failed)" >> "$REPORT_FILE"
          fi
          
          # 2.2 æ”¶é›† Patch éç¨‹æ—¥èªŒ (éå¸¸é‡è¦!)
          if [ -f "$IPT_BASE_DIR/patch_summary.log" ]; then
              cp "$IPT_BASE_DIR/patch_summary.log" "$DEBUG_DIR/patch_summary.log"
              echo "- ğŸ“œ **Patch Log**: Included" >> "$REPORT_FILE"
          fi

          # 2.3 æ™ºæ…§è¤‡è£½ xtables.c (æ ¹æ“šå…§å®¹æ±ºå®šæª”å)
          TARGET_FILE="$IPT_SRC_DIR/libxtables/xtables.c"
          
          if [ -f "$TARGET_FILE" ]; then
              # æª¢æŸ¥æ˜¯å¦å«æœ‰æˆ‘å€‘ Patch #100 çš„ç‰¹å¾µç¢¼ (å±è”½è­¦å‘Šçš„ if 0)
              if grep -q "#if 0" "$TARGET_FILE" && grep -q "Warning: Extension %s is not supported" "$TARGET_FILE"; then
                  # åˆ¤å®šç‚ºå·² Patch
                  cp "$TARGET_FILE" "$DEBUG_DIR/xtables_patched.c"
                  echo "âœ… Detected PATCHED xtables.c - Saving as xtables_patched.c"
                  echo "- ğŸ“„ **Source**: \`xtables_patched.c\` (âœ… Patched successfully)" >> "$REPORT_FILE"
              else
                  # åˆ¤å®šç‚ºæœª Patch (åŸç‰ˆæˆ– Patch å¤±æ•—)
                  cp "$TARGET_FILE" "$DEBUG_DIR/xtables_original.c"
                  echo "â„¹ï¸ Detected UNPATCHED xtables.c - Saving as xtables_original.c"
                  echo "- ğŸ“„ **Source**: \`xtables_original.c\` (âš ï¸ Original/Unpatched)" >> "$REPORT_FILE"
              fi
          else
               echo "âš ï¸ Warning: xtables.c not found (Maybe build failed or path differs)"
               echo "- âŒ **Source**: xtables.c not found!" >> "$REPORT_FILE"
          fi
          
          # 2.4 é¡å¤–æ”¶é›† config.log (é€™å°ç·¨è­¯å¤±æ•—é™¤éŒ¯éå¸¸æœ‰ç”¨)
          if [ -f "$IPT_SRC_DIR/config.log" ]; then
              cp "$IPT_SRC_DIR/config.log" "$DEBUG_DIR/config.log"
              echo "- ğŸ”§ **Log**: \`config.log\` included" >> "$REPORT_FILE"
          fi
          # =======================================================

          # 3. æŠ“å–éŸŒé«”ç”¢ç‰©ä¸¦ç«‹å³æª¢æŸ¥å¤§å°
          if [ -d "$IMAGES_DIR" ]; then
            echo "Scanning $IMAGES_DIR for images..."
            
            # è®€å–åˆ†å€ä¸Šé™
            if [ -f "$PARTITIONS_FILE" ]; then
              MAX_FW_SIZE="$(awk '/Firmware/ { getline; getline; sub(",", ""); print strtonum($2); }' "$PARTITIONS_FILE")"
              echo "Max Firmware Size Allowed: $MAX_FW_SIZE bytes"
            else
              MAX_FW_SIZE=0
              echo "::warning:: Partition config not found, skipping size check."
            fi

            # å°‹æ‰¾æ‰€æœ‰ç”¢ç‰©
            find "$IMAGES_DIR" -maxdepth 1 -type f \( -name "*.trx" -o -name "*.bin" \) | while read -r file; do
              fname=$(basename "$file")
              fsize=$(stat -c %s "$file")
              
              cp -v "$file" "$PACK_DIR/"
              
              if (( fsize < 500000 )); then
                echo "- ğŸ“¦ **U-Boot**: \`$fname\` ($(numfmt --to=iec $fsize))" >> "$REPORT_FILE"
              else
                echo "- ğŸ’¿ **Firmware**: \`$fname\` ($(numfmt --to=iec $fsize))" >> "$REPORT_FILE"
                
                if (( MAX_FW_SIZE > 0 )); then
                  if (( fsize > MAX_FW_SIZE )); then
                    echo "::error:: Firmware $fname ($fsize bytes) exceeds max size ($MAX_FW_SIZE bytes)!"
                    exit 1
                  else
                    echo "::notice:: $fname size check passed ($fsize / $MAX_FW_SIZE)"
                  fi
                fi
              fi
            done
          else
            echo "::warning:: Images directory not found. Build might have failed completely."
            echo "- âŒ **Error**: No images directory found." >> "$REPORT_FILE"
          fi

          # 4. ç”Ÿæˆ MD5 (ä¿®å¾©ï¼šåªå°æª”æ¡ˆç”Ÿæˆï¼Œé¿é–‹è³‡æ–™å¤¾)
          cd "$PACK_DIR"
          for f in *; do
            if [ -f "$f" ]; then
              md5sum "$f" >> md5sum.txt
            fi
          done
          
          # è®€å–å ±å‘Šä¾› Release ä½¿ç”¨
          FILE_REPORT_CONTENT=$(cat file_report.txt)
          {
            echo "FILE_REPORT<<EOF"
            echo "$FILE_REPORT_CONTENT"
            echo "EOF"
          } >> $GITHUB_ENV
          
          # æ‰¾å‡ºæœ€å¤§çš„éŸŒé«”æª”æ¡ˆ (æ’é™¤ uboot) 
          MAIN_FW=$(find . -type f \( -name "*.trx" -o -name "*.bin" \) -printf "%s\t%p\n" | sort -n | tail -1 | cut -f2)
          [ ! -z "$MAIN_FW" ] && echo "MAIN_FW_PATH=$PACK_DIR/${MAIN_FW#./}" >> $GITHUB_ENV
          
          cd "$WORK_DIR"

          # 5. æ‰“åŒ… Zip
          if [ "$(ls -A $PACK_DIR)" ]; then
            ZIP_NAME="padavan_pack_${CONFIG_VENDOR}_${CONFIG_FIRMWARE_PRODUCT_ID}.zip"
            zip -j -r "$ZIP_NAME" "$PACK_DIR"
            echo "ZIP_FILE_PATH=$WORK_DIR/$ZIP_NAME" >> $GITHUB_ENV
          else
            echo "::error:: output_pack is empty!"
            exit 1
          fi
          
          echo "BUILD_TIMESTAMP=$(TZ='Asia/Taipei' date '+%Y.%m.%d_%H.%M.%S')" >> $GITHUB_ENV
          echo "CONFIG_VENDOR=$CONFIG_VENDOR" >> $GITHUB_ENV
          echo "CONFIG_FIRMWARE_PRODUCT_ID=$CONFIG_FIRMWARE_PRODUCT_ID" >> $GITHUB_ENV
          echo "::endgroup::"

      - name: Upload artifacts (ZIP)
        uses: actions/upload-artifact@v4
        with:
          name: padavan_${{ env.CONFIG_VENDOR }}_${{ env.CONFIG_FIRMWARE_PRODUCT_ID }}_${{ env.BUILD_TIMESTAMP }}
          path: ${{ env.ZIP_FILE_PATH }}

      # 10. ç™¼å¸ƒ Release
      - name: Set Release Tag
        if: github.event_name == 'workflow_dispatch'
        run: |
          echo "TAG_NAME=${{ inputs.target_select }}-${{ env.BUILD_TIMESTAMP }}" >> $GITHUB_ENV

      - name: Publish Release
        if: github.event_name == 'workflow_dispatch'
        uses: ncipollo/release-action@v1
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit: ${{ github.sha }}
          tag: ${{ env.TAG_NAME }}
          name: ${{ inputs.target_select }} [${{ env.BUILD_TIMESTAMP }}]
          body: |
            **Padavan ç·¨è­¯å ±å‘Š (Early Check)**
            * **æ©Ÿå‹**: ${{ inputs.target_select }}
            * **æ™‚é–“**: ${{ env.BUILD_TIME }} (Taipei Time)
            * **User**: ${{ env.SIGNACCOUNT }} / **Pass**: ${{ env.SIGNPASSWORD }}
            * **WiFi**: ${{ env.WIFI2GSSID }} / ${{ env.WIFI5GSSID }}
            
            ### ğŸ“¦ ç”¢ç‰©åµæ¸¬
            ${{ env.FILE_REPORT }}
            
            ### ğŸ›  Debug æª”æ¡ˆ (å·²åŒ…å«åœ¨ Zip)
            * `defaults.h.txt` (æª¢æŸ¥ IP/å¸³å¯† æ˜¯å¦ä¿®æ”¹æˆåŠŸ)
            * `CN.dict.txt` (æª¢æŸ¥èªè¨€æª”)
            * `build.log` (ç·¨è­¯æ—¥èªŒ)
            * `build.config` (ç·¨è­¯åƒæ•¸)
            * `kernel.config` (æ ¸å¿ƒåƒæ•¸)
          artifacts: ${{ env.ZIP_FILE_PATH }}
          allowUpdates: true
          artifactErrorsFailBuild: true
