name: Build firmware (Ultimate Fix - Early Size Check)

permissions:
  contents: write

on:
  workflow_dispatch:
    inputs:
      target_select:
        description: "ÈÅ∏ÊìáÊ©üÂûã (Target Model)"
        required: true
        default: 'TL_C2-V1'
        type: choice
        options:
          - TL_C2-V1
          - HC5661A
      
      nanoversion:
        description: "ÈñãÂïüÊ•µÈôêÁò¶Ë∫´ (Nano Optimization)"
        type: boolean
        default: true

      customization:
        description: 'Ëá™ÂÆöÁæ©ÈÖçÁΩÆ JSON (Wi-Fi/ÂØÜÁ¢º/IP)'
        required: true
        type: string
        default: '{"lanip":"192.168.0.1","signaccount":"admin","signpassword":"admin","wifi2gssid":"Padavan","wifi2gpsk":"1234567890","wifi5gssid":"Padavan-5G","wifi5gpsk":"1234567890"}'

  push:
    tags:
      - '*'

jobs:
  build:
    runs-on: ubuntu-latest
    container: registry.gitlab.com/hadzhioglu/padavan-ng
    defaults: { run: { shell: bash } }
    
    steps:
      - name: Checkout Workflow
        uses: actions/checkout@v4

      # 0. Áí∞Â¢ÉÂàùÊ™¢
      - name: Debug - Initial Environment Check
        run: |
          echo "::group::System Info"
          echo "User: $(whoami)"
          echo "PWD: $(pwd)"
          df -h
          echo "::endgroup::"

      # 1. ÂÆâË£ù‰æùË≥¥
      - name: Install Dependencies & Fix Timezone
        run: |
          echo "::group::Apt Update & Install"
          set -x 
          apt-get update
          DEBIAN_FRONTEND=noninteractive apt-get install -y tzdata autoconf autoconf-archive automake autopoint bison build-essential \
          ca-certificates cmake cpio curl dos2unix doxygen fakeroot flex gawk gettext git gperf \
          help2man htop kmod libarchive-tools libblkid-dev libc-ares-dev libcurl4-openssl-dev \
          libdevmapper-dev libev-dev libevent-dev libexif-dev libflac-dev libgmp3-dev \
          libid3tag0-dev libidn2-dev libjpeg-dev libkeyutils-dev libltdl-dev libmpc-dev \
          libmpfr-dev libncurses5-dev libogg-dev libsqlite3-dev libssl-dev libsystemd-dev \
          libtool libtool-bin libudev-dev libunbound-dev libvorbis-dev libxml2-dev locales \
          mc nano pkg-config ppp-dev python3 python3-docutils sshpass texinfo unzip uuid \
          uuid-dev vim wget xxd zlib1g-dev jq zip
          set +x
          echo "::endgroup::"

          echo "::group::Timezone Configuration"
          ln -fs /usr/share/zoneinfo/Asia/Taipei /etc/localtime
          dpkg-reconfigure -f noninteractive tzdata
          echo "BUILD_TIME=$(date +%Y%m%d-%H%M)" >> $GITHUB_ENV
          echo "::endgroup::"

      # 2. Ë®≠ÂÆöËÆäÊï∏
      - name: Get variables
        run: |
          echo "::group::Variable Loading"
          if [ -f "variables" ]; then
            sed -i 's|\r$||g' variables
            . variables
          fi
          
          echo "PADAVAN_REPO=https://github.com/TWShiyuLiou1997/padavan-ng" >> $GITHUB_ENV
          echo "PADAVAN_BRANCH=master" >> $GITHUB_ENV
          echo "PADAVAN_COMMIT=HEAD" >> $GITHUB_ENV
          
          if [ -z "$PADAVAN_THEMES_REPO" ]; then
            echo "PADAVAN_THEMES_REPO=https://gitlab.com/hadzhioglu/padavan-themes.git" >> $GITHUB_ENV
            echo "PADAVAN_THEMES_BRANCH=main" >> $GITHUB_ENV
          fi
          
          for v in "${!PADAVAN_@}" "${!CONFIG_@}"; do
            echo "$v=${!v}" >> $GITHUB_ENV
          done
          echo "::endgroup::"

      # 3. ‰∏ãËºâÊ∫êÁ¢º
      - name: Download sources and toolchain
        run: |
          echo "::group::Git Clone"
          git config --global --add safe.directory '*'
          git clone -b "$PADAVAN_BRANCH" "$PADAVAN_REPO"
          if [ "$PADAVAN_COMMIT" != "HEAD" ] && [ ! -z "$PADAVAN_COMMIT" ]; then
            git -C padavan-ng checkout "$PADAVAN_COMMIT"
          fi
          wget -qO- "$PADAVAN_TOOLCHAIN_URL" | tar -C padavan-ng --zstd -xf -
          echo "::endgroup::"

      # 4. ÁîüÊàê Config
      - name: Generate build.config & Apply Nano
        run: |
          TNAME="${{ inputs.target_select }}"
          [ -z "$TNAME" ] && TNAME="TL_C2-V1"
          echo "::group::Template Search & Config Gen"
          
          TEMPLATE_DIR="padavan-ng/trunk/configs/templates"
          PATTERN_A=$(echo "$TNAME" | sed 's/-/_/g')
          PATTERN_B=$(echo "$TNAME")
          TARGET_FILE=$(find "$TEMPLATE_DIR" -maxdepth 2 \( -iname "${PATTERN_A}.config" -o -iname "${PATTERN_B}.config" \) | head -n 1)
          
          if [ -z "$TARGET_FILE" ]; then
            echo "::warning:: Template not found, using fallback..."
            TARGET_FILE="padavan-ng/trunk/configs/templates/tplink/tl_c2-v1.config"
          fi
          
          if [ ! -f "$TARGET_FILE" ]; then
            echo "::error:: Config file not found: $TARGET_FILE"
            exit 1
          fi
          cp -f "$TARGET_FILE" build.config
          FINAL_CONFIG="build.config"
          echo "::endgroup::"
          
          # === Ê•µÈôêÁò¶Ë∫´ÈÇèËºØ (Ultimate Nano - TC/Cake Ready) ===
          if [ "${{ inputs.nanoversion }}" == "true" ]; then
            echo "::group::Nano Optimization - Final Execution"
         
            # 1. [È´îÁ©çÂÑ™Âåñ] Âº∑Âà∂ÈñãÂïü Size Optimization
            sed -i "s/#CONFIG_CC_OPTIMIZE_FOR_SIZE=y/CONFIG_CC_OPTIMIZE_FOR_SIZE=y/g" "$FINAL_CONFIG"
         
            # 2. [Âü∫Á§éÂàáÈô§] ÂÅúÁî® USB, Ê™îÊ°àÁ≥ªÁµ±, Swap, Â™íÈ´îÈ©ÖÂãï
            for feat in USB ANTFS FAT EXFAT EXT2 EXT3 EXT4 XFS HFS FUSE SWAP BACKPORTED; do
              sed -i "s/CONFIG_FIRMWARE_ENABLE_${feat}=y/CONFIG_FIRMWARE_ENABLE_${feat}=n/gi" "$FINAL_CONFIG"
            done
         
            # 3. [Ë™ûË®ÄÂåÖÁ≤æÊ∫ñÊéßÂà∂] 
            sed -i "s/CONFIG_FIRMWARE_INCLUDE_LANG_EN=n/CONFIG_FIRMWARE_INCLUDE_LANG_EN=y/g" "$FINAL_CONFIG"
            sed -i "s/#CONFIG_FIRMWARE_INCLUDE_LANG_CN=y/CONFIG_FIRMWARE_INCLUDE_LANG_CN=y/g" "$FINAL_CONFIG"
            sed -i "s/CONFIG_FIRMWARE_INCLUDE_LANG_CN=n/CONFIG_FIRMWARE_INCLUDE_LANG_CN=y/g" "$FINAL_CONFIG"
            sed -i "s/CONFIG_FIRMWARE_INCLUDE_LANG_RU=y/CONFIG_FIRMWARE_INCLUDE_LANG_RU=n/g" "$FINAL_CONFIG"
            sed -i "s/CONFIG_FIRMWARE_INCLUDE_LANG_UK=y/CONFIG_FIRMWARE_INCLUDE_LANG_UK=n/g" "$FINAL_CONFIG"
         
            # 4. [Âú∞ÊØØÂºèÁßªÈô§ - Á©∂Ê•µÈò≤ÊºèÁâà]
            # ÁõÆÊ®ôÔºö‰∏çÁÆ°Ë©≤ÈÅ∏È†ÖÂéüÊú¨ÊòØ =y, =m, ÈÇÑÊòØ # is not setÔºåÈÄöÈÄöÂº∑Âà∂ÊîπÁÇ∫ =n
            echo "::group::Absolute Disable Modules"
            modules=(
              CIFS NTFS_3G LPRD U2EC USBIP HDPARM PARTED SMBD WINS SMBD_SYSLOG TESTPARM 
              FTPD FTPD_SSL NFSD NFSC
              UVC HID SERIAL AUDIO FIREFLY XUPNPD MINIDLNA FFMPEG_NEW 
              RPL2TP EAP_PEAP OPENVPN SSWAN WIREGUARD AMNEZIAWG ZEROTIER EOIP XFRM
              SHADOWSOCKS XRAY V2RAY TROJAN SSOBFS SINGBOX NAIVEPROXY
              REDSOCKS SRELAY MENTOHUST FRPC FRPS TOR TOR_GEOIP TOR_GEOIPV6
              PRIVOXY NFQWS
              IPSET DNSCRYPT STUBBY DOH QUIC QUIC_NGTCP2 NDISC6_RDISC6
              ADBYBY DNSFORWARDER SMARTDNS ADGUARDHOME WPAD
              LRZSZ IPERF3 DUMP1090 RTL_SDR SOCAT MTR 
              IMQ IFB
              ZRAM ADB LUA SQM ALDRIVER SCUTCLIENT GDUT_DRCOM DOGCOM MINIEAP 
              NJIT_CLIENT SOFTETHERVPN_SERVER SOFTETHERVPN_CLIENT SOFTETHERVPN_CMD
              DROPBEAR DROPBEAR_FAST_CODE VLMCSD TTYD MSD_LITE
              DDNS_SSL
            )
         
            for mod in "${modules[@]}"; do
              CFG_KEY="CONFIG_FIRMWARE_INCLUDE_${mod}"
              
              if grep -q "$CFG_KEY" "$FINAL_CONFIG"; then
                # Â¶ÇÊûúÊâæÂà∞Ë©≤Ë®≠ÂÆö (‰∏çË´ñÊòØÈñãÂïü„ÄÅÈóúÈñâÊàñË®ªËß£)ÔºåÊï¥Ë°åÂº∑Âà∂ÊõøÊèõÁÇ∫ =n
                sed -i "s|^.*$CFG_KEY.*$|$CFG_KEY=n|" "$FINAL_CONFIG"
                echo "   üö´ Forced Disabled: $mod (Overwritten)"
              else
                # Â¶ÇÊûúÂÆåÂÖ®Ê≤íÊâæÂà∞ÔºåÂâá‰∏ªÂãïËøΩÂä† =n (Èò≤Ê≠¢ÈªòË™çÈñãÂïü)
                echo "$CFG_KEY=n" >> "$FINAL_CONFIG"
                echo "   üö´ Forced Disabled: $mod (Added)"
              fi
            done
            
            echo "::endgroup::"
          fi

          echo "::group::Core Modules Enforcement"
          # 5. Âº∑Âà∂‰øùÁïô‰∏¶ÈñãÂïüÁöÑÊ†∏ÂøÉÊ®°ÁµÑ
          keep_modules=(OPENSSH SFTP TCPDUMP CURL HTTPS OPENSSL_EC OPENSSL_EXE SHORTCUT_FE QOS)

          for kmod in "${keep_modules[@]}"; do
            sed -i "/CONFIG_FIRMWARE_INCLUDE_${kmod}/d" "$FINAL_CONFIG"
            echo "CONFIG_FIRMWARE_INCLUDE_${kmod}=y" >> "$FINAL_CONFIG"
          done
          echo "::endgroup::"

      # 5. ÊáâÁî®Ëá™ÂÆöÁæ©Ë®≠ÂÆö (JSON)
      - name: Apply Custom Settings
        run: |
          echo "::group::JSON Parsing"
          echo '${{ inputs.customization }}' | jq -r 'to_entries[] | "\(.key)=\(.value)"' | while IFS='=' read -r k v; do
            export "${k^^}=$v"
          done
          
          LANIP=$(echo '${{ inputs.customization }}' | jq -r .lanip)
          SIGNACCOUNT=$(echo '${{ inputs.customization }}' | jq -r .signaccount)
          SIGNPASSWORD=$(echo '${{ inputs.customization }}' | jq -r .signpassword)
          WIFI2GSSID=$(echo '${{ inputs.customization }}' | jq -r .wifi2gssid)
          WIFI2GPSK=$(echo '${{ inputs.customization }}' | jq -r .wifi2gpsk)
          WIFI5GSSID=$(echo '${{ inputs.customization }}' | jq -r .wifi5gssid)
          WIFI5GPSK=$(echo '${{ inputs.customization }}' | jq -r .wifi5gpsk)
          
          export LANIP SIGNACCOUNT SIGNPASSWORD WIFI2GSSID WIFI2GPSK WIFI5GSSID WIFI5GPSK
          
          if [ -d "padavan-ng/trunk/custom/scripts" ]; then
            cd padavan-ng
            chmod +x trunk/custom/scripts/*.sh
            [ ! -z "$LANIP" ] && bash trunk/custom/scripts/setip.sh "$LANIP" trunk/user/shared/defaults.h trunk/user/www/dict/CN.dict || true
            [ ! -z "$SIGNACCOUNT" ] && bash trunk/custom/scripts/setaccount.sh "$SIGNACCOUNT" "$SIGNPASSWORD" trunk/user/shared/defaults.h || true
            [ ! -z "$WIFI2GSSID" ] && bash trunk/custom/scripts/setwifi.sh "$WIFI2GSSID" "$WIFI2GPSK" "$WIFI5GSSID" "$WIFI5GPSK" trunk/user/shared/defaults.h || true
          fi
          echo "::endgroup::"

      # 6. ÂÆâË£ù Themes
      - name: Install themes
        run: |
          echo "::group::Themes Installation"
          if [ -f "variables" ]; then . variables; fi
          if [[ -n "${PADAVAN_THEMES[*]}" ]]; then
            git clone --depth 1 -b "$PADAVAN_THEMES_BRANCH" "$PADAVAN_THEMES_REPO" themes
            cp -r themes/common-theme themes/jquery.js padavan-ng/trunk/user/www/n56u_ribbon_fixed
            for theme in "${PADAVAN_THEMES[@]}"; do
              [ -d "themes/$theme-theme" ] && cp -r "themes/$theme-theme" padavan-ng/trunk/user/www/n56u_ribbon_fixed
            done
          fi
          echo "::endgroup::"

      # 7. ‰øÆÊ≠£ mkimage
      - name: Fix mkimage
        run: |
          MKIMAGE_FILE="padavan-ng/trunk/tools/mkimage/mkimage.c"
          if [ -f "$MKIMAGE_FILE" ]; then
            sed -i 's/"%d\.%d"/"%hhd.%hhd"/g' "$MKIMAGE_FILE"
            sed -i 's/"%d\.%d%c"/"%hhd.%hhd%c"/g' "$MKIMAGE_FILE"
          fi

      # =======================================================
      # 7.4. [Ê†∏ÂøÉÂçáÁ¥ö] BusyBox 1.37.0 V44: Integrated Masterpiece
      # =======================================================
      - name: üî• Sync & Evolve BusyBox (V44:Integrated)
        run: |
          set -x
          echo "::group::BusyBox Evolution V44"
          
          # 1. ÂÆöÁæ©ËÆäÊï∏ (Readonly Èò≤Ê≠¢ÁØ°Êîπ)
          # Ê≥®ÊÑèÔºöÂú®Ê≠§ Workflow ‰∏≠Ôºåpadavan-ng ÊòØÊ†πÁõÆÈåÑ‰∏ãÁöÑÂ≠êÁõÆÈåÑ
          readonly WORK_DIR="padavan-ng"
          readonly REPO_ROOT="$WORK_DIR"
          readonly ORIGINAL_CONFIG="$REPO_ROOT/trunk/configs/boards/busybox.config"
          readonly TARGET_DIR="$REPO_ROOT/trunk/user/busybox"
          
          # Á¢∫Ë™çÁõÆÈåÑÂ≠òÂú®
          if [ ! -d "$TARGET_DIR" ]; then
              echo "‚ùå CRITICAL: BusyBox directory not found at $TARGET_DIR"
              exit 1
          fi
          
          # ÈÄ≤ÂÖ• BusyBox ÁõÆÈåÑ (Áõ¥Êé•Êìç‰Ωú 1.37.0 ÁõÆÈåÑ)
          # Ê≥®ÊÑèÔºöÂÅáË®≠ trunk/user/busybox ‰∏ãÈù¢Áõ¥Êé•Â∞±ÊòØÊ∫êÁ¢ºÔºåÊàñËÄÖÊúâ‰∏ÄÂÄã busybox-1.37.0 Â≠êÁõÆÈåÑ
          # Ê†πÊìöÊÇ®ÁöÑÊèèËø∞ÔºåÊÇ®Â∑≤Á∂ìÊõøÊèõ‰∫ÜÊ∫êÁ¢ºÔºåÊâÄ‰ª•ÈÄôË£°ÊàëÂÄëÂÅö‰∏ÄÂÄãÊô∫ÊÖßÂà§Êñ∑
          cd "$TARGET_DIR"
          if [ -d "busybox-1.37.0" ]; then
              cd "busybox-1.37.0"
          fi
          
          # ÂÆöÁæ©ÂêåÊ≠•ÁõÆÊ®ô (ÁèæÂú®ÊàëÂÄë‰ΩçÊñº busybox Ê∫êÁ¢ºÊ†πÁõÆÈåÑ)
          readonly SYNC_TARGET_1=".config"
          readonly SYNC_TARGET_2="../.config"
          # Ë®àÁÆóÂõû original config ÁöÑÁõ∏Â∞çË∑ØÂæë (Âæû busybox-1.37.0 Âá∫Áôº: ../../../configs/...)
          # ÊàñËÄÖÁõ¥Êé•Áî®ÁµïÂ∞çË∑ØÂæë (‰ΩÜÂú® Action ‰∏≠Áî®Áõ∏Â∞çË∑ØÂæëÊØîËºÉÈùàÊ¥ª)
          # ÈÄôË£°ÊàëÂÄëÁî®‰πãÂâçÂÆöÁæ©ÁöÑ ORIGINAL_CONFIG ËÆäÊï∏ (ÈúÄË¶ÅËΩâÁÇ∫Áõ∏Â∞çË∑ØÂæëÊàñÁõ¥Êé•ÂØ´ÂÖ•)
          # Á∞°ÂñÆËµ∑Ë¶ãÔºåÊàëÂÄëÁî® readlink Áç≤ÂèñÁµïÂ∞çË∑ØÂæëÔºåÊàñËÄÖÂÅáË®≠ÁµêÊßãÂõ∫ÂÆö
          readonly SYNC_TARGET_3="../../../configs/boards/busybox.config"

          # -------------------------------------------------------
          # 2. ÂÆöÁæ©ÂÖ®Â•óÊ™¢Êü•Ê∏ÖÂñÆ (MIPS Router Optimized / Diff Mode)
          # -------------------------------------------------------
          CHECKS_SET=(
              # Shells
              "CONFIG_SH_IS_ASH y"
              "CONFIG_BASH_IS_ASH y"
              "CONFIG_ASH y"
              "CONFIG_ASH_OPTIMIZE_FOR_SIZE y"
              "CONFIG_ASH_INTERNAL_GLOB y"
              "CONFIG_ASH_BASH_COMPAT y"
              "CONFIG_ASH_JOB_CONTROL y"
              "CONFIG_ASH_ALIAS y"
              "CONFIG_ASH_EXPAND_PRMT y"
              "CONFIG_ASH_GETOPTS y"
              "CONFIG_ASH_CMDCMD y"
              "CONFIG_ASH_HELP y"
              "CONFIG_ASH_RANDOM_SUPPORT y"
              "CONFIG_ASH_IDLE_TIMEOUT y"
              "CONFIG_ASH_MAIL y"
              "CONFIG_FEATURE_SH_MATH_BASE y"
              "CONFIG_FEATURE_SH_EMBEDDED_SCRIPTS y"
              
              # Logging
              "CONFIG_SYSLOGD y"
              "CONFIG_FEATURE_ROTATE_LOGFILE y"
              "CONFIG_FEATURE_REMOTE_LOG y"
              "CONFIG_FEATURE_SYSLOGD_DUP y"
              "CONFIG_FEATURE_SYSLOGD_PRECISE_TIMESTAMPS y"
              "CONFIG_FEATURE_SYSLOGD_READ_BUFFER_SIZE 512"
              "CONFIG_FEATURE_IPC_SYSLOG y"
              "CONFIG_FEATURE_IPC_SYSLOG_BUFFER_SIZE 4"
              "CONFIG_KLOGD y"
              "CONFIG_FEATURE_KLOGD_KLOGCTL y"
              "CONFIG_LOGGER y"
              
              # Network & DHCP
              "CONFIG_UDHCPC_DEFAULT_INTERFACE \"eth3\""
              "CONFIG_FEATURE_IP_ROUTE_DIR \"\""
              "CONFIG_SHA1_SMALL 1"
              "CONFIG_DHCP6C y"
              "CONFIG_FEATURE_UDHCPC_SANITIZEOPT y"
              "CONFIG_FEATURE_UDHCP_RFC3397 y"
              "CONFIG_FEATURE_UDHCP_RFC5969 y"
              # [ÁßªÈô§] ÁßªËá≥ UNSET ‰ª•ÈÅøÂÖçË°ùÁ™Å/iproute2-5.12.0/ip
              # "CONFIG_IPNEIGH y"
              # "CONFIG_FEATURE_IP_NEIGH y"
              "CONFIG_NC y"
              "CONFIG_NC_SERVER y"
              "CONFIG_NC_EXTRA y"
              "CONFIG_FEATURE_NSLOOKUP_BIG y"
              "CONFIG_FEATURE_NSLOOKUP_LONG_OPTIONS y"
              "CONFIG_FEATURE_NTP_AUTH y"
              "CONFIG_SSL_CLIENT y"
              # [ÁßªÈô§] ÁßªËá≥ UNSET ‰ª•ÈÅøÂÖçË°ùÁ™Å/iproute2-5.12.0/tc
              # "CONFIG_TC y"
              # "CONFIG_FEATURE_TC_INGRESS y"
              "CONFIG_TLS y"
              "CONFIG_SVC y"
              "CONFIG_SVOK y"
              
              # WGET
              "CONFIG_WGET y"
              "CONFIG_FEATURE_WGET_LONG_OPTIONS y"
              "CONFIG_FEATURE_WGET_STATUSBAR y"
              "CONFIG_FEATURE_WGET_AUTHENTICATION y"
              "CONFIG_FEATURE_WGET_TIMEOUT y"
              "CONFIG_FEATURE_WGET_HTTPS y"
              "CONFIG_FEATURE_WGET_OPENSSL y"
              
              # Loop & Core
              "CONFIG_NO_LOOP_CONFIGURE y"
              # [ÁßªÈô§] MIPS Êû∂Êßã‰∏çÊîØÊè¥ x86 ÂÑ™Âåñ
              # "CONFIG_STACK_OPTIMIZATION_386 y"
              "CONFIG_BZIP2_SMALL 9"
              "CONFIG_CRC32 y"
              "CONFIG_FEATURE_CP_REFLINK y"
              # [ÁßªÈô§] Âõ†Êï∏ÂàÜËß£ÔºåË∑ØÁî±Âô®Áî®‰∏çÂà∞
              # "CONFIG_FACTOR y"
              "CONFIG_LINK y"
              "CONFIG_SHA256SUM y"
              "CONFIG_NL y"
              "CONFIG_NOHUP y"
              "CONFIG_NPROC y"
              "CONFIG_PASTE y"
              "CONFIG_SHRED y"
              "CONFIG_TEST1 y"
              "CONFIG_TEST2 y"
              "CONFIG_TSORT y"
              "CONFIG_BB_ARCH y"
              "CONFIG_BASE32 y"
              "CONFIG_BASE64 y"
              # [ÁßªÈô§] Ë∑ØÁî±Âô®‰∏çÊîØÊè¥‰ºëÁú†ÂñöÈÜí
              # "CONFIG_RESUME y"
              "CONFIG_RUN_INIT y"
              "CONFIG_FEATURE_XARGS_SUPPORT_PARALLEL y"
              "CONFIG_FEATURE_XARGS_SUPPORT_ARGS_FILE y"
              "CONFIG_POWEROFF y"
              "CONFIG_REBOOT y"
              "CONFIG_FEATURE_WAIT_FOR_INIT y"
              "CONFIG_LINUXRC y"
              "CONFIG_FEATURE_INIT_QUIET y"
              "CONFIG_FEATURE_INIT_MODIFY_CMDLINE y"
              "CONFIG_MKPASSWD y"
              "CONFIG_MODINFO y"
              # [ÁßªÈô§] Flash ‰∏çÊîØÊè¥ TRIM
              # "CONFIG_BLKDISCARD y"
              # [ÁßªÈô§] Ë∑ØÁî±Âô®Ê™îÊ°àÁ≥ªÁµ±ÈÄöÂ∏∏‰∏çÈúÄÈ†êÂàÜÈÖç
              # "CONFIG_FALLOCATE y"
              # "CONFIG_FSFREEZE y"
              "CONFIG_GETOPT y"
              "CONFIG_FEATURE_GETOPT_LONG y"
              "CONFIG_HEXDUMP y"
              "CONFIG_XXD y"
              "CONFIG_FEATURE_MDEV_DAEMON y"
              "CONFIG_MKE2FS y"
              "CONFIG_MKDOSFS y"
              # [ÁßªÈô§] Êû∂ÊßãÈåØË™§ÔºåMIPS ‰∏çÈúÄË¶ÅÈÄô‰∫õ
              # "CONFIG_LINUX32 y"
              # "CONFIG_LINUX64 y"
              # [ÁßªÈô§] ÂÆπÂô®Áõ∏ÈóúÔºåMIPS ÊïàËÉΩÂ∑Æ‰∏îÂ∞ëÁî®
              # "CONFIG_SETPRIV y"
              # "CONFIG_FEATURE_SETPRIV_DUMP y"
              # "CONFIG_FEATURE_SETPRIV_CAPABILITIES y"
              # "CONFIG_FEATURE_SETPRIV_CAPABILITY_NAMES y"
              # "CONFIG_UNSHARE y"
              "CONFIG_BC y"
              "CONFIG_FEATURE_DC_BIG y"
              "CONFIG_FEATURE_BC_INTERACTIVE y"
              "CONFIG_FEATURE_BC_LONG_OPTIONS y"
              "CONFIG_FEATURE_CROND_SPECIAL_TIMES y"
              "CONFIG_GETFATTR y"
              "CONFIG_HEXEDIT y"
              # [ÁßªÈô§] ÁÑ° I2C Á°¨È´îÊîØÊè¥
              # "CONFIG_I2CTRANSFER y"
              "CONFIG_LSSCSI y"
              "CONFIG_MIM y"
              "CONFIG_PARTPROBE y"
              "CONFIG_SEEDRNG y"
              "CONFIG_SETFATTR y"
              "CONFIG_TS y"
              "CONFIG_UBIRENAME y"
              
              # User Preferences
              "CONFIG_FEATURE_TAR_LONG_OPTIONS y"
              "CONFIG_FEATURE_SORT_OPTIMIZE_MEMORY y"
              "CONFIG_FEATURE_SHOW_SCRIPT y"
              "CONFIG_FLOAT_DURATION y"
              "CONFIG_NOLOGIN y"
              # [ÁßªÈô§] ÂÉÖ‰æõÈô§ÈåØÔºåÊ•µÂ∞ë‰ΩøÁî®
              # "CONFIG_NSENTER y"
              "CONFIG_FEATURE_START_STOP_DAEMON_LONG_OPTIONS y"
              "CONFIG_FEATURE_SWAPON_PRI y"
              "CONFIG_FEATURE_ETC_SERVICES y"
              "CONFIG_FEATURE_CATN y"
              "CONFIG_FEATURE_CATV y"
              
              # Volume IDs
              # [ÁßªÈô§] Ë∑ØÁî±Âô®Ê•µÂ∞ëÁî®Âà∞ÈÄô‰∫õÊ™îÊ°àÁ≥ªÁµ±ÔºåÁØÄÁúÅÁ©∫Èñì
              # "CONFIG_FEATURE_VOLUMEID_BCACHE y"
              # "CONFIG_FEATURE_VOLUMEID_EROFS y"
              # "CONFIG_FEATURE_VOLUMEID_MINIX y"
              "CONFIG_FEATURE_VOLUMEID_UBIFS y"
              "CONFIG_FEATURE_VOLUMEID_XFS y"
          )
          
          CHECKS_UNSET=(
              "CONFIG_SH_IS_HUSH"
              "CONFIG_BASH_IS_HUSH"
              "CONFIG_BASH_IS_NONE"
              "CONFIG_HUSH"
              "CONFIG_FEATURE_DHCP6_AUTH"
              "CONFIG_TRY_LOOP_CONFIGURE"
              "CONFIG_LOOP_CONFIGURE"
              "CONFIG_FEATURE_WGET_FTP"
              "CONFIG_WHOIS"
              "CONFIG_UDHCPD"
              "CONFIG_FEATURE_UDHCPD_BOOTP"
              "CONFIG_FEATURE_UDHCPD_BASE_IP_ON_MAC"
              "CONFIG_FEATURE_UDHCPD_WRITE_LEASES_EARLY"
              "CONFIG_DUMPLEASES"
              "CONFIG_DHCPRELAY"
              "CONFIG_UDHCPC6"
              "CONFIG_FEATURE_UDHCPC6_RFC3646"
              "CONFIG_FEATURE_UDHCPC6_RFC4704"
              "CONFIG_FEATURE_UDHCPC6_RFC4833"
              "CONFIG_FEATURE_UDHCPC6_RFC5970"
              "CONFIG_FEATURE_UDHCP_PORT"
              "CONFIG_FEATURE_UDHCP_8021Q"
              "CONFIG_ASH_BASH_SOURCE_CURDIR"
              
              # --- [Êñ∞Â¢û] ÈÅøÂÖçË°ùÁ™Å/iproute2-5.12.0/ip & /iproute2-5.12.0/tc & Âº∑ÂåñË≥áÂÆâ (Âº∑Âà∂ÈóúÈñâ) ---
              
              # IP ‰∏ªÁ®ãÂºèËàáÂäüËÉΩ (ÂÖ®ÊÆ∫ÔºåÂõ†ÁÇ∫Êúâ iproute2)
              "CONFIG_IP"
              "CONFIG_IPADDR"
              "CONFIG_IPLINK"
              "CONFIG_IPROUTE"
              "CONFIG_IPTUNNEL"
              "CONFIG_IPRULE"
              "CONFIG_IPNEIGH"
              
              # IP Ë©≥Á¥∞ÂäüËÉΩË®≠ÂÆö (ÂÖ®ÊÆ∫)
              "CONFIG_FEATURE_IP_ADDRESS"
              "CONFIG_FEATURE_IP_LINK"
              
              # [üíÄ Â∞éËá¥Á∑®Ë≠ØÂ§±Êïó Error 1 ÁöÑÂÖáÊâã]
              "CONFIG_FEATURE_IP_LINK_CAN"
              
              # IP ÂÖ∂‰ªñÂäüËÉΩËàáÂçîÂÆö
              "CONFIG_FEATURE_IP_ROUTE"
              "CONFIG_FEATURE_IP_TUNNEL"
              "CONFIG_FEATURE_IP_RULE"
              "CONFIG_FEATURE_IP_NEIGH"
              "CONFIG_FEATURE_IP_RARE_PROTOCOLS"
              
              # TC ÊµÅÈáèÊéßÂà∂ (ÂÖ®ÊÆ∫ÔºåÂõ†ÁÇ∫Êúâ iproute2)
              "CONFIG_TC"
              "CONFIG_FEATURE_TC_INGRESS"
              
              # ËàäÂºèÊúçÂãôËàáË≥áÂÆâÈ¢®Èö™ (Âª∫Ë≠∞ÈóúÈñâ)
              "CONFIG_TCPSVD"
              "CONFIG_UDPSVD"
              
              # --- [Êñ∞Â¢û] Êû∂ÊßãËàáÂûÉÂúæÊ∏ÖÁêÜ (Âº∑Âà∂ÈóúÈñâ) ---
              "CONFIG_STACK_OPTIMIZATION_386"
              "CONFIG_RESUME"
              "CONFIG_BLKDISCARD"
              "CONFIG_LINUX32"
              "CONFIG_LINUX64"
              "CONFIG_SETPRIV"
              "CONFIG_UNSHARE"
              "CONFIG_NSENTER"
              "CONFIG_I2CTRANSFER"
              "CONFIG_FALLOCATE"
              "CONFIG_FSFREEZE"
              "CONFIG_FEATURE_VOLUMEID_BCACHE"
              "CONFIG_FEATURE_VOLUMEID_EROFS"
              "CONFIG_FEATURE_VOLUMEID_MINIX"
          )

          # -------------------------------------------------------
          # 3. Ê†∏ÂøÉÂäüËÉΩÂáΩÂºè
          # -------------------------------------------------------
          audit_config() {
              local FILE=$1
              local LIST_NAME=$2 
              local FAILURES=()
              echo "   üîç Auditing $FILE..."
              if [ ! -f "$FILE" ]; then echo "      ‚ùå File missing: $FILE"; return 1; fi
              
              for ENTRY in "${CHECKS_SET[@]}"; do
                  KEY=${ENTRY%% *}
                  VAL=${ENTRY#* }
                  if ! grep -q "^${KEY}=${VAL}$" "$FILE"; then
                      echo "      ‚ùå [FAIL] $KEY mismatch/missing"
                      FAILURES+=("$ENTRY")
                  fi
              done
              
              for KEY in "${CHECKS_UNSET[@]}"; do
                  if grep -q "^${KEY}=" "$FILE"; then
                      echo "      ‚ùå [FAIL] $KEY is SET (Should be UNSET)"
                      FAILURES+=("$KEY UNSET")
                  fi
              done
              
              if [ ${#FAILURES[@]} -gt 0 ]; then
                  eval "$LIST_NAME=(\"\${FAILURES[@]}\")"
                  return 1
              fi
              return 0
          }

          apply_fixes() {
              local FILE=$1
              local ITEMS=("${@:2}")
              echo "   üõ†Ô∏è Applying Fixes to $FILE..."
              for ITEM in "${ITEMS[@]}"; do
                  if [[ "$ITEM" == *" UNSET" ]]; then
                      KEY=${ITEM% UNSET}
                      sed -i "/$KEY/d" "$FILE"
                      echo "# $KEY is not set" >> "$FILE"
                  else
                      KEY=${ITEM%% *}
                      VAL=${ITEM#* }
                      sed -i "/$KEY/d" "$FILE"
                      echo "$KEY=$VAL" >> "$FILE"
                  fi
              done
          }

          # =======================================================
          # 4. Config ÂàùÂßãÂåñ
          # =======================================================
          echo "üîß [PHASE 2] Config Evolution"
          # ÂÅáË®≠ÂéüÊú¨ÁöÑ config Â≠òÂú®ÔºåË§áË£ΩÈÅé‰æÜ
          # ÈÄôË£°ÊàëÂÄëÁî®‰∏ÄÂÄãÊõ¥Âº∑ÂÅ•ÁöÑÊ™¢Êü•ÔºöÂ¶ÇÊûú SYNC_TARGET_3 Â≠òÂú®ÔºåÂ∞±Áî®ÂÆÉÔºåÂê¶ÂâáÂ†±ÈåØ
          # Ê≥®ÊÑèÔºöÊàëÂÄëÁèæÂú®Âú® busybox-1.37.0 ÁõÆÈåÑ‰∏ã
          
          if [ -f "$SYNC_TARGET_3" ]; then
              cp -f "$SYNC_TARGET_3" .config
          else
              echo "‚ö†Ô∏è Original config not found at $SYNC_TARGET_3"
              # ÈÄôË£°ÂèØ‰ª•ÈÅ∏ÊìáÊòØÂê¶Ë¶ÅÁπºÁ∫åÔºåÂ¶ÇÊûúÊ≤íÊúâÂéüÂßã configÔºåmake oldconfig ÊúÉ‰ΩøÁî® defaults
              # ÁÇ∫‰∫ÜÂÆâÂÖ®ÔºåÊàëÂÄëÈÇÑÊòØÂ†±ÈåØÊØîËºÉÂ•ΩÔºåÈô§ÈùûÊÇ®Á¢∫ÂÆöË¶ÅÁî®È†êË®≠
              # exit 1 
          fi
          
          yes "" | make oldconfig || true

          # 4.3 [SMART CLEAN] Êô∫ÊÖßÊ∏ÖÁêÜ (Èò≤Ê≠¢ÈáçË§áÂÆöÁæ©)
          echo "   -> Cleaning ALL target keys to prevent reassign warnings..."
          for ENTRY in "${CHECKS_SET[@]}"; do
              KEY=${ENTRY%% *}
              sed -i "/$KEY/d" .config
          done
          for KEY in "${CHECKS_UNSET[@]}"; do
              sed -i "/$KEY/d" .config
          done
          echo "   ‚úÖ Clean complete."

          # 4.4 [INJECT] Ê≥®ÂÖ•Ë®≠ÂÆö
          echo "   -> Injecting Specs..."
          {
              echo "# --- Custom Injection Start ---"
              for ENTRY in "${CHECKS_SET[@]}"; do
                  KEY=${ENTRY%% *}
                  VAL=${ENTRY#* }
                  echo "$KEY=$VAL"
              done
              for KEY in "${CHECKS_UNSET[@]}"; do
                  echo "# $KEY is not set"
              done
              echo "# --- Custom Injection End ---"
          } >> .config

          # 4.5 Êï¥Âêà
          yes "" | make oldconfig || true

          # =======================================================
          # 5. [IRONCLAD AUDIT] Êú¨Âú∞È©óË≠âËø¥Âúà
          # =======================================================
          echo "üîç [PHASE 3] Local Audit Loop (.config)"
          CURRENT_FILE=".config"
          
          # Round 1
          FAIL_LIST_1=()
          if ! audit_config "$CURRENT_FILE" FAIL_LIST_1; then
              echo "‚ö†Ô∏è Round 1 Failed. Fix count: ${#FAIL_LIST_1[@]}"
              apply_fixes "$CURRENT_FILE" "${FAIL_LIST_1[@]}"
          else
              echo "‚úÖ Round 1 Passed."
          fi
          
          # Round 2
          FAIL_LIST_2=()
          if ! audit_config "$CURRENT_FILE" FAIL_LIST_2; then
              echo "‚ö†Ô∏è Round 2 Failed. Fix count: ${#FAIL_LIST_2[@]}"
              apply_fixes "$CURRENT_FILE" "${FAIL_LIST_2[@]}"
          else
              echo "‚úÖ Round 2 Passed."
          fi
          
          # Round 3 (Death Check)
          FAIL_LIST_3=()
          if ! audit_config "$CURRENT_FILE" FAIL_LIST_3; then
              echo "‚õî FATAL: Round 3 Failed!"
              printf '   - %s\n' "${FAIL_LIST_3[@]}"
              exit 1
          fi
          echo "‚úÖ Round 3 Passed. Config is Perfect."

          # =======================================================
          # 6. [SYNC & FULL VERIFY] ÂêåÊ≠• + ÈÄê‰∏ÄÈ©óË≠â
          # =======================================================
          echo "üåç [PHASE 4] Sync & Global Verify"
          
          echo "   -> Propagating to Targets..."
          # Á¢∫‰øùÁõÆÊ®ôÁõÆÈåÑÂ≠òÂú® (configs/boards)
          mkdir -p "$(dirname "$SYNC_TARGET_3")"
          
          cp -f .config "$SYNC_TARGET_2"
          cp -f .config "$SYNC_TARGET_3"
          
          ALL_TARGETS=("$SYNC_TARGET_1" "$SYNC_TARGET_2" "$SYNC_TARGET_3")
          
          for TARGET in "${ALL_TARGETS[@]}"; do
              echo "   ----------------------------------------"
              echo "   üîç Final Audit for: $TARGET"
              FINAL_FAILS=()
              if ! audit_config "$TARGET" FINAL_FAILS; then
                  echo "‚ùå FATAL ERROR: Verification Failed on $TARGET"
                  printf '   - %s\n' "${FINAL_FAILS[@]}"
                  exit 1
              else
                  echo "‚úÖ Verified: $TARGET"
              fi
          done
          echo "‚úÖ All 3 Targets are 100% Synchronized and Verified."

          # =======================================================
          # 7. [CODE & BUILD] Á®ãÂºèÁ¢ºËàá‰æùË≥¥È©óË≠â
          # =======================================================
          echo "üíâ [PHASE 5] Code & Build Verify"
          
          # ÂõûÂà∞ trunk/user/rc (Áõ∏Â∞çË∑ØÂæë)
          cd "../../rc"
          RC_FILE="services.c" 
          PATCH_FILE="services_syslogd_fix.patch"
          
          if [ -f "$RC_FILE" ]; then
              echo "   üîç Checking $RC_FILE..."
              
              # [Ê™¢Êü• 1]: È†êÂÖàÊ™¢Êü•ÊòØÂê¶Â∑≤Á∂ì‰øÆÂæ© (ÂÜ™Á≠âÊÄß)
              if grep -F '"-L",' "$RC_FILE" && ! grep -q 'syslogd_argv\[7\]' "$RC_FILE"; then
                  echo "   ‚úÖ Code is already patched. Skipping apply."
              else
                  # [Ê™¢Êü• 2]: Á¢∫Ë™çÁâπÂæµÁ¢ºÂ≠òÂú®ÊâçÂü∑Ë°å patch
                  if grep -F "NULL,				/* -L */" "$RC_FILE"; then
                      echo "   -> Applying patch..."
                      
                      # ÈÄôË£°‰ΩøÁî®‰πæÊ∑®ÁöÑ Here-DocÔºåÁ∏ÆÊéíËàá Shell ËÖ≥Êú¨Â∞çÈΩä
                      cat << 'END_PATCH' > "$PATCH_FILE"
          --- services.c.orig
          +++ services.c
          @@ -52,7 +52,7 @@
           		"-S",				/* smaller output */
           		"-D",				/* drop duplicates */
           		"-O", "/tmp/syslog.log",	/* syslog file */
          -		NULL,				/* -L */
          +		"-L",				/* log locally */
           		NULL, NULL,			/* -R host:port */
           		NULL
           	};
          @@ -63,8 +63,7 @@
           	if (is_valid_ipv4(log_ipaddr)) {
           		int log_port = nvram_safe_get_int("log_port", 514, 1, 65535);
           		snprintf(host_dst, sizeof(host_dst), "%s:%d", log_ipaddr, log_port);
          -		syslogd_argv[7] = "-L";		/* local & remote */
           		syslogd_argv[8] = "-R";
           		syslogd_argv[9] = host_dst;
           	}
          END_PATCH
                      
                      # Âü∑Ë°å Patch (ÂÖÅË®± fuzz/offsetÔºåÂ§±Êïó‰∏ç‰∏≠Êñ∑)
                      patch -l -F 5 -N < "$PATCH_FILE" || echo "‚ö†Ô∏è Patch msg: Fuzzy match or already applied."
                      rm "$PATCH_FILE"
                  else
                      echo "‚ö†Ô∏è Target code block not found! File might be already changed."
                  fi
              fi
              
              # [ÊúÄÁµÇÈ©óË≠â]: ÈÄôÊòØÂîØ‰∏ÄÊ±∫ÂÆöÊàêÊïóÁöÑÈóúÈçµ
              if ! grep -F '"-L",' "$RC_FILE"; then 
                  echo "‚ùå Patch Failed! '-L' not found."
                  exit 1
              fi
              
              if grep -q 'syslogd_argv\[7\]' "$RC_FILE"; then 
                  echo "‚ùå Patch Failed! Old code remains."
                  exit 1
              fi
              echo "‚úÖ Code Patch Verified."
          fi

          # Build Script Cleanup
          # ÂõûÂà∞ trunk (Âõ†ÁÇ∫ÂâçÈù¢ÊòØÂú® busybox ÁõÆÈåÑ)
          cd ../.. 
          
          echo "üßπ [PHASE 6] Build System Cleanup & Verify"
          
          # 1. ÊõøÊèõ 1.24.x -> 1.37.0 (Âä†‰∏ä || true Èò≤Ê≠¢ grep Êâæ‰∏çÂà∞ÊôÇÂ†±ÈåØ)
          grep -rl "busybox-1.24.x" user/ | xargs -r sed -i "s/busybox-1.24.x/busybox-1.37.0/g" || true
          grep -rl "busybox-1.24.2" user/ | xargs -r sed -i "s/busybox-1.24.2/busybox-1.37.0/g" || true
          
          # 2. ÊõøÊèõËÖ≥Êú¨ÂÖßÁöÑËÆäÊï∏ÂÆöÁæ©
          find . -maxdepth 1 -name "*.sh" -o -name "build_firmware*" | while read -r script; do
             if grep -q 'busybox_id="1.24.x"' "$script"; then
                sed -i 's/busybox_id="1.24.x"/busybox_id="1.37.0"/' "$script"
                echo "   -> Updated version in $script"
             fi
          done
          
          # 3. ÊúÄÁµÇÈ©óË≠â (Á¢∫Ë™çÊòØÂê¶ÈÇÑÊúâÊÆòÁïô)
          # üî• ‰øÆÊ≠£ÈªûÔºöÂä†‰∏ä || trueÔºåÈò≤Ê≠¢ grep Ê≤íÊâæÂà∞Êù±Ë•ø(ËøîÂõû1)Â∞éËá¥ËÖ≥Êú¨Â¥©ÊΩ∞
          REMAINING_COUNT=$(grep -r "busybox-1.24.x" user/ | wc -l || true)
          
          if [ "$REMAINING_COUNT" -ne 0 ]; then
              echo "‚ùå Build script cleanup failed! Found $REMAINING_COUNT occurrences."
              # ÂàóÂá∫ÊÆòÁïôÊ™îÊ°à‰æõ Debug
              grep -r "busybox-1.24.x" user/
              exit 1
          fi
          
          echo "‚úÖ Build System Verified (No old versions found)."

          # =======================================================
          # 8. [SECURITY] CVE-2025-60876 & CVE-2025-46394
          # =======================================================
          echo "üõ°Ô∏è [PHASE 7] Applying Security Patches"
          
          # 1. ÈÄ≤ÂÖ• busybox Ê∫êÁ¢ºÁõÆÈåÑ
          # Ê≥®ÊÑèÔºöÊ≠§ÊôÇÊàëÂÄëÂú® trunk ÁõÆÈåÑ (PHASE 6 ÁµêÊùü‰ΩçÁΩÆ)ÔºåÊâÄ‰ª•Ë¶ÅÈÄ≤ user/busybox
          cd user/busybox
          
          # ÈÄ≤ÂÖ•ÁâàÊú¨ËôüÁõÆÈåÑ (Â¶ÇÊûúÂ≠òÂú®)
          if [ -d "busybox-1.37.0" ]; then cd "busybox-1.37.0"; fi
          
          # 2. Âª∫Á´ã patches Â∞àÁî®ÁõÆÈåÑ
          echo "   -> Creating 'patches' directory..."
          mkdir -p patches

          # -------------------------------------------------------
          # [Patch 1] CVE-2025-60876: Wget Header Injection
          # -------------------------------------------------------
          cat << 'CVE_PATCH_1' > patches/CVE-2025-60876.patch
          From: Radoslav Kolev <radoslav.kolev@suse.com>
          Subject: [PATCH] wget: don't allow control characters or spaces in the URL

          Fixes CVE-2025-60876 malicious URL can be used to inject
          HTTP headers in the request.

          ---
           networking/wget.c | 9 +++++++++
           1 file changed, 9 insertions(+)

          diff --git a/networking/wget.c b/networking/wget.c
          index ec3767793..b8a6d02bb 100644
          --- a/networking/wget.c
          +++ b/networking/wget.c
          @@ -536,6 +536,15 @@ static void parse_url(const char *src_url, struct host_info *h)
           {
           	char *url, *p, *sp;
           
          +	/* Fix for CVE-2025-60876 - don't allow control characters or spaces in the URL */
          +	/* otherwise a malicious URL can be used to inject HTTP headers in the request */
          +	unsigned char *u = (void *) src_url;
          +	while (*u) {
          +		if (*u <= ' ')
          +			bb_simple_error_msg_and_die("Unencoded control character found in the URL!");
          +		u++;
          +	}
          +
           	free(h->allocated);
           	h->allocated = url = xstrdup(src_url);
          CVE_PATCH_1

          echo "   -> Applying patches/CVE-2025-60876.patch..."
          patch -p1 -N -i patches/CVE-2025-60876.patch || echo "‚ö†Ô∏è CVE-2025-60876 patch fuzzy/already applied."

          # -------------------------------------------------------
          # [Patch 2] CVE-2025-46394: Libarchive Terminal Injection (V2)
          # Â∑≤ÁßªÈô§ testsuite Ê∏¨Ë©¶ËÖ≥Êú¨ÔºåÂè™‰øÆÂæ©Ê†∏ÂøÉ .c Ê™îÊ°à
          # -------------------------------------------------------
          cat << 'CVE_PATCH_2' > patches/CVE-2025-46394.patch
          From: Denys Vlasenko <vda.linux@googlemail.com>
          Subject: [PATCH] archival/libarchive: sanitize filenames on output

          This fixes CVE-2025-46394 (terminal escape sequence injection)

          ---
           archival/libarchive/header_list.c         | 2 +-
           archival/libarchive/header_verbose_list.c | 4 ++--
           2 files changed, 3 insertions(+), 3 deletions(-)

          diff --git a/archival/libarchive/header_list.c b/archival/libarchive/header_list.c
          index 0621aa406..9490b3635 100644
          --- a/archival/libarchive/header_list.c
          +++ b/archival/libarchive/header_list.c
          @@ -8,5 +8,5 @@
           void FAST_FUNC header_list(const file_header_t *file_header)
           {
           //TODO: cpio -vp DIR should output "DIR/NAME", not just "NAME" */
          -	puts(file_header->name);
          +	puts(printable_string(file_header->name));
           }
          diff --git a/archival/libarchive/header_verbose_list.c b/archival/libarchive/header_verbose_list.c
          index a575a08a0..e7a09430d 100644
          --- a/archival/libarchive/header_verbose_list.c
          +++ b/archival/libarchive/header_verbose_list.c
          @@ -57,13 +57,13 @@ void FAST_FUNC header_verbose_list(const file_header_t *file_header)
           		ptm->tm_hour,
           		ptm->tm_min,
           		ptm->tm_sec,
          -		file_header->name);
          +		printable_string(file_header->name));
           
           #endif /* FEATURE_TAR_UNAME_GNAME */
           
           	/* NB: GNU tar shows "->" for symlinks and "link to" for hardlinks */
           	if (file_header->link_target) {
          -		printf(" -> %s", file_header->link_target);
          +		printf(" -> %s", printable_string(file_header->link_target));
           	}
           	bb_putchar('\n');
           }
          CVE_PATCH_2

          echo "   -> Applying patches/CVE-2025-46394.patch..."
          patch -p1 -N -i patches/CVE-2025-46394.patch || echo "‚ö†Ô∏è CVE-2025-46394 patch fuzzy/already applied."

          set +x
          echo "üéâ BusyBox 1.37.0 Evolution Complete (V44: Integrated Masterpiece)."
          echo "::endgroup::"
      
      # =======================================================
      # 7.5. [ÂÖ®Â±Ä‰øÆÂæ©] ÂçáÁ¥ö iptables 1.8.11 + ‰øÆÂæ©ÊâÄÊúâ‰æùË≥¥ÂåÖË∑ØÂæë + Â•óÁî® Upstream Patches
      # =======================================================
      - name: üî• Auto Upgrade iptables 1.8.11 & Patch
        run: |
          set +e  # ÈóúÈñâÈåØË™§‰∏≠Êñ∑ÔºåÁ¢∫‰øùË∑ëÂÆåÂÖ®Á®ã
          set -x  # Â¶ÇÊûúÈúÄË¶ÅÊ•µËá¥ Debug ÂèØÊâìÈñãÊ≠§Ë°å
          
          echo "::group::Iptables Upgrade & Patching (1.8.11 Collector Mode)"
          
          NEW_VER="iptables-1.8.11"
          
          # [ÂàùÂßãÂåñ] ÊµÅÁ®ãÊéßÂà∂ËÆäÊï∏
          SKIP_PATCHING=false
          
          # --- Part 1: ÂÆö‰ΩçËàáËÆäÊï∏Ê∫ñÂÇô ---
          IPT_MAKEFILE=$(find padavan-ng/trunk/user/iptables -name Makefile | head -n 1)
          IPT_DIR=$(dirname "$IPT_MAKEFILE")
          # ÂÆöÁæ©ÊúÄÁµÇËß£Â£ìÂæåÁöÑÁõÆÈåÑÂêçÁ®± (ÈÄöÂ∏∏ÊòØ iptables-1.8.11)
          IPT_ROOT="$IPT_DIR/$NEW_VER"
          
          echo "‚úÖ ÈéñÂÆö iptables Makefile: $IPT_MAKEFILE"
          echo "‚úÖ Â∑•‰ΩúÁõÆÈåÑ (IPT_DIR): $IPT_DIR"
          
          # Âæû Makefile Ë£°Èù¢ÊäìÂá∫ÁõÆÂâçÁöÑÁâàÊú¨ (‰æãÂ¶Ç iptables-1.8.10)
          OLD_VER_STR=$(grep -o 'iptables-[0-9.]*' "$IPT_MAKEFILE" | head -n 1)
          
          # [Bug Fix] Èò≤ÂëÜÊ©üÂà∂ÔºöÂ¶ÇÊûúÊäì‰∏çÂà∞ÁâàÊú¨ËôüÔºåÁµ¶‰∫àÈ†êË®≠ÂÄºÔºåÈÅøÂÖç sed Ë™ûÊ≥ïÈåØË™§
          if [ -z "$OLD_VER_STR" ]; then
              echo "‚ö†Ô∏è Warning: ÁÑ°Ê≥ïËá™ÂãïÂÅµÊ∏¨ËàäÁâàÊú¨ÔºåÈ†êË®≠‰ΩøÁî® iptables-1.8.10"
              OLD_VER_STR="iptables-1.8.10"
          else
              echo "‚úÖ ÂÅµÊ∏¨Âà∞ËàäÁâàÊú¨: $OLD_VER_STR"
          fi
          echo "‚úÖ Ê∫ñÂÇôÂçáÁ¥öËá≥: $NEW_VER"
          
          # =======================================================
          # [ÈóúÈçµ‰øÆÂæ©] Âº∑Âà∂‰∏ãËºâËàáËß£Â£ìÈÇèËºØ (Ëß£Ê±∫ Patch ÊôÇÁÑ°ÂéüÂßãÁ¢ºÁöÑÂïèÈ°å)
          # =======================================================
          echo "üìÇ Checking source integrity before patching..."
          
          # Ê™¢Êü•ÂéüÂßãÁ¢ºÁõÆÈåÑÊòØÂê¶Â≠òÂú®Ôºå‰∏çÂ≠òÂú®ÂâáÊ∫ñÂÇô‰∏ãËºâËß£Â£ì
          if [ ! -d "$IPT_ROOT" ]; then
              echo "‚ö†Ô∏è Source directory '$IPT_ROOT' not found."
              
              # Ê™¢Êü•ÊòØÂê¶Â∑≤Êúâ tarball (ÂèØËÉΩÊòØ Makefile ‰∏ãËºâÁöÑ)
              TAR_FILE="$IPT_DIR/$NEW_VER.tar.xz"
              
              if [ ! -f "$TAR_FILE" ]; then
                  echo "‚¨áÔ∏è Tarball missing. Downloading official source ($NEW_VER)..."
                  # ‰ΩøÁî®ÂÆòÊñπÈÄ£Áµê‰∏ãËºâÔºåÈÅøÂÖç‰æùË≥¥ build system ÁöÑÂª∂ÈÅ≤
                  wget --no-check-certificate -q -O "$TAR_FILE" "https://www.netfilter.org/projects/iptables/files/$NEW_VER.tar.xz" || \
                  wget --no-check-certificate -q -O "$TAR_FILE" "https://www.netfilter.org/projects/iptables/files/old/$NEW_VER.tar.xz"
                  
                  if [ -f "$TAR_FILE" ] && [ -s "$TAR_FILE" ]; then
                       echo "‚úÖ Download successful."
                  else
                       # „Äê‰øÆÊ≠£Èªû 1„ÄëÁßªÈô§ exit 1ÔºåÊîπÁÇ∫Ë®≠ÂÆö SKIP_PATCHINGÔºåÁ¢∫‰øùÊµÅÁ®ã‰∏ç‰∏≠Êñ∑
                       echo "‚ùå CRITICAL: Failed to download iptables source! Patching phase will be SKIPPED."
                       SKIP_PATCHING=true
                  fi
              fi
              
              # Âè™ÊúâÂú®‰∏ãËºâÊàêÂäü‰∏îÊ≤íÊúâË∑≥ÈÅéÊ®ôË®òÊôÇÊâçËß£Â£ì
              if [ "$SKIP_PATCHING" != true ] && [ -f "$TAR_FILE" ]; then
                  echo "üì¶ Extracting tarball..."
                  if tar -xJf "$TAR_FILE" -C "$IPT_DIR"; then
                      echo "‚úÖ Extraction complete: $IPT_ROOT"
                  else
                      echo "‚ùå Extraction failed! Patching phase will be SKIPPED."
                      SKIP_PATCHING=true
                  fi
              fi
          else
              echo "‚úÖ Source directory exists. Ready for patching."
          fi

          # =======================================================
          # Part 2: ‰øÆÊîπ Makefile ËàáÊßãÂª∫‰øÆÊ≠£
          # =======================================================
          # 1. ‰øÆÊîπ‰∏ª Makefile ÁöÑÁâàÊú¨Ëôü
          sed -i "s/$OLD_VER_STR/$NEW_VER/g" "$IPT_MAKEFILE"
          
          # 2. ÊÅ¢Âæ©Ê≠£Â∏∏ÁöÑÊßãÂª∫ÊµÅÁ®ã (Ëß£Ê±∫ cd error)
          sed -i 's/^all: config_test/all: download_test extract_test config_test/' "$IPT_MAKEFILE"
          
          # 3. ÁßªÈô§ autogen.sh (Ëß£Ê±∫ not found error)
          sed -i '/.\/autogen.sh/d' "$IPT_MAKEFILE"
          
          # 4. Ê∏ÖÁêÜÈÅéÊôÇÁöÑ extensions/disabled Ë§áË£ΩÊåá‰ª§ (Ëß£Ê±∫ copy error)
          sed -i '/extensions\/disabled\//d' "$IPT_MAKEFILE"

          # =======================================================
          # 5. [Êñ∞Â¢û] ÂÆöÁæ© Patch ‰∏ãËºâÂáΩÊï∏ËàáÊ∏ÖÂñÆ (V12.3 ÁµÇÊ•µËûçÂêàÁâà)
          # =======================================================
          # ÈÄôË£°ÊàëÂÄëÂ∞á Patch ‰∏ãËºâÂà∞ Makefile ÂêåÁ¥öÁõÆÈåÑ‰∏ãÁöÑ patches_archive
          PATCH_DIR="$IPT_DIR/patches_archive"
          mkdir -p "$PATCH_DIR"
          LOG_FILE="$IPT_DIR/patch_summary.log"
          touch "$LOG_FILE"
          
          # ‚öôÔ∏è Ë®≠ÂÆöÂçÄ
          if [ "$SKIP_PATCHING" = true ]; then
              APPLY_PATCHES=false
              echo "‚ö†Ô∏è Skipping Patch Application due to download/extract failure."
          else
              APPLY_PATCHES=true
          fi
            
          # ÂÑ™ÂåñÂÖ®Â±ÄÁ∂≤Ë∑ØË®≠ÁΩÆ
          git config --global http.postBuffer 524288000
          git config --global http.lowSpeedLimit 0
          git config --global http.lowSpeedTime 999999
          git config --global http.sslVerify false

          # üõ†Ô∏è [Ê†∏ÂøÉÂáΩÊï∏] Áç®Á´ãÈ©óË≠âÈÇèËºØ (V12.3: Awk Êô∫ÊÖßÈÇäÁïåÂà§ÂÆö + Ë°åÊï∏Èò≤Á¶¶)
          verify_patch_integrity() {
              local F_PATH="$1"
              local EXP_ID="$2"
              local EXP_SUBJ="$3"
              
              # 1. Âü∫Á§éÊ™îÊ°àÊ™¢Êü•
              if [ ! -s "$F_PATH" ]; then return 1; fi
              if ! grep -qE "^diff --git|^--- a/" "$F_PATH"; then return 1; fi

              local CHECK_PASS=true

              # 2. Commit ID ÊØîÂ∞ç
              if [ -n "$EXP_ID" ]; then
                  local FILE_ID=$(grep "^From " "$F_PATH" | head -n 1 | awk '{print $2}')
                  if [[ "$FILE_ID" == "$EXP_ID"* ]]; then
                      echo "   ‚úÖ ID Check: MATCH ($EXP_ID)"
                  else
                      echo "   ‚ùå ID Check: MISMATCH (File: ${FILE_ID:0:8} vs Url: ${EXP_ID:0:8})"
                      CHECK_PASS=false
                  fi
              fi

              # 3. Subject Ê®ôÈ°åÊØîÂ∞ç (‰ΩøÁî® awk ÈÄ≤Ë°åÂ§öË°åÂêà‰ΩµËàáÊô∫ÊÖßÈÇäÁïåÂÅµÊ∏¨)
              if [ -n "$EXP_SUBJ" ]; then
                  # Awk ÈÇèËºØÔºö
                  # 1. ÊâæÂà∞ Subject: ÈñãÈ†≠ÔºåË®≠ÂÆö flag=1„ÄÇ
                  # 2. Â¶ÇÊûú flag=1ÔºåÊ™¢Êü•Áï∂ÂâçË°åÊòØÂê¶ÁÇ∫ÈÇäÁïåÔºàÁ©∫Ë°åÊàñÊñ∞ HeaderÔºâ„ÄÇ
                  # 3. Â¶ÇÊûúÊòØÈÇäÁïåÔºåÂÅúÊ≠¢ËÆÄÂèñÔºõÂê¶ÂâáÂ∞áÂÖßÂÆπ‰∏≤Êé•„ÄÇ
                  # 4. Ëº∏Âá∫‰∏≤Êé•ÂæåÁöÑÁµêÊûú„ÄÇ
                  local RAW_SUBJ_BLOCK=$(awk '
                      /^Subject: / { flag=1; sub(/^Subject: /, ""); printf "%s", $0; next }
                      flag == 1 {
                          # „Äê‰øÆÊ≠£Èªû 2„ÄëÂä†ÂÖ•Ë°åÊï∏ÈôêÂà∂ÔºåÈò≤Ê≠¢Á∑©Ë°ùÂçÄÊ∫¢‰Ωç
                          c++; if (c > 10) exit; 
                          if (/^$/) exit;  # ÈÅáÂà∞Á©∫Ë°å -> ÁµêÊùü
                          if (/^[A-Za-z0-9-]+:/) exit; # ÈÅáÂà∞Êñ∞ Header (Â¶Ç MIME-Version:) -> ÁµêÊùü
                          printf " %s", $0; # Âê¶ÂâáË¶ñÁÇ∫ Subject ÁöÑÂª∂Á∫å (ÊèõË°åËÆäÁ©∫Ê†º)
                      }
                  ' "$F_PATH" | sed 's/\[PATCH\] //g')
                  
                  # Âü∑Ë°åÊ®ôÊ∫ñÂåñÔºöÂè™‰øùÁïôËã±Êï∏Â≠ó
                  local FILE_NORM_SUBJ=$(echo "$RAW_SUBJ_BLOCK" | tr -dc 'a-zA-Z0-9')
                  
                  if [ "$FILE_NORM_SUBJ" == "$EXP_SUBJ" ]; then
                      echo "   ‚úÖ Subject Check: MATCH"
                  else
                      echo "   ‚ùå Subject Check: MISMATCH"
                      # echo "      Exp: $EXP_SUBJ"
                      # echo "      Got: $FILE_NORM_SUBJ"
                      CHECK_PASS=false
                  fi
              fi

              if [ "$CHECK_PASS" = true ]; then return 0; else return 1; fi
          }

          # üõ†Ô∏è [‰∏ªËôïÁêÜÂáΩÊï∏] V12 ÈÇèËºØÔºöProcess Loop (Âø´ÂèñÂ§±Êïó -> ÂõûÊ≠∏‰∏ª‰∏ãËºâÊµÅÁ®ã)
          download_and_process() {
              local DATE=$1
              local RAW_NAME=$2
              local URL=$3
              local COUNT=$4
              
              # A. ÂèÉÊï∏Ê∫ñÂÇô
              local SAFE_NAME=$(echo "$RAW_NAME" | sed 's/[^a-zA-Z0-9]/_/g')
              local PATCH_FILENAME="$PATCH_DIR/${COUNT}_${DATE}_${SAFE_NAME}.patch"
              local COOKIE_FILE="$IPT_DIR/cookies.txt"
              
              local TARGET_COMMIT_ID=$(echo "$URL" | grep -o 'id=[a-f0-9]*' | cut -d= -f2)
              local TARGET_NORM_SUBJECT=$(echo "$RAW_NAME" | tr -dc 'a-zA-Z0-9')

              echo "---------------------------------------------------"
              echo "Processing Patch #$COUNT: $RAW_NAME"

              local PROCESS_ATTEMPT=0
              local PROCESS_SUCCESS=false

              # üî• V12 Ê†∏ÂøÉÔºö‰ΩøÁî® while Ëø¥ÂúàËôïÁêÜÈáçË©¶
              while [ $PROCESS_ATTEMPT -lt 2 ]; do
                  PROCESS_ATTEMPT=$((PROCESS_ATTEMPT+1))
                  local NEED_DOWNLOAD=true

                  # ==========================================
                  # B. ÁãÄÊÖãÊ™¢Êü• (Check Phase)
                  # ==========================================
                  if [ -f "$PATCH_FILENAME" ]; then
                      echo "üîç [Attempt $PROCESS_ATTEMPT] Verifying local cache..."
                      if verify_patch_integrity "$PATCH_FILENAME" "$TARGET_COMMIT_ID" "$TARGET_NORM_SUBJECT"; then
                          echo "‚úÖ Local cache verified valid."
                          NEED_DOWNLOAD=false
                      else
                          echo "‚ö†Ô∏è Cache verification failed. Deleting..."
                          rm -f "$PATCH_FILENAME"
                          NEED_DOWNLOAD=true
                      fi
                  else
                      NEED_DOWNLOAD=true
                  fi

                  # ==========================================
                  # C. ‰∏ãËºâÊµÅÁ®ã (Download Phase) - ÂÆåÊï¥ÁöÑ V9 ÂèÉÊï∏Èò≤Á¶¶
                  # ==========================================
                  if [ "$NEED_DOWNLOAD" = true ]; then
                      echo "‚¨áÔ∏è [Attempt $PROCESS_ATTEMPT] Starting Full Download Sequence..."

                      # [UA ÁîüÊàê]
                      if [ $((10#$COUNT % 10)) -eq 1 ] || [ ! -f "$IPT_DIR/ua_cache.txt" ]; then
                          local MINOR_VER=$((RANDOM % 100))
                          echo "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/144.0.${MINOR_VER}.0 Safari/537.36" > "$IPT_DIR/ua_cache.txt"
                          rm -f "$COOKIE_FILE"
                          echo "üîÑ Session Rotate: New UA Generated."
                      fi
                      local UA=$(cat "$IPT_DIR/ua_cache.txt")
                      
                      # [Headers Ë®≠ÂÆö]
                      local H_SEC_CH_UA='"Not(A:Brand";v="8", "Chromium";v="144", "Google Chrome";v="144"'
                      local H_SEC_PLATFORM='"Windows"'
                      local H_LANG="en-US,en;q=0.9"
                      local ACCEPT_FILE="text/x-diff,text/plain,application/octet-stream;q=0.9,*/*;q=0.8"
                      
                      local COMMIT_URL=$(echo "$URL" | sed 's|/patch/|/commit/|')
                      local LOG_URL="https://git.netfilter.org/iptables/log/"
                      
                      # [Èö®Ê©üÂª∂ÈÅ≤]
                      if [ $((10#$COUNT % 30)) -eq 0 ]; then
                          echo "‚òï Long Coffee Break..."
                          sleep $(shuf -i 20-40 -n 1)
                      else
                          sleep $(shuf -i 2-4 -n 1)
                      fi

                      local MAX_RETRIES=5
                      local DOWNLOAD_OK=false

                      for ((i=1; i<=MAX_RETRIES; i++)); do
                          local BACKOFF_TIME=$((5 * i + 5))
                          local PREFLIGHT_DONE=false

                          # [Pre-flight Check]
                          if [ $((RANDOM % 5)) -eq 0 ] || [ $i -gt 1 ]; then
                              echo "üé≠ Performing Pre-flight check..."
                              curl -k -L -s -o /dev/null \
                                   -c "$COOKIE_FILE" -b "$COOKIE_FILE" \
                                   -H "User-Agent: $UA" -H "Referer: $LOG_URL" \
                                   "$COMMIT_URL"
                              sleep 1
                              PREFLIGHT_DONE=true
                          fi
                          local CUR_REFERER="$LOG_URL"
                          [ "$PREFLIGHT_DONE" = true ] && CUR_REFERER="$COMMIT_URL"

                          # 1. ÂòóË©¶ Curl
                          if curl -k -L -s \
                                  -c "$COOKIE_FILE" -b "$COOKIE_FILE" \
                                  -H "User-Agent: $UA" \
                                  -H "Accept: $ACCEPT_FILE" \
                                  -H "Accept-Language: $H_LANG" \
                                  -H "Referer: $CUR_REFERER" \
                                  -H "sec-ch-ua: $H_SEC_CH_UA" \
                                  -H "sec-ch-ua-platform: $H_SEC_PLATFORM" \
                                  --connect-timeout 20 --retry 2 \
                                  -o "$PATCH_FILENAME" "$URL"; then
                                  
                              if verify_patch_integrity "$PATCH_FILENAME" "$TARGET_COMMIT_ID" "$TARGET_NORM_SUBJECT"; then
                                  echo "‚úÖ [Try $i] Download Success & Verified."
                                  DOWNLOAD_OK=true
                                  break
                              else
                                  echo "‚ö†Ô∏è Content invalid. Retrying..."
                                  rm -f "$COOKIE_FILE"
                              fi
                          else
                              # 2. Curl Â§±ÊïóÔºåÂòóË©¶ Wget
                              echo "‚ö†Ô∏è Curl failed. Switching to Wget..."
                              rm -f "$PATCH_FILENAME"
                              if wget --no-check-certificate -q \
                                      --user-agent="$UA" \
                                      --header="Accept: $ACCEPT_FILE" \
                                      --header="Referer: $COMMIT_URL" \
                                      -O "$PATCH_FILENAME" "$URL"; then
                                      
                                  if verify_patch_integrity "$PATCH_FILENAME" "$TARGET_COMMIT_ID" "$TARGET_NORM_SUBJECT"; then
                                      echo "‚úÖ [Try $i] Download Success (Wget) & Verified."
                                      DOWNLOAD_OK=true
                                      break
                                  fi
                              fi
                          fi
                          
                          echo "‚ùå [Try $i] Failed. Cooling down ${BACKOFF_TIME}s..."
                          rm -f "$PATCH_FILENAME"
                          if [ $i -lt $MAX_RETRIES ]; then sleep $BACKOFF_TIME; fi
                      done

                      if [ "$DOWNLOAD_OK" = false ]; then
                          echo "‚ùå CRITICAL: Failed to download valid patch."
                          echo "[$DATE] #$COUNT DOWNLOAD_FAIL : $RAW_NAME" >> "$LOG_FILE"
                          return 1 # ‰∏ãËºâÂæπÂ∫ïÂ§±ÊïóÔºå‰∏≠Ê≠¢Ê≠§ Patch
                      fi
                  fi

                  # ==========================================
                  # D. Â•óÁî®ËàáÊô∫ÊÖßÂæ™Áí∞ (Apply Phase)
                  # ==========================================
                  
                  # 1. ÈÖçÁΩÆÊ™¢Êü•
                  if [ "$APPLY_PATCHES" != true ]; then
                      echo "üì¶ Patch verified but skipped (Apply logic disabled by config)."
                      break 
                  fi

                  # 2. ÁõÆÈåÑÊ™¢Êü•
                  if [ ! -d "$IPT_ROOT" ]; then
                      echo "‚ùå CRITICAL: Source directory '$IPT_ROOT' NOT FOUND!"
                      echo "[$DATE] #$COUNT DIR_MISSING : $RAW_NAME" >> "$LOG_FILE"
                      return 1 
                  fi

                  # 3. Âü∑Ë°å Patch
                  echo "ü©π Applying patch (Pass $PROCESS_ATTEMPT)..."
                      
                  if patch -d "$IPT_ROOT" -t -N -l -F 10 -p1 --no-backup-if-mismatch --reject-file=- < "$PATCH_FILENAME"; then
                      echo "‚úÖ Patch Applied Successfully."
                      PROCESS_SUCCESS=true
                      break # ÊàêÂäüË∑≥Âá∫
                  else
                      # üü¢ [Êñ∞Â¢û] ÂîØ‰∏Ä‰øÆÊîπËôïÔºöPatch Â§±ÊïóÊôÇÔºåÁ´ãÂàªÊ™¢Êü•Ê™îÊ°àÊòØÂê¶ÂÆåÂ•Ω
                      # Â¶ÇÊûúÊ™îÊ°àÊ†°È©óÈÄöÈÅé (Hash Ê≠£Á¢∫)Ôºå‰ª£Ë°®ÊòØ„ÄåÈáçË§áÂ•óÁî®„ÄçÔºåÁõ¥Êé•Ë¶ñÁÇ∫ÊàêÂäü‰∏¶Ë∑≥Âá∫ÔºÅ
                      if verify_patch_integrity "$PATCH_FILENAME" "$TARGET_COMMIT_ID" "$TARGET_NORM_SUBJECT" >/dev/null 2>&1; then
                          echo "‚ö†Ô∏è Patch failed but file integrity is VALID."
                          echo "   -> Assuming patch was already applied or reversed. Skipping..."
                          echo "[$DATE] #$COUNT PATCH_SKIP : $RAW_NAME (Integrity OK)" >> "$LOG_FILE"
                          break
                      fi
                      # üü¢ [ÁµêÊùüÊñ∞Â¢û] Ëã•Ê†°È©óÂ§±ÊïóÔºåÊâçÊúÉÂü∑Ë°å‰∏ãÈù¢ÂéüÊú¨ÁöÑ„ÄåÂà™Èô§ÈáçÊäì„ÄçÈÇèËºØ

                      # üî• [V12 ‰øÆÊ≠£] Êô∫ÊÖßÂà§Êñ∑ÈÇèËºØ
                      if [ "$NEED_DOWNLOAD" = false ]; then
                          # Âø´ÂèñÂ§±Êïà -> Âà™Èô§Âø´Âèñ -> ÈáçË∑ëËø¥Âúà
                          echo "‚ö†Ô∏è Apply failed using cached file."
                          echo "üîÑ Deleting stale cache and forcing FRESH download loop..."
                          rm -f "$PATCH_FILENAME"
                          continue 
                      else
                          # Êñ∞‰∏ãËºâ‰πüÂ§±Êïó -> Âö¥ÈáçÈåØË™§
                          echo "‚ùå CRITICAL: Patch failed even with fresh download."
                          echo "[$DATE] #$COUNT PATCH_FAIL : $RAW_NAME" >> "$LOG_FILE"
                          return 1 
                      fi
                  fi
              done
          }

          # ÂØ´ÂÖ• Patch Ê∏ÖÂñÆ (Oldest -> Newest)
          cat << 'EOL' > "$IPT_DIR/patch_list.txt"
          2024-11-08|configure: Bump version for 1.8.11 release|https://git.netfilter.org/iptables/patch/?id=0506bea1dcc8f12d94e7c32bf2fb04abb3fdd269
          2024-11-12|ip[6]tables-translate: fix test failures when WESP is defined|https://git.netfilter.org/iptables/patch/?id=e6e232d0ae252b0b86278455b18d9475b95db8f0
          2024-11-19|nft: fix interface comparisons in -C commands|https://git.netfilter.org/iptables/patch/?id=40406dbfaefbc204134452b2747bae4f6a122848
          2024-11-19|nft: Drop interface mask leftovers from post_parse callbacks|https://git.netfilter.org/iptables/patch/?id=b3f3e256c263b9a1db49732696aba0dde084ef5e
          2025-01-28|configure: Avoid addition assignment operators|https://git.netfilter.org/iptables/patch/?id=6310639f697d4a570286960c470a6ec8c324be89
          2025-04-10|nft: Make add_log() static|https://git.netfilter.org/iptables/patch/?id=17fb168f007eb4200a1d3325898cf5256a029d81
          2025-04-10|nft: ruleparse: Introduce nft_parse_rule_expr()|https://git.netfilter.org/iptables/patch/?id=d84b1647514f3121bd4a6adfca9a977751c39bbc
          2025-04-10|nft: __add_{match,target}() can't fail|https://git.netfilter.org/iptables/patch/?id=2db8bf2fbf080f6a054b658df65c468bfa0db68d
          2025-04-10|nft: Introduce UDATA_TYPE_COMPAT_EXT|https://git.netfilter.org/iptables/patch/?id=f6f0f4f55794a5f1add6f728f80f29f12f36ecd5
          2025-04-10|nft-ruleparse: Fallback to compat expressions in userdata|https://git.netfilter.org/iptables/patch/?id=ff5f6a208efccd4e2bd8d4fdaf5d284ce54ff69e
          2025-04-10|nft: Pass nft_handle into add_{action,match}()|https://git.netfilter.org/iptables/patch/?id=739d9bd57ad26bd52bed569264daa97b5943e08d
          2025-04-10|nft: Embed compat extensions in rule userdata|https://git.netfilter.org/iptables/patch/?id=7746fa0b1619e1bd8465c9a98bdbead628ed428a
          2025-04-10|tests: iptables-test: Add nft-compat variant|https://git.netfilter.org/iptables/patch/?id=fdb541cddad0681ea3ab1fca8a3949dcf49fb194
          2025-04-23|extensions: icmp: Support info-request/-reply type names|https://git.netfilter.org/iptables/patch/?id=1e6a2812971a268428b04b03520cd68cb61d76e3
          2025-04-23|xshared: Accept an option if any given command allows it|https://git.netfilter.org/iptables/patch/?id=192c3a6bc18f206895ec5e38812d648ccfe7e281
          2025-07-04|extensions: sctp: Translate bare -m sctp match|https://git.netfilter.org/iptables/patch/?id=12e6b5ed65fd91ea413a2e45201289c3d01c4e29
          2025-07-17|extensions: libebt_redirect: prevent translation|https://git.netfilter.org/iptables/patch/?id=d33c6ad308cf7b9f627aeed48a5163c0374b5035
          2025-07-22|libxtables: Promote xtopt_esize_by_type() as xtopt_psize getter|https://git.netfilter.org/iptables/patch/?id=786b75f7c9b9feaa294da097c2e9727747162c79
          2025-07-22|Revert libxtables: Promote xtopt_esize_by_type() as xtopt_psize getter|https://git.netfilter.org/iptables/patch/?id=f66687b6cb5fd0bb36107c30339aa7f4ff75e98e
          2025-07-22|xtables-monitor: Print -X command for base chains, too|https://git.netfilter.org/iptables/patch/?id=8cb0c13b7777e72ca6f4265845dc99eff7cdf679
          2025-08-21|extensions: man: Add a note about route_localnet sysctl|https://git.netfilter.org/iptables/patch/?id=102e9607c63266c7f3413f8dcae51d9476e396e4
          2025-08-25|man: iptables-restore.8: document flush behaviour for user-defined chains|https://git.netfilter.org/iptables/patch/?id=c3d5053db05f99bd72219aebeefc7fb0195ac041
          2025-11-27|nft: Support replacing a rule added in the same batch|https://git.netfilter.org/iptables/patch/?id=78d7a5f8619f3965ec2da13003a876c808c40cfb
          EOL

          # Âü∑Ë°å‰∏ãËºâ
          count=0
          while IFS='|' read -r p_date p_name p_url; do
              [ -z "$p_date" ] && continue
              count=$((count+1))
              # Ë£úÈõ∂‰ª•Á¢∫‰øù glob ÊéíÂ∫èÊ≠£Á¢∫ (01, 02... 23)
              count_str=$(printf "%02d" $count)
              download_and_process "$p_date" "$p_name" "$p_url" "$count_str"
          done < "$IPT_DIR/patch_list.txt"

          echo "üéâ Patch processing cycle completed!"
          
          if [ -s "$LOG_FILE" ]; then
              echo "‚ö†Ô∏è ================= SUMMARY ================="
              cat "$LOG_FILE"
              echo "=========================================="
          else
              echo "‚úÖ Perfect! No errors recorded."
          fi

          # =======================================================
          # [Á¨¨100Ëôü Patch] ÊáâÁî®Â±èËîΩË≠¶ÂëäË£ú‰∏Å (ÂØ¨ÂÆπÊ®°Âºè)
          # =======================================================
          echo "üîß Generating warning suppression patch (Patch #100)..."
          
          PATCH_100="$PATCH_DIR/100_Custom_Suppress_Warnings.patch"
          
          cat << 'END_PATCH' > "$PATCH_100"
          --- a/libxtables/xtables.c
          +++ b/libxtables/xtables.c
          @@ -809,9 +809,11 @@
           		dptr = &((*dptr)->next);
           	}
           
          +#if 0
           	if (seen && !found)
           		fprintf(stderr,
           			"Warning: Extension %s is not supported, missing kernel module?\n",
           			name);
          +#endif
           
           	for (ptr = xtables_matches; ptr; ptr = ptr->next) {
          @@ -939,9 +941,11 @@
           		dptr = &((*dptr)->next);
           	}
           
          +#if 0
           	if (seen && !found)
           		fprintf(stderr,
           			"Warning: Extension %s is not supported, missing kernel module?\n",
           			name);
          +#endif
           
           	for (ptr = xtables_targets; ptr; ptr = ptr->next) {
          END_PATCH

          # Âè™ÊúâÂú®ÈñãÂïüÂ•óÁî®Ê®°ÂºèÊôÇÊâçÂü∑Ë°å
          if [ "$APPLY_PATCHES" = true ]; then
              # [Âº∑Âåñ] V7 Êû∂ÊßãÔºöÂç≥ÊôÇÊâìÂÖ•Ê∫êÁ¢º (Âèñ‰ª£ÂéüÊú¨ÁöÑ dry-run)
              if [ -d "$IPT_ROOT" ]; then
                  echo "ü©π Applying Custom Patch #100 IMMEDIATELY..."
                  # -t:Ëá™ÂãïË∑≥ÈÅéÁº∫Ê™î, -N:Ë∑≥ÈÅéÂ∑≤‰øÆÂæ©, -F 10:ÂÖÅË®±10Ë°åË™§Â∑Æ
                  if patch -d "$IPT_ROOT" -t -N -l -F 10 -p1 --no-backup-if-mismatch --reject-file=- < "$PATCH_100"; then
                      echo "‚úÖ Patch #100 Applied Successfully."
                  else
                      echo "‚ö†Ô∏è Patch #100 Failed (Skipped or Mismatch)."
                      echo "[LOCAL] #100 PATCH_FAIL : Custom_Suppress_Warnings" >> "$LOG_FILE"
                  fi
              else
                  echo "‚ö†Ô∏è Source directory not ready for immediate patching."
              fi
              
              # =======================================================
              # 7. Ê≥®ÂÖ•Ë£ú‰∏ÅÊáâÁî®ÈÇèËºØ
              # =======================================================
              # ‚ùå ËàäÂØ´Ê≥ï (Âç±Èö™): s|...|... && ...|
              # ‚úÖ Êñ∞ÂØ´Ê≥ï (ÂÆâÂÖ®): ‰ΩøÁî®ÂàÜËôü ; Êõø‰ª£ &&ÔºåÈÅøÂÖç sed Ëß£Êûê & ÁâπÊÆäÂ≠óÂÖÉ
              IPT_MAKEFILE="padavan-ng/trunk/user/iptables/Makefile"
              if [ -f "$IPT_MAKEFILE" ]; then
                  # Ë™™ÊòéÔºöÂú® tar Ëß£Â£ìÂæåÔºå‰ΩøÁî® ; ÂàÜËôüÈöîÈñãÊåá‰ª§ÔºåÁ¢∫‰øù Patch Ëø¥ÂúàËÉΩÂü∑Ë°å
                  # „Äê‰øÆÊ≠£Èªû 3„ÄëÂ∞á exit 1 ÊîπÁÇ∫ trueÔºåÂÖÅË®±Á∑®Ë≠ØÊôÇ Patch Â§±Êïó‰ΩÜ‰∏ç‰∏≠Êñ∑
                  sed -i 's@tar xJf $(SRC_NAME).tar.xz;@tar xJf $(SRC_NAME).tar.xz; echo "ü©π Patching..."; for p in `ls ../patches_archive/*.patch | sort`; do echo "   - Applying $$p"; patch -d $(SRC_NAME) -p1 < $$p || true; done;@' "$IPT_MAKEFILE"
                  echo "‚úÖ Iptables Êú¨È´î‰øÆÂæ©Ëàá Patch Ê≥®ÂÖ•ÂÆåÊàê (Makefile Modified)."
              else
                  echo "‚ö†Ô∏è Makefile not found, skipping injection."
              fi

          else
              echo "üì¶ Custom Patch #100 generated but NOT applied."
              echo "üö´ Skipping Makefile injection (APPLY_PATCHES=false)"
          fi
          
          # =======================================================
          # üîç ÁÑ°Ê¢ù‰ª∂È©óË≠â‰ª£Á¢ºÂÖßÂÆπ (Á¢∫‰øùÁÑ°Ë´ñÊòØÂê¶ PatchÔºåÁãÄÊÖãÈÉΩÈÄèÊòé)
          # =======================================================
          echo "üîç Verifying code content (Checking for applied changes)..."
          # Ê≥®ÊÑèÔºöÊ≠§ÊôÇÊ∫êÁ¢ºÂèØËÉΩÂ∞öÊú™Ëß£Â£ìÔºåÂ¶ÇÊûúÂ∞öÊú™Ëß£Â£ìÔºåÈÄôË£°ÊúÉÊèêÁ§∫Êâæ‰∏çÂà∞Ê™îÊ°àÔºåÈÄôÊòØÊ≠£Â∏∏ÁöÑ„ÄÇ
          # ‰ΩÜÂ¶ÇÊûúÊàëÂÄëÊòØÂú®Êú¨Âú∞Áí∞Â¢ÉÂ§öÊ¨°Âü∑Ë°åÔºåÊàñËÄÖÂ∑≤Á∂ìÊúâËß£Â£ìÂæåÁöÑÊ∫êÁ¢ºÔºåÈÄôË£°Â∞±ËÉΩÊ¥æ‰∏äÁî®Â†¥„ÄÇ
          # Ëã•Ë¶ÅÈ©óË≠âÊúÄÁµÇÁµêÊûúÔºåÈÄöÂ∏∏Ë¶ÅÁ≠âÂà∞Á∑®Ë≠ØÂæå„ÄÇÈÄôË£°ÁöÑÈ©óË≠â‰∏ªË¶ÅÈáùÂ∞ç„ÄåÂ¶ÇÊûúÊ™îÊ°àÂ≠òÂú®„Äç„ÄÇ
          VERIFY_TARGET="libxtables/xtables.c"
          
          # ‰ΩøÁî® IPT_ROOT ËÆäÊï∏Á¢∫‰øùË∑ØÂæëÊ≠£Á¢∫
          if [ -f "$IPT_ROOT/$VERIFY_TARGET" ]; then
              # Ê™¢Êü•ÊòØÂê¶Âê´ÊúâÁâπÂæµÁ¢º (#if 0 ÂåÖË£πËëó Warning)
              if grep -q "#if 0" "$IPT_ROOT/$VERIFY_TARGET" && grep -q "Warning: Extension %s is not supported" "$IPT_ROOT/$VERIFY_TARGET"; then
                  echo "‚úÖ Verification Passed: Code IS patched/modified (Warnings suppressed)."
                  echo "üëá Current Code Snippet (Looks Good):"
                  # È°ØÁ§∫ÂåπÈÖçË°åÂèäÂÖ∂‰∏ä‰∏ã 3 Ë°åÔºåÊñπ‰æø‰∫∫Â∑•Á¢∫Ë™ç
                  grep -nC 3 "Warning: Extension %s is not supported" "$IPT_ROOT/$VERIFY_TARGET"
              else
                  echo "‚ö†Ô∏è Verification Result: Code is UNPATCHED (Warnings active)."
                  echo "üëá Current Code Snippet (Original/Unpatched):"
                  grep -nC 3 "Warning: Extension %s is not supported" "$IPT_ROOT/$VERIFY_TARGET"
              fi
          else
              echo "‚ÑπÔ∏è Verification skipped: Source file $VERIFY_TARGET not found yet (will be extracted during build)."
              echo "   (This is normal for a clean build before compilation starts)"
          fi
          
          # --- Part 2: [Êñ∞Â¢û] ‰øÆÂæ©ÊâÄÊúâ‰æùË≥¥ iptables ÁöÑÂÖ∂‰ªñËªüÈ´î (MiniUPnPD Á≠â) ---
          # =======================================================
          # 10. [‰øÆÂæ©] ‰æùË≥¥ iptables ÁöÑÂÖ∂‰ªñËªüÈ´î (MiniUPnPD Á≠â)
          # =======================================================
          # ‚úÖ [Fix] ÁßªÈô§ÈáçË§áÂÆöÁæ©ÁöÑËÆäÊï∏ÔºåÁõ¥Êé•‰ΩøÁî®ËÖ≥Êú¨ÈñãÈ†≠ÂÅµÊ∏¨Âà∞ÁöÑ OLD_VER_STR
          # ÈÄôÊ®£Âç≥‰ΩøËàäÁâàÊú¨ÊòØ 1.8.9ÔºåÈÄôË£°‰πüËÉΩÊ≠£Á¢∫‰øÆÂæ©Ôºå‰∏çÊúÉÂõ†ÁÇ∫ÂØ´Ê≠ª 1.8.10 ËÄåÂ§±Êïó
          
          echo "üîç ÈñãÂßãÊéÉÊèè‰∏¶‰øÆÂæ©‰æùË≥¥ËàäÁâà iptables ($OLD_VER_STR) ÁöÑÂÖ∂‰ªñÂ•ó‰ª∂..."
          
          # Èò≤ÂëÜÊ©üÂà∂ÔºöÂ¶ÇÊûúÈñãÈ†≠Ê≤íÊäìÂà∞ËàäÁâàÊú¨ËôüÔºåÁµ¶‰∏ÄÂÄãÈªòË™çÂÄº‰ª•ÂÖç sed Â†±ÈåØ
          if [ -z "$OLD_VER_STR" ]; then
              echo "‚ö†Ô∏è Warning: Could not detect OLD_VER_STR automatically. Fallback to 1.8.10"
              OLD_VER_STR="iptables-1.8.10"
          fi

          # ÊêúÂ∞ã trunk/user ‰∏ãÊâÄÊúâÂê´ÊúâËàäÁâàÊú¨Â≠ó‰∏≤ÁöÑ Makefile
          # ‰ΩøÁî® || true ÈÅøÂÖç grep Ê≤íÊâæÂà∞Ê™îÊ°àÊôÇÂ∞éËá¥ËÖ≥Êú¨‰∏≠Êñ∑ (Â¶ÇÊûú set -e ÈñãÂïüÁöÑË©±)
          grep -rl "$OLD_VER_STR" padavan-ng/trunk/user/ | while read -r file ; do
              echo "  - ‰øÆÂæ©Ë∑ØÂæë: $file"
              sed -i "s/$OLD_VER_STR/$NEW_VER/g" "$file"
          done
          
          echo "üéâ ÂÖ®Â±ÄË∑ØÂæëÊõøÊèõÂÆåÊàêÔºÅÊâÄÊúâÂ•ó‰ª∂ÁèæÂú®ÈÉΩÊåáÂêë $NEW_VER"
          
          # [Â¢ûÂº∑] ÊúÄÁµÇÁãÄÊÖãÊ™¢Êü• (Debug Áî®ÔºåÁ¢∫Ë™çÁõÆÈåÑÂ≠òÂú®‰∏îÊôÇÈñìÊ≠£Á¢∫)
          echo "üìã Final listing of source directory to verify patch application:"
          if [ -d "$IPT_ROOT" ]; then
              ls -ld "$IPT_ROOT"
          else
              echo "‚ÑπÔ∏è Source directory not present yet (Clean Build)."
          fi
          
          echo "::endgroup::"

      # 7.6 [Á∂≤Ë∑ØÂ∑•ÂÖ∑] Êô∫ÊÖßÁ∑®Ë≠Ø Êñ∞Â¢û Arptables
      - name: üî• Network Tools (Smart Compile Arptables)
        run: |
          echo "::group::Smart Compile Network Tools"
          
          # === Ë®≠ÂÆöË∑ØÂæë ===
          BASE_DIR="$GITHUB_WORKSPACE/padavan-ng/trunk/user"
          ARP_ROOT="$BASE_DIR/arptables"
          
          # ========================================
          # 1. Êñ∞Â¢û Arptables v0.0.5
          # ========================================
          echo "‚¨áÔ∏è Processing Arptables..."
          
          mkdir -p "$ARP_ROOT"
          cd "$ARP_ROOT" || exit 1
          
          # Ê™¢Êü•ÊòØÂê¶Â∑≤Á∂ìË®≠ÂÆöÈÅéÔºåÈÅøÂÖçÈáçË§áÂü∑Ë°å
          if [ ! -f "Makefile" ] || ! grep -q "arptables" "Makefile"; then
            
            ARP_TAR="arptables-0.0.5.tar.gz"
            ARP_URL="https://www.netfilter.org/pub/arptables/arptables-0.0.5.tar.gz"
            
            echo "   Downloading $ARP_URL ..."
            wget --no-check-certificate "$ARP_URL" -O "$ARP_TAR" || exit 1
            tar -xf "$ARP_TAR" || exit 1
            rm -f "$ARP_TAR"
            
            # ÊâæÂá∫Ëß£Â£ìÂæåÁöÑÁõÆÈåÑÂêçÁ®±
            ARP_SRC_NAME=$(ls -d arptables-0*/ | head -n 1 | sed 's/\///')
            echo "   Detected source: [$ARP_SRC_NAME]"
            chmod -R u+w "$ARP_SRC_NAME"
          
            echo "üîß Creating Arptables Wrapper Makefile..."
            
            # Âª∫Á´ãÂ§ñÂ±§ MakefileÔºåËÆìÁ∑®Ë≠ØÁ≥ªÁµ±Áü•ÈÅìÂ¶Ç‰ΩïÁ∑®Ë≠ØÂÆÉ
            cat << EOF > Makefile
          SRC_NAME=$ARP_SRC_NAME
          
          all:
          	\$(MAKE) -C \$(SRC_NAME) \
          		CC="\$(CC)" \
          		AR="\$(AR)" \
          		KERNEL_DIR=\$(KERNEL_HEADERS_PATH) \
          		COPT_FLAGS="-Os -static" \
          		LDFLAGS="-static" \
          		arptables-legacy
          
          romfs:
          	\$(ROMFSINST) \$(SRC_NAME)/arptables-legacy /bin/arptables
          
          clean:
          	\$(MAKE) -C \$(SRC_NAME) clean
          EOF
          
            echo "üîß Registering arptables in trunk/user/Makefile..."
            cd "$BASE_DIR" || exit 1
            
            # Â∞á arptables Âä†ÂÖ•Á∑®Ë≠ØÂàóË°®
            # ÈÇèËºØÔºöÂ¶ÇÊûúÂú® Makefile Ë£°ÈÇÑÊ≤íÁúãÂà∞ arptablesÔºåÂ∞±Âä†ÈÄ≤Âéª
            if ! grep -q "dir_y += arptables" Makefile; then
                # ÂòóË©¶Âä†Âú® ebtables ÂæåÈù¢Ôºå‰øùÊåÅÊï¥ÈΩä
                if grep -q "dir_y += ebtables" Makefile; then
                    sed -i '/dir_y += ebtables/a dir_y += arptables' Makefile
                else
                    # Êâæ‰∏çÂà∞ ebtables Â∞±Âä†Âú®Ê™îÊ°àÊúÄÂæå
                    echo "dir_y += arptables" >> Makefile
                fi
                echo "   ‚úÖ Added to compilation list."
            else
                echo "   ‚ö†Ô∏è Already in compilation list."
            fi
            
          else
            echo "‚ö†Ô∏è Arptables seems already configured. Skipping."
          fi

          # ========================================
          # 2. Ê†∏ÂøÉÊîØÊè¥ (Á©∂Ê•µÂö¥Ë¨π Kernel Config)
          # ========================================
          echo "üîß Deep-Cleaning & Enabling Kernel modules..."
          cd "$GITHUB_WORKSPACE"
          TARGET_KCONF="padavan-ng/trunk/linux-3.4.x/.config"
          
          if [ -f "$TARGET_KCONF" ]; then
             MODULES="CONFIG_IP_NF_ARPTABLES CONFIG_IP_NF_ARPFILTER CONFIG_IP_NF_ARP_MANGLE CONFIG_NF_LOG_ARP CONFIG_BRIDGE_EBT_ARP CONFIG_BRIDGE_EBT_ARPREPLY"
             for mod in $MODULES; do
                if grep -q "$mod" "$TARGET_KCONF"; then
                   sed -i "s|^.*$mod.*$|$mod=m|" "$TARGET_KCONF"
                   echo "   ‚úÖ Forced $mod=m (Updated)"
                else
                   echo "$mod=m" >> "$TARGET_KCONF"
                   echo "   ‚úÖ Forced $mod=m (Added)"
                fi
             done
          fi
          
          echo "::endgroup::"

          # 7.7 [È©ÖÂãïÈ≠îÊîπ] ÈõôÈáçÈéñÂÆöÔºö‰øÆÂæ© Beacon Ë∂ÖÊôÇ + Èò≤Ê≠¢ Peer Ë∏¢Èô§ÂæåÂ§±ÊÜ∂ (Â¢ûÂº∑Áâà)
      - name: üî• Patch MT7610E Driver (Anti-Disconnect & Fast Reconnect)
        run: |
          echo "::group::Applying Ultimate Driver Patch"
          
          # 1. Á≤æÊ∫ñÊêúÂ∞ãÁõÆÊ®ôÊ™îÊ°à
          # ---------------------------------------------------
          # ÊêúÂ∞ã mt7610 ÁõÆÈåÑ‰∏ãÁöÑ ap_apcli.c (BeaconÊéßÂà∂)
          TARGET_APCLI=$(find padavan-ng/trunk/proprietary/rt_wifi/rtpci/3.0.X.X -type f -name "ap_apcli.c" | grep "mt7610" | head -n 1)
          
          # ÊêúÂ∞ã mt7610 ÁõÆÈåÑ‰∏ãÁöÑ apcli_ctrl.c (ÈÄ£Á∑öÊéßÂà∂)
          # Ê≥®ÊÑèÔºöÁõ¥Êé•ÊêúÂ∞ãÊ™îÊ°àÔºå‰∏ç‰æùË≥¥ dirname Êé®ÁÆó
          TARGET_CTRL=$(find padavan-ng/trunk/proprietary/rt_wifi/rtpci/3.0.X.X -type f -name "apcli_ctrl.c" | grep "mt7610" | head -n 1)

          if [ -f "$TARGET_APCLI" ] && [ -f "$TARGET_CTRL" ]; then
            echo "‚úÖ ÊâæÂà∞È©ÖÂãïÊ†∏ÂøÉÊ™îÊ°àÔºö"
            echo "   - BeaconÊéßÂà∂: $TARGET_APCLI"
            echo "   - ÈÄ£Á∑öÊéßÂà∂:   $TARGET_CTRL"
          else
            echo "::error:: ‚ùå Êâæ‰∏çÂà∞È©ÖÂãïÊ™îÊ°àÔºÅË´ãÊ™¢Êü•Ë∑ØÂæë„ÄÇ"
            exit 1
          fi

          # 2. ‰øÆÂæ© Beacon Ë∂ÖÊôÇ (Á∂≠ÊåÅÂéüÈÇèËºØ)
          # ---------------------------------------------------
          echo "üîß Patching Beacon Timeout..."
          cp "$TARGET_APCLI" "${TARGET_APCLI}.bak"
          
          # Â∞á 12 * OS_HZ ÊîπÁÇ∫ 60 * OS_HZ
          sed -i 's/12[[:space:]]*\*[[:space:]]*OS_HZ/60 * OS_HZ/g' "$TARGET_APCLI"
          
          if grep -q "60 \* OS_HZ" "$TARGET_APCLI"; then
             echo "   ‚úÖ Beacon Timeout patch applied."
          else
             echo "::error:: ‚ùå Beacon patch failed. (Pattern not found)"
             exit 1
          fi

          # 3. ‰øÆÂæ© Peer Disconnect (ÊÆ≠Â±çÈáçÈÄ£Ê®°Âºè)
          # ---------------------------------------------------
          echo "üîß Patching Peer Disconnect Logic..."
          cp "$TARGET_CTRL" "${TARGET_CTRL}.bak"
          
          # ‰ΩøÁî® sed Ë®ªËß£ÊéâÊ∏ÖÈô§ SSID/BSSID ÁöÑ‰ª£Á¢º
          # ‰ΩøÁî® [[:space:]]* ÂøΩÁï•Á©∫Ê†º/TabÂ∑ÆÁï∞Ôºå‰∏¶ÂåπÈÖç NdisZeroMemory
          
          # A. Á¶ÅÊ≠¢Ê∏ÖÈô§ BSSID
          sed -i 's/^[[:space:]]*NdisZeroMemory.*ApCliMlmeAux.Bssid/\/\/&/' "$TARGET_CTRL"
          
          # B. Á¶ÅÊ≠¢Ê∏ÖÈô§ SSID Èï∑Â∫¶
          sed -i 's/^[[:space:]]*.*ApCliMlmeAux.SsidLen[[:space:]]*=[[:space:]]*0/\/\/&/' "$TARGET_CTRL"
          
          # C. Á¶ÅÊ≠¢Ê∏ÖÈô§ SSID Â≠ó‰∏≤
          sed -i 's/^[[:space:]]*NdisZeroMemory.*ApCliMlmeAux.Ssid,/\/\/&/' "$TARGET_CTRL"
          
          # D. Á¶ÅÊ≠¢Ê∏ÖÈô§ RSSI
          sed -i 's/^[[:space:]]*.*ApCliMlmeAux.Rssi[[:space:]]*=[[:space:]]*0/\/\/&/' "$TARGET_CTRL"

          # 4. È©óË≠â‰øÆÂæ©ÁµêÊûú
          # ---------------------------------------------------
          echo "üîç Verifying apcli_ctrl.c changes..."
          
          # Ê™¢Êü•ÊòØÂê¶Êúâ‰ªª‰Ωï‰∏ÄË°åË¢´Ë®ªËß£Êéâ (Âê´Êúâ //NdisZeroMemory...ApCliMlmeAux)
          if grep -q "//.*NdisZeroMemory.*ApCliMlmeAux" "$TARGET_CTRL"; then
             echo "üéâ Ultimate Fix Applied! (Fast Reconnect Mode Enabled)"
             echo "--------------------------------------"
             # È°ØÁ§∫‰øÆÊîπÂæåÁöÑÈóúÈçµÁâáÊÆµ‰æõÁ¢∫Ë™ç
             grep -n "//.*NdisZeroMemory" "$TARGET_CTRL" | head -n 5
             echo "--------------------------------------"
          else
             echo "::error:: ‚ùå apcli_ctrl.c patch failed!"
             echo "DEBUG: ÂéüÂßãÊ™îÊ°àÂÖßÂÆπÁâáÊÆµ (‰æõÊ™¢Êü•):"
             grep -C 2 "ApCliMlmeAux.Bssid" "$TARGET_CTRL" | head -n 10
             exit 1
          fi
          
          echo "::endgroup::"

      # 8. ÈñãÂßãÁ∑®Ë≠Ø
      - name: Build firmware
        run: |
          echo "::group::Build Process"
          cp build.config padavan-ng/trunk/.config
          cd padavan-ng/trunk
          
          ./clear_tree.sh > /dev/null 2>&1
          rm -rf tmp staging
          
          echo "Starting build... Logs will be saved to build.log"
          set -o pipefail
          ./build_firmware.sh 2>&1 | tee build.log
          echo "::endgroup::"

      # 9. Êô∫ÊÖßÊâìÂåÖËàáÁî¢Áâ©ÂÅµÊ∏¨ (Âê´ iptables Debug Ê™îÊ°à)
      - name: Smart-Pack & Debug Collection
        run: |
          echo "::group::Smart Packing"
          
          # 0. ËºâÂÖ•Á∑®Ë≠ØÂæåÁöÑËÆäÊï∏ (‰øÆÂæ© Partition Check Ë≠¶Âëä)
          if [ -f "padavan-ng/trunk/.config" ]; then
            source "padavan-ng/trunk/.config"
          fi

          # 1. ÂÆöÁæ©ÁµïÂ∞çË∑ØÂæë
          WORK_DIR=$(pwd)
          PACK_DIR="$WORK_DIR/output_pack"
          IMAGES_DIR="$WORK_DIR/padavan-ng/trunk/images"
          PARTITIONS_FILE="$WORK_DIR/padavan-ng/trunk/configs/boards/$CONFIG_VENDOR/$CONFIG_FIRMWARE_PRODUCT_ID/partitions.config"
          
          mkdir -p "$PACK_DIR"
          
          # ÂàùÂßãÂåñÂ†±Âëä
          REPORT_FILE="$PACK_DIR/file_report.txt"
          touch "$REPORT_FILE"
          
          echo "Packing Artifacts to: $PACK_DIR"
          
          # 2. ÂÇô‰ªΩÈóúÈçµÈÖçÁΩÆÊ™î
          echo "Collecting Debug Configurations..."
          [ -f "padavan-ng/trunk/.config" ] && cp "padavan-ng/trunk/.config" "$PACK_DIR/build.config"
          [ -f "padavan-ng/trunk/configs/boards/busybox.config" ] && cp "padavan-ng/trunk/configs/boards/busybox.config" "$PACK_DIR/busybox.config"
          [ -f "padavan-ng/trunk/user/shared/defaults.h" ] && cp "padavan-ng/trunk/user/shared/defaults.h" "$PACK_DIR/defaults.h.txt"
          [ -f "padavan-ng/trunk/user/www/dict/CN.dict" ] && cp "padavan-ng/trunk/user/www/dict/CN.dict" "$PACK_DIR/CN.dict.txt"
          [ -f "padavan-ng/trunk/linux-3.4.x/.config" ] && cp "padavan-ng/trunk/linux-3.4.x/.config" "$PACK_DIR/kernel.config"
          [ -f "padavan-ng/trunk/build.log" ] && cp "padavan-ng/trunk/build.log" "$PACK_DIR/build.log"

          # =======================================================
          # üî• [NEW] Êî∂ÈõÜ BusyBox Patches (CVE Debug)
          # =======================================================
          BB_SRC_DIR="padavan-ng/trunk/user/busybox/busybox-1.37.0"
          DEBUG_BB_DIR="$PACK_DIR/debug_busybox"
          mkdir -p "$DEBUG_BB_DIR"

          # Ê™¢Êü• Phase 7 Âª∫Á´ãÁöÑ patches ÁõÆÈåÑÊòØÂê¶Â≠òÂú®
          if [ -d "$BB_SRC_DIR/patches" ]; then
              echo "‚úÖ Found BusyBox patches directory, collecting..."
              cp "$BB_SRC_DIR/patches"/*.patch "$DEBUG_BB_DIR/" 2>/dev/null || true
              echo "- üõ°Ô∏è **BusyBox Patches**: Collected in \`debug_busybox\`" >> "$REPORT_FILE"
              
              # È°çÂ§ñÊî∂ÈõÜ: BusyBox ÁöÑÂØ¶ÈöõÁ∑®Ë≠Ø .config (Á¢∫Ë™ç CVE Á∑®Ë≠ØÈÅ∏È†Ö)
              if [ -f "$BB_SRC_DIR/.config" ]; then
                  cp "$BB_SRC_DIR/.config" "$DEBUG_BB_DIR/busybox_actual_build.config"
              fi
          else
              echo "‚ö†Ô∏è Warning: BusyBox patches directory not found (Phase 7 issue?)."
              echo "- ‚ö†Ô∏è **BusyBox Patches**: Not found" >> "$REPORT_FILE"
          fi

          # =======================================================
          # üî• Âº∑ÂåñÔºöÊî∂ÈõÜ iptables Áõ∏ÈóúÁî¢Áâ© (Êô∫ÊÖßÈ©óË≠âÁâà)
          # =======================================================
          IPT_SRC_DIR="padavan-ng/trunk/user/iptables/iptables-1.8.11"
          IPT_BASE_DIR="padavan-ng/trunk/user/iptables"
          DEBUG_DIR="$PACK_DIR/debug_iptables"
          
          mkdir -p "$DEBUG_DIR"
          
          # 2.1 Êî∂ÈõÜ Patch Ê™îÊ°à
          if [ -d "$IPT_BASE_DIR/patches_archive" ]; then
              cp "$IPT_BASE_DIR/patches_archive"/*.patch "$DEBUG_DIR/"
              echo "- üõ°Ô∏è **Patches**: All patches collected in debug_iptables" >> "$REPORT_FILE"
          else
              echo "‚ö†Ô∏è Warning: patches directory not found in $IPT_BASE_DIR"
              echo "- ‚ö†Ô∏è **Patches**: Not found (Collection failed)" >> "$REPORT_FILE"
          fi
          
          # 2.2 Êî∂ÈõÜ Patch ÈÅéÁ®ãÊó•Ë™å (ÈùûÂ∏∏ÈáçË¶Å!)
          if [ -f "$IPT_BASE_DIR/patch_summary.log" ]; then
              cp "$IPT_BASE_DIR/patch_summary.log" "$DEBUG_DIR/patch_summary.log"
              echo "- üìú **Patch Log**: Included" >> "$REPORT_FILE"
          fi

          # 2.3 Êô∫ÊÖßË§áË£Ω xtables.c (Ê†πÊìöÂÖßÂÆπÊ±∫ÂÆöÊ™îÂêç)
          TARGET_FILE="$IPT_SRC_DIR/libxtables/xtables.c"
          
          if [ -f "$TARGET_FILE" ]; then
              # Ê™¢Êü•ÊòØÂê¶Âê´ÊúâÊàëÂÄë Patch #100 ÁöÑÁâπÂæµÁ¢º (Â±èËîΩË≠¶ÂëäÁöÑ if 0)
              if grep -q "#if 0" "$TARGET_FILE" && grep -q "Warning: Extension %s is not supported" "$TARGET_FILE"; then
                  # Âà§ÂÆöÁÇ∫Â∑≤ Patch
                  cp "$TARGET_FILE" "$DEBUG_DIR/xtables_patched.c"
                  echo "‚úÖ Detected PATCHED xtables.c - Saving as xtables_patched.c"
                  echo "- üìÑ **Source**: \`xtables_patched.c\` (‚úÖ Patched successfully)" >> "$REPORT_FILE"
              else
                  # Âà§ÂÆöÁÇ∫Êú™ Patch (ÂéüÁâàÊàñ Patch Â§±Êïó)
                  cp "$TARGET_FILE" "$DEBUG_DIR/xtables_original.c"
                  echo "‚ÑπÔ∏è Detected UNPATCHED xtables.c - Saving as xtables_original.c"
                  echo "- üìÑ **Source**: \`xtables_original.c\` (‚ö†Ô∏è Original/Unpatched)" >> "$REPORT_FILE"
              fi
          else
               echo "‚ö†Ô∏è Warning: xtables.c not found (Maybe build failed or path differs)"
               echo "- ‚ùå **Source**: xtables.c not found!" >> "$REPORT_FILE"
          fi
          
          # 2.4 È°çÂ§ñÊî∂ÈõÜ config.log (ÈÄôÂ∞çÁ∑®Ë≠ØÂ§±ÊïóÈô§ÈåØÈùûÂ∏∏ÊúâÁî®)
          if [ -f "$IPT_SRC_DIR/config.log" ]; then
              cp "$IPT_SRC_DIR/config.log" "$DEBUG_DIR/config.log"
              echo "- üîß **Log**: \`config.log\` included" >> "$REPORT_FILE"
          fi
          # =======================================================

          # 3. ÊäìÂèñÈüåÈ´îÁî¢Áâ©‰∏¶Á´ãÂç≥Ê™¢Êü•Â§ßÂ∞è
          if [ -d "$IMAGES_DIR" ]; then
            echo "Scanning $IMAGES_DIR for images..."
            
            # ËÆÄÂèñÂàÜÂçÄ‰∏äÈôê
            if [ -f "$PARTITIONS_FILE" ]; then
              MAX_FW_SIZE="$(awk '/Firmware/ { getline; getline; sub(",", ""); print strtonum($2); }' "$PARTITIONS_FILE")"
              echo "Max Firmware Size Allowed: $MAX_FW_SIZE bytes"
            else
              MAX_FW_SIZE=0
              echo "::warning:: Partition config not found, skipping size check."
            fi

            # Â∞ãÊâæÊâÄÊúâÁî¢Áâ©
            find "$IMAGES_DIR" -maxdepth 1 -type f \( -name "*.trx" -o -name "*.bin" \) | while read -r file; do
              fname=$(basename "$file")
              fsize=$(stat -c %s "$file")
              
              cp -v "$file" "$PACK_DIR/"
              
              if (( fsize < 500000 )); then
                echo "- üì¶ **U-Boot**: \`$fname\` ($(numfmt --to=iec $fsize))" >> "$REPORT_FILE"
              else
                echo "- üíø **Firmware**: \`$fname\` ($(numfmt --to=iec $fsize))" >> "$REPORT_FILE"
                
                if (( MAX_FW_SIZE > 0 )); then
                  if (( fsize > MAX_FW_SIZE )); then
                    echo "::error:: Firmware $fname ($fsize bytes) exceeds max size ($MAX_FW_SIZE bytes)!"
                    exit 1
                  else
                    echo "::notice:: $fname size check passed ($fsize / $MAX_FW_SIZE)"
                  fi
                fi
              fi
            done
          else
            echo "::warning:: Images directory not found. Build might have failed completely."
            echo "- ‚ùå **Error**: No images directory found." >> "$REPORT_FILE"
          fi

          # 4. ÁîüÊàê MD5 (‰øÆÂæ©ÔºöÂè™Â∞çÊ™îÊ°àÁîüÊàêÔºåÈÅøÈñãË≥áÊñôÂ§æ)
          cd "$PACK_DIR"
          for f in *; do
            if [ -f "$f" ]; then
              md5sum "$f" >> md5sum.txt
            fi
          done
          
          # ËÆÄÂèñÂ†±Âëä‰æõ Release ‰ΩøÁî®
          FILE_REPORT_CONTENT=$(cat file_report.txt)
          {
            echo "FILE_REPORT<<EOF"
            echo "$FILE_REPORT_CONTENT"
            echo "EOF"
          } >> $GITHUB_ENV
          
          # ÊâæÂá∫ÊúÄÂ§ßÁöÑÈüåÈ´îÊ™îÊ°à (ÊéíÈô§ uboot) 
          MAIN_FW=$(find . -type f \( -name "*.trx" -o -name "*.bin" \) -printf "%s\t%p\n" | sort -n | tail -1 | cut -f2)
          [ ! -z "$MAIN_FW" ] && echo "MAIN_FW_PATH=$PACK_DIR/${MAIN_FW#./}" >> $GITHUB_ENV
          
          cd "$WORK_DIR"

          # 5. ÊâìÂåÖ Zip
          if [ "$(ls -A $PACK_DIR)" ]; then
            ZIP_NAME="padavan_pack_${CONFIG_VENDOR}_${CONFIG_FIRMWARE_PRODUCT_ID}.zip"
            zip -j -r "$ZIP_NAME" "$PACK_DIR"
            echo "ZIP_FILE_PATH=$WORK_DIR/$ZIP_NAME" >> $GITHUB_ENV
          else
            echo "::error:: output_pack is empty!"
            exit 1
          fi
          
          echo "BUILD_TIMESTAMP=$(TZ='Asia/Taipei' date '+%Y.%m.%d_%H.%M.%S')" >> $GITHUB_ENV
          echo "CONFIG_VENDOR=$CONFIG_VENDOR" >> $GITHUB_ENV
          echo "CONFIG_FIRMWARE_PRODUCT_ID=$CONFIG_FIRMWARE_PRODUCT_ID" >> $GITHUB_ENV
          echo "::endgroup::"

      - name: Upload artifacts (ZIP)
        uses: actions/upload-artifact@v4
        with:
          name: padavan_${{ env.CONFIG_VENDOR }}_${{ env.CONFIG_FIRMWARE_PRODUCT_ID }}_${{ env.BUILD_TIMESTAMP }}
          path: ${{ env.ZIP_FILE_PATH }}

      # 10. ÁôºÂ∏É Release
      - name: Set Release Tag
        if: github.event_name == 'workflow_dispatch'
        run: |
          echo "TAG_NAME=${{ inputs.target_select }}-${{ env.BUILD_TIMESTAMP }}" >> $GITHUB_ENV

      - name: Publish Release
        if: github.event_name == 'workflow_dispatch'
        uses: ncipollo/release-action@v1
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit: ${{ github.sha }}
          tag: ${{ env.TAG_NAME }}
          name: ${{ inputs.target_select }} [${{ env.BUILD_TIMESTAMP }}]
          body: |
            **Padavan Á∑®Ë≠ØÂ†±Âëä (Early Check)**
            * **Ê©üÂûã**: ${{ inputs.target_select }}
            * **ÊôÇÈñì**: ${{ env.BUILD_TIME }} (Taipei Time)
            * **User**: ${{ env.SIGNACCOUNT }} / **Pass**: ${{ env.SIGNPASSWORD }}
            * **WiFi**: ${{ env.WIFI2GSSID }} / ${{ env.WIFI5GSSID }}
            
            ### üì¶ Áî¢Áâ©ÂÅµÊ∏¨
            ${{ env.FILE_REPORT }}
            
            ### üõ† Debug Ê™îÊ°à (Â∑≤ÂåÖÂê´Âú® Zip)
            * `defaults.h.txt` (Ê™¢Êü• IP/Â∏≥ÂØÜ ÊòØÂê¶‰øÆÊîπÊàêÂäü)
            * `CN.dict.txt` (Ê™¢Êü•Ë™ûË®ÄÊ™î)
            * `build.log` (Á∑®Ë≠ØÊó•Ë™å)
            * `build.config` (Á∑®Ë≠ØÂèÉÊï∏)
            * `kernel.config` (Ê†∏ÂøÉÂèÉÊï∏)
          artifacts: ${{ env.ZIP_FILE_PATH }}
          allowUpdates: true
          artifactErrorsFailBuild: true
