name: Build firmware (Ultimate Fix - Final)

permissions:
  contents: write

on:
  workflow_dispatch:
    inputs:
      target_select:
        description: "é¸æ“‡æ©Ÿå‹ (Target Model)"
        required: true
        default: 'TL_C2-V1'
        type: choice
        options:
          - TL_C2-V1
      
      nanoversion:
        description: "é–‹å•Ÿæ¥µé™ç˜¦èº« (Nano Optimization)"
        type: boolean
        default: false

      customization:
        description: 'è‡ªå®šç¾©é…ç½® JSON (Wi-Fi/å¯†ç¢¼/IP)'
        required: true
        type: string
        default: '{"lanip":"192.168.1.1","signaccount":"admin","signpassword":"admin","wifi2gssid":"Padavan","wifi2gpsk":"1234567890","wifi5gssid":"Padavan-5G","wifi5gpsk":"1234567890"}'

  push:
    tags:
      - '*'

jobs:
  build:
    runs-on: ubuntu-latest
    container: registry.gitlab.com/hadzhioglu/padavan-ng
    defaults: { run: { shell: bash } }
    
    steps:
    - name: Checkout Workflow
      uses: actions/checkout@v4

    # 0. ç’°å¢ƒåˆæª¢ & è·¯å¾‘é–å®š (The Anchor)
    - name: Debug - Initial Environment Check
      run: |
        echo "::group::System Info"
        echo "User: $(whoami)"
        # é–å®šå·¥ä½œå€æ ¹ç›®éŒ„ï¼Œé€™æ˜¯æˆ‘å€‘çš„ã€Œå®¶ã€
        WORKSPACE_ROOT=$(pwd)
        echo "WORKSPACE_ROOT=$WORKSPACE_ROOT" >> $GITHUB_ENV
        echo "Root Path: $WORKSPACE_ROOT"
        df -h
        echo "::endgroup::"

    # 1. å®‰è£ä¾è³´
    - name: Install Dependencies & Fix Timezone
      run: |
        echo "::group::Apt Update & Install"
        set -x 
        apt-get update
        DEBIAN_FRONTEND=noninteractive apt-get install -y tzdata autoconf autoconf-archive automake autopoint bison build-essential \
        ca-certificates cmake cpio curl dos2unix doxygen fakeroot flex gawk gettext git gperf \
        help2man htop kmod libarchive-tools libblkid-dev libc-ares-dev libcurl4-openssl-dev \
        libdevmapper-dev libev-dev libevent-dev libexif-dev libflac-dev libgmp3-dev \
        libid3tag0-dev libidn2-dev libjpeg-dev libkeyutils-dev libltdl-dev libmpc-dev \
        libmpfr-dev libncurses5-dev libogg-dev libsqlite3-dev libssl-dev libsystemd-dev \
        libtool libtool-bin libudev-dev libunbound-dev libvorbis-dev libxml2-dev locales \
        mc nano pkg-config ppp-dev python3 python3-docutils sshpass texinfo unzip uuid \
        uuid-dev vim wget xxd zlib1g-dev jq zip
        set +x
        echo "::endgroup::"

        echo "::group::Timezone Configuration"
        ln -fs /usr/share/zoneinfo/Asia/Taipei /etc/localtime
        dpkg-reconfigure -f noninteractive tzdata
        echo "BUILD_TIME=$(date +%Y%m%d-%H%M)" >> $GITHUB_ENV
        echo "::endgroup::"

    # 2. è¨­å®šè®Šæ•¸
    - name: Get variables
      run: |
        echo "::group::Variable Loading"
        if [ -f "variables" ]; then
            sed -i 's|\r$||g' variables
            . variables
        fi
        
        echo "PADAVAN_REPO=https://github.com/TWShiyuLiou1997/padavan-ng" >> $GITHUB_ENV
        echo "PADAVAN_BRANCH=master" >> $GITHUB_ENV
        echo "PADAVAN_COMMIT=HEAD" >> $GITHUB_ENV
        
        if [ -z "$PADAVAN_THEMES_REPO" ]; then
             echo "PADAVAN_THEMES_REPO=https://gitlab.com/hadzhioglu/padavan-themes.git" >> $GITHUB_ENV
             echo "PADAVAN_THEMES_BRANCH=main" >> $GITHUB_ENV
        fi
        
        for v in "${!PADAVAN_@}" "${!CONFIG_@}"; do
          echo "$v=${!v}" >> $GITHUB_ENV
        done
        echo "::endgroup::"

    # 3. ä¸‹è¼‰æºç¢¼
    - name: Download sources and toolchain
      run: |
        echo "::group::Git Clone"
        git config --global --add safe.directory '*'
        git clone -b "$PADAVAN_BRANCH" "$PADAVAN_REPO"
        if [ "$PADAVAN_COMMIT" != "HEAD" ] && [ ! -z "$PADAVAN_COMMIT" ]; then
             git -C padavan-ng checkout "$PADAVAN_COMMIT"
        fi
        wget -qO- "$PADAVAN_TOOLCHAIN_URL" | tar -C padavan-ng --zstd -xf -
        echo "::endgroup::"

    # 4. ç”Ÿæˆ Config (é‚è¼¯æ ¸å¿ƒï¼šç›´æ¥ç”Ÿæˆæœ€çµ‚æª”æ¡ˆåˆ°æ ¹ç›®éŒ„)
    - name: Prepare Template & Apply Nano
      run: |
        TNAME="${{ inputs.target_select }}"
        [ -z "$TNAME" ] && TNAME="TL_C2-V1"
        echo "::group::Template Search"
        
        # ä½¿ç”¨çµ•å°è·¯å¾‘
        TEMPLATE_DIR="${{ env.WORKSPACE_ROOT }}/padavan-ng/trunk/configs/templates"
        PATTERN_A=$(echo "$TNAME" | sed 's/-/_/g')
        PATTERN_B=$(echo "$TNAME")
        
        TARGET_FILE=$(find "$TEMPLATE_DIR" -maxdepth 2 \( -iname "${PATTERN_A}.config" -o -iname "${PATTERN_B}.config" \) | head -n 1)
        
        if [ -z "$TARGET_FILE" ]; then
             echo "::warning:: Template not found, using fallback..."
             TARGET_FILE="${{ env.WORKSPACE_ROOT }}/padavan-ng/trunk/configs/templates/tplink/tl_c2-v1.config"
        fi
        
        if [ ! -f "$TARGET_FILE" ]; then
             echo "::error:: Config file not found: $TARGET_FILE"
             exit 1
        fi
        
        # é—œéµå‹•ä½œ 1ï¼šç›´æ¥æŠŠæ¨¡æ¿è¤‡è£½åˆ°ã€Œå®¶é–€å£ã€ (æ ¹ç›®éŒ„ä¸‹çš„ build.config)
        # é€™æ¨£ä»¥å¾Œæˆ‘å€‘åªèªé€™å€‹æª”æ¡ˆï¼Œä¸å†å»ç®¡é‚£æ·±å±¤çš„è·¯å¾‘äº†
        FINAL_CONFIG="${{ env.WORKSPACE_ROOT }}/build.config"
        cp -f "$TARGET_FILE" "$FINAL_CONFIG"
        
        echo "Template copied to: $FINAL_CONFIG"
        echo "::endgroup::"
        
        # é—œéµå‹•ä½œ 2ï¼šæ‰€æœ‰çš„ä¿®æ”¹ç›´æ¥é‡å°é€™å€‹ã€Œå®¶é–€å£ã€çš„æª”æ¡ˆ
        if [ "${{ inputs.nanoversion }}" == "true" ]; then
             echo "::group::Nano Optimization"
             for fs in ANTFS FAT EXFAT EXT2 EXT3 EXT4 XFS FUSE SWAP; do
               sed -i "s/CONFIG_FIRMWARE_ENABLE_${fs}=y/CONFIG_FIRMWARE_ENABLE_${fs}=n/gi" "$FINAL_CONFIG"
             done
             modules=(UVC HID SERIAL AUDIO XFRM IMQ IFB NFSD NFSC CIFS NTFS_3G LPRD U2EC HDPARM PARTED SMBD WINS SMBD_SYSLOG FTPD RPL2TP EAP_PEAP DROPBEAR DROPBEAR_FAST_CODE OPENVPN SSWAN XUPNPD MINIDLNA FIREFLY FFMPEG_NEW TRANSMISSION TRANSMISSION_WEB_CONTROL ARIA QOS ARIA_WEB_CONTROL SCUTCLIENT GDUT_DRCOM DOGCOM MINIEAP NJIT_CLIENT SOFTETHERVPN_SERVER SOFTETHERVPN_CLIENT SOFTETHERVPN_CMD VLMCSD TTYD MSD_LITE LRZSZ HTOP NANO IPERF3 DUMP1090 RTL_SDR MTR SOCAT SRELAY MENTOHUST FRPC FRPS REDSOCKS SHADOWSOCKS XRAY V2RAY TROJAN SSOBFS SINGBOX NAIVEPROXY ADBYBY DNSFORWARDER SMARTDNS ADGUARDHOME ZEROTIER ALIDDNS DDNSTO ALDRIVER SQM WIREGUARD)
             for mod in "${modules[@]}"; do
               sed -i "s/CONFIG_FIRMWARE_INCLUDE_${mod}=y/CONFIG_FIRMWARE_INCLUDE_${mod}=n/g" "$FINAL_CONFIG"
             done
             echo "::endgroup::"
        fi
        
        echo "::group::Core Modules Enforcement"
        keep_modules=(OPENSSH SFTP TCPDUMP CURL HTTPS OPENSSL_EC OPENSSL_EXE)
        for kmod in "${keep_modules[@]}"; do
             sed -i "/CONFIG_FIRMWARE_INCLUDE_${kmod}/d" "$FINAL_CONFIG"
             echo "CONFIG_FIRMWARE_INCLUDE_${kmod}=y" >> "$FINAL_CONFIG"
        done
        echo "::endgroup::"

    # 5. æ‡‰ç”¨è‡ªå®šç¾©è¨­å®š (JSON)
    - name: Apply Custom Settings
      run: |
        echo "::group::JSON Parsing"
        echo '${{ inputs.customization }}' | jq -r 'to_entries[] | "\(.key)=\(.value)"' | while IFS='=' read -r k v; do
           export "${k^^}=$v"
        done
        
        LANIP=$(echo '${{ inputs.customization }}' | jq -r .lanip)
        SIGNACCOUNT=$(echo '${{ inputs.customization }}' | jq -r .signaccount)
        SIGNPASSWORD=$(echo '${{ inputs.customization }}' | jq -r .signpassword)
        WIFI2GSSID=$(echo '${{ inputs.customization }}' | jq -r .wifi2gssid)
        WIFI2GPSK=$(echo '${{ inputs.customization }}' | jq -r .wifi2gpsk)
        WIFI5GSSID=$(echo '${{ inputs.customization }}' | jq -r .wifi5gssid)
        WIFI5GPSK=$(echo '${{ inputs.customization }}' | jq -r .wifi5gpsk)
        
        export LANIP SIGNACCOUNT SIGNPASSWORD WIFI2GSSID WIFI2GPSK WIFI5GSSID WIFI5GPSK
        
        # ä½¿ç”¨çµ•å°è·¯å¾‘
        SCRIPT_DIR="${{ env.WORKSPACE_ROOT }}/padavan-ng/trunk/custom/scripts"
        DEFAULTS_H="${{ env.WORKSPACE_ROOT }}/padavan-ng/trunk/user/shared/defaults.h"
        DICT_CN="${{ env.WORKSPACE_ROOT }}/padavan-ng/trunk/user/www/dict/CN.dict"
        
        if [ -d "$SCRIPT_DIR" ]; then
            chmod +x $SCRIPT_DIR/*.sh
            [ ! -z "$LANIP" ] && bash $SCRIPT_DIR/setip.sh "$LANIP" "$DEFAULTS_H" "$DICT_CN" || true
            [ ! -z "$SIGNACCOUNT" ] && bash $SCRIPT_DIR/setaccount.sh "$SIGNACCOUNT" "$SIGNPASSWORD" "$DEFAULTS_H" || true
            [ ! -z "$WIFI2GSSID" ] && bash $SCRIPT_DIR/setwifi.sh "$WIFI2GSSID" "$WIFI2GPSK" "$WIFI5GSSID" "$WIFI5GPSK" "$DEFAULTS_H" || true
        fi
        echo "::endgroup::"

    # 6. å®‰è£ Themes
    - name: Install themes
      run: |
        echo "::group::Themes Installation"
        if [ -f "variables" ]; then . variables; fi
        if [[ -n "${PADAVAN_THEMES[*]}" ]]; then
          git clone --depth 1 -b "$PADAVAN_THEMES_BRANCH" "$PADAVAN_THEMES_REPO" themes
          cp -r themes/common-theme themes/jquery.js padavan-ng/trunk/user/www/n56u_ribbon_fixed
          for theme in "${PADAVAN_THEMES[@]}"; do
            [ -d "themes/$theme-theme" ] && cp -r "themes/$theme-theme" padavan-ng/trunk/user/www/n56u_ribbon_fixed
          done
        fi
        echo "::endgroup::"

    # 7. ä¿®æ­£ mkimage
    - name: Fix mkimage
      run: |
        MKIMAGE_FILE="padavan-ng/trunk/tools/mkimage/mkimage.c"
        if [ -f "$MKIMAGE_FILE" ]; then
           sed -i 's/"%d\.%d"/"%hhd.%hhd"/g' "$MKIMAGE_FILE"
           sed -i 's/"%d\.%d%c"/"%hhd.%hhd%c"/g' "$MKIMAGE_FILE"
        fi

    # 8. é–‹å§‹ç·¨è­¯ (Late Copy - Simplified)
    - name: Build firmware
      run: |
        echo "::group::Pre-Build Setup"
        
        # é€™è£¡ä¸ç®¡ä¹‹å‰è·¯å¾‘å¦‚ä½•ï¼Œæˆ‘å€‘ç›´æ¥å¼•ç”¨æ ¹ç›®éŒ„ä¸‹çš„é‚£å€‹æª”æ¡ˆ
        FINAL_CONFIG="${{ env.WORKSPACE_ROOT }}/build.config"
        
        # é˜²å‘†æª¢æŸ¥
        if [ ! -f "$FINAL_CONFIG" ]; then
            echo "::error:: Critical: build.config is missing at $FINAL_CONFIG"
            exit 1
        fi
        
        # é€²å…¥ç·¨è­¯ç›®éŒ„
        cd padavan-ng/trunk
        
        # æ¸…ç†
        ./clear_tree.sh > /dev/null 2>&1
        rm -rf tmp staging
        
        echo "Applying config from workspace root..."
        # è¤‡è£½åˆ°ç•¶å‰ç›®éŒ„ (.config)
        cp -f "$FINAL_CONFIG" .config
        
        echo "Config applied. Starting compilation..."
        echo "::endgroup::"
        
        set -o pipefail
        ./build_firmware.sh 2>&1 | tee build.log
        echo "::endgroup::"

    # 9. æ™ºæ…§æ‰“åŒ… (çµ•å°è·¯å¾‘ç‰ˆ)
    - name: Smart-Pack & Debug Collection
      run: |
        echo "::group::Smart Packing"
        
        PACK_DIR="${{ env.WORKSPACE_ROOT }}/output_pack"
        SRC_TRUNK="${{ env.WORKSPACE_ROOT }}/padavan-ng/trunk"
        IMAGES_DIR="${SRC_TRUNK}/images"
        
        mkdir -p "$PACK_DIR"
        REPORT_FILE="$PACK_DIR/file_report.txt"
        touch "$REPORT_FILE"
        
        echo "Collecting Debug Configurations..."
        # é€™è£¡ç›´æ¥æŠ“æ ¹ç›®éŒ„çš„ build.config
        [ -f "${{ env.WORKSPACE_ROOT }}/build.config" ] && cp "${{ env.WORKSPACE_ROOT }}/build.config" "$PACK_DIR/build.config"
        [ -f "${SRC_TRUNK}/user/shared/defaults.h" ] && cp "${SRC_TRUNK}/user/shared/defaults.h" "$PACK_DIR/defaults.h.txt"
        [ -f "${SRC_TRUNK}/user/www/dict/CN.dict" ] && cp "${SRC_TRUNK}/user/www/dict/CN.dict" "$PACK_DIR/CN.dict.txt"
        [ -f "${SRC_TRUNK}/linux-3.4.x/.config" ] && cp "${SRC_TRUNK}/linux-3.4.x/.config" "$PACK_DIR/kernel_actual.config"
        [ -f "${SRC_TRUNK}/build.log" ] && cp "${SRC_TRUNK}/build.log" "$PACK_DIR/build.log"
        
        if [ -d "$IMAGES_DIR" ]; then
             echo "Scanning images..."
             find "$IMAGES_DIR" -maxdepth 1 -type f \( -name "*.trx" -o -name "*.bin" \) | while read -r filepath; do
                 fname=$(basename "$filepath")
                 fsize=$(stat -c %s "$filepath")
                 
                 echo "Found: $fname ($fsize bytes)"
                 cp -v "$filepath" "$PACK_DIR/"
                 
                 if (( fsize < 500000 )); then
                     echo "- ğŸ“¦ **U-Boot**: \`$fname\` ($(numfmt --to=iec $fsize))" >> "$REPORT_FILE"
                 else
                     echo "- ğŸ’¿ **Firmware**: \`$fname\` ($(numfmt --to=iec $fsize))" >> "$REPORT_FILE"
                 fi
             done
        else
             echo "::warning:: Images directory not found."
             echo "- âŒ **Error**: No images directory found." >> "$REPORT_FILE"
        fi

        cd "$PACK_DIR"
        if [ "$(ls -A .)" ]; then
            md5sum * > md5sum.txt
            
            FILE_REPORT_CONTENT=$(cat file_report.txt)
            {
              echo "FILE_REPORT<<EOF"
              echo "$FILE_REPORT_CONTENT"
              echo "EOF"
            } >> $GITHUB_ENV
            
            # æ‰¾å‡ºä¸»éŸŒé«”
            MAIN_FW=$(find "$PACK_DIR" -type f \( -name "*.trx" -o -name "*.bin" \) -printf "%s\t%p\n" | sort -n | tail -1 | cut -f2)
            [ ! -z "$MAIN_FW" ] && echo "MAIN_FW_PATH=$MAIN_FW" >> $GITHUB_ENV
            
            ZIP_NAME="padavan_pack_${CONFIG_VENDOR}_${CONFIG_FIRMWARE_PRODUCT_ID}.zip"
            zip -j -r "$ZIP_NAME" .
            echo "ZIP_FILE_PATH=$PACK_DIR/$ZIP_NAME" >> $GITHUB_ENV
        else
            echo "::error:: output_pack is empty!"
            exit 1
        fi
        
        echo "BUILD_TIMESTAMP=$(TZ='Asia/Taipei' date '+%Y.%m.%d_%H.%M.%S')" >> $GITHUB_ENV
        echo "CONFIG_VENDOR=$CONFIG_VENDOR" >> $GITHUB_ENV
        echo "CONFIG_FIRMWARE_PRODUCT_ID=$CONFIG_FIRMWARE_PRODUCT_ID" >> $GITHUB_ENV
        echo "::endgroup::"

    - name: Upload artifacts (ZIP)
      uses: actions/upload-artifact@v4
      with:
        name: padavan_${{ env.CONFIG_VENDOR }}_${{ env.BUILD_TIMESTAMP }}
        path: ${{ env.ZIP_FILE_PATH }}

    - name: Check firmware size
      run: |
        echo "::group::Size Check"
        FW_FILE="${{ env.MAIN_FW_PATH }}"
        PARTITIONS="${{ env.WORKSPACE_ROOT }}/padavan-ng/trunk/configs/boards/$CONFIG_VENDOR/$CONFIG_FIRMWARE_PRODUCT_ID/partitions.config"
        
        if [ -f "$PARTITIONS" ] && [ -f "$FW_FILE" ]; then
           max_fw_size="$(awk '/Firmware/ { getline; getline; sub(",", ""); print strtonum($2); }' "$PARTITIONS")"
           fw_size="$(stat -c %s "$FW_FILE")"
           
           echo "Checking file: $FW_FILE"
           echo "Current Size: $fw_size bytes"
           echo "Max Size: $max_fw_size bytes"
           
           if ((fw_size > max_fw_size)); then
             echo "::error:: Firmware too large! $fw_size > $max_fw_size"
             exit 1
           else
             echo "::notice:: Size check passed."
           fi
        else
           echo "::warning:: Skip size check (file missing or partition config not found)."
        fi
        echo "::endgroup::"

    # 10. ç™¼å¸ƒ Release
    - name: Set Release Tag
      if: github.event_name == 'workflow_dispatch'
      run: |
        echo "TAG_NAME=${{ inputs.target_select }}-${{ env.BUILD_TIMESTAMP }}" >> $GITHUB_ENV

    - name: Publish Release
      if: github.event_name == 'workflow_dispatch'
      uses: ncipollo/release-action@v1
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        commit: ${{ github.sha }}
        tag: ${{ env.TAG_NAME }}
        name: ${{ inputs.target_select }} [${{ env.BUILD_TIMESTAMP }}]
        body: |
          **Padavan ç·¨è­¯å ±å‘Š (Ultimate Fix)**
          * **æ©Ÿå‹**: ${{ inputs.target_select }}
          * **æ™‚é–“**: ${{ env.BUILD_TIME }} (Taipei Time)
          * **User**: ${{ env.SIGNACCOUNT }} / **Pass**: ${{ env.SIGNPASSWORD }}
          * **WiFi**: ${{ env.WIFI2GSSID }} / ${{ env.WIFI5GSSID }}
          
          ### ğŸ“¦ ç”¢ç‰©åµæ¸¬
          ${{ env.FILE_REPORT }}
          
          ### ğŸ›  Debug æª”æ¡ˆ
          * `defaults.h.txt` (æª¢æŸ¥ä¿®æ”¹çµæœ)
          * `build.log` (ç·¨è­¯æ—¥èªŒ)
          * `build.config` (æœ€çµ‚ç·¨è­¯åƒæ•¸)
        artifacts: ${{ env.ZIP_FILE_PATH }}
        allowUpdates: true
        artifactErrorsFailBuild: true
