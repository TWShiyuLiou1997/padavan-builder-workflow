name: Build firmware (Ultimate Fix - Early Size Check)

permissions:
  contents: write

on:
  workflow_dispatch:
    inputs:
      target_select:
        description: "é¸æ“‡æ©Ÿå‹ (Target Model)"
        required: true
        default: 'TL_C2-V1'
        type: choice
        options:
          - TL_C2-V1
      
      nanoversion:
        description: "é–‹å•Ÿæ¥µé™ç˜¦èº« (Nano Optimization)"
        type: boolean
        default: false

      customization:
        description: 'è‡ªå®šç¾©é…ç½® JSON (Wi-Fi/å¯†ç¢¼/IP)'
        required: true
        type: string
        default: '{"lanip":"192.168.0.1","signaccount":"admin","signpassword":"admin","wifi2gssid":"Padavan","wifi2gpsk":"1234567890","wifi5gssid":"Padavan-5G","wifi5gpsk":"1234567890"}'

  push:
    tags:
      - '*'

jobs:
  build:
    runs-on: ubuntu-latest
    container: registry.gitlab.com/hadzhioglu/padavan-ng
    defaults: { run: { shell: bash } }
    
    steps:
      - name: Checkout Workflow
        uses: actions/checkout@v4

      # 0. ç’°å¢ƒåˆæª¢
      - name: Debug - Initial Environment Check
        run: |
          echo "::group::System Info"
          echo "User: $(whoami)"
          echo "PWD: $(pwd)"
          df -h
          echo "::endgroup::"

      # 1. å®‰è£ä¾è³´
      - name: Install Dependencies & Fix Timezone
        run: |
          echo "::group::Apt Update & Install"
          set -x 
          apt-get update
          DEBIAN_FRONTEND=noninteractive apt-get install -y tzdata autoconf autoconf-archive automake autopoint bison build-essential \
          ca-certificates cmake cpio curl dos2unix doxygen fakeroot flex gawk gettext git gperf \
          help2man htop kmod libarchive-tools libblkid-dev libc-ares-dev libcurl4-openssl-dev \
          libdevmapper-dev libev-dev libevent-dev libexif-dev libflac-dev libgmp3-dev \
          libid3tag0-dev libidn2-dev libjpeg-dev libkeyutils-dev libltdl-dev libmpc-dev \
          libmpfr-dev libncurses5-dev libogg-dev libsqlite3-dev libssl-dev libsystemd-dev \
          libtool libtool-bin libudev-dev libunbound-dev libvorbis-dev libxml2-dev locales \
          mc nano pkg-config ppp-dev python3 python3-docutils sshpass texinfo unzip uuid \
          uuid-dev vim wget xxd zlib1g-dev jq zip
          set +x
          echo "::endgroup::"

          echo "::group::Timezone Configuration"
          ln -fs /usr/share/zoneinfo/Asia/Taipei /etc/localtime
          dpkg-reconfigure -f noninteractive tzdata
          echo "BUILD_TIME=$(date +%Y%m%d-%H%M)" >> $GITHUB_ENV
          echo "::endgroup::"

      # 2. è¨­å®šè®Šæ•¸
      - name: Get variables
        run: |
          echo "::group::Variable Loading"
          if [ -f "variables" ]; then
            sed -i 's|\r$||g' variables
            . variables
          fi
          
          echo "PADAVAN_REPO=https://github.com/TWShiyuLiou1997/padavan-ng" >> $GITHUB_ENV
          echo "PADAVAN_BRANCH=master" >> $GITHUB_ENV
          echo "PADAVAN_COMMIT=HEAD" >> $GITHUB_ENV
          
          if [ -z "$PADAVAN_THEMES_REPO" ]; then
            echo "PADAVAN_THEMES_REPO=https://gitlab.com/hadzhioglu/padavan-themes.git" >> $GITHUB_ENV
            echo "PADAVAN_THEMES_BRANCH=main" >> $GITHUB_ENV
          fi
          
          for v in "${!PADAVAN_@}" "${!CONFIG_@}"; do
            echo "$v=${!v}" >> $GITHUB_ENV
          done
          echo "::endgroup::"

      # 3. ä¸‹è¼‰æºç¢¼
      - name: Download sources and toolchain
        run: |
          echo "::group::Git Clone"
          git config --global --add safe.directory '*'
          git clone -b "$PADAVAN_BRANCH" "$PADAVAN_REPO"
          if [ "$PADAVAN_COMMIT" != "HEAD" ] && [ ! -z "$PADAVAN_COMMIT" ]; then
            git -C padavan-ng checkout "$PADAVAN_COMMIT"
          fi
          wget -qO- "$PADAVAN_TOOLCHAIN_URL" | tar -C padavan-ng --zstd -xf -
          echo "::endgroup::"

      # 4. ç”Ÿæˆ Config
      - name: Generate build.config & Apply Nano
        run: |
          TNAME="${{ inputs.target_select }}"
          [ -z "$TNAME" ] && TNAME="TL_C2-V1"
          echo "::group::Template Search & Config Gen"
          
          TEMPLATE_DIR="padavan-ng/trunk/configs/templates"
          PATTERN_A=$(echo "$TNAME" | sed 's/-/_/g')
          PATTERN_B=$(echo "$TNAME")
          TARGET_FILE=$(find "$TEMPLATE_DIR" -maxdepth 2 \( -iname "${PATTERN_A}.config" -o -iname "${PATTERN_B}.config" \) | head -n 1)
          
          if [ -z "$TARGET_FILE" ]; then
            echo "::warning:: Template not found, using fallback..."
            TARGET_FILE="padavan-ng/trunk/configs/templates/tplink/tl_c2-v1.config"
          fi
          
          if [ ! -f "$TARGET_FILE" ]; then
            echo "::error:: Config file not found: $TARGET_FILE"
            exit 1
          fi
          cp -f "$TARGET_FILE" build.config
          FINAL_CONFIG="build.config"
          echo "::endgroup::"
          
          # === æ¥µé™ç˜¦èº«é‚è¼¯ (Ultimate Nano - TC/Cake Ready) ===
          if [ "${{ inputs.nanoversion }}" == "true" ]; then
            echo "::group::Nano Optimization - Final Execution"
         
            # 1. [é«”ç©å„ªåŒ–] å¼·åˆ¶é–‹å•Ÿ Size Optimization
            sed -i "s/#CONFIG_CC_OPTIMIZE_FOR_SIZE=y/CONFIG_CC_OPTIMIZE_FOR_SIZE=y/g" "$FINAL_CONFIG"
         
            # 2. [åŸºç¤åˆ‡é™¤] åœç”¨ USB, æª”æ¡ˆç³»çµ±, Swap, åª’é«”é©…å‹•
            for feat in USB ANTFS FAT EXFAT EXT2 EXT3 EXT4 XFS HFS FUSE SWAP BACKPORTED; do
              sed -i "s/CONFIG_FIRMWARE_ENABLE_${feat}=y/CONFIG_FIRMWARE_ENABLE_${feat}=n/gi" "$FINAL_CONFIG"
            done
         
            # 3. [èªè¨€åŒ…ç²¾æº–æ§åˆ¶] 
            sed -i "s/CONFIG_FIRMWARE_INCLUDE_LANG_EN=n/CONFIG_FIRMWARE_INCLUDE_LANG_EN=y/g" "$FINAL_CONFIG"
            sed -i "s/#CONFIG_FIRMWARE_INCLUDE_LANG_CN=y/CONFIG_FIRMWARE_INCLUDE_LANG_CN=y/g" "$FINAL_CONFIG"
            sed -i "s/CONFIG_FIRMWARE_INCLUDE_LANG_CN=n/CONFIG_FIRMWARE_INCLUDE_LANG_CN=y/g" "$FINAL_CONFIG"
            sed -i "s/CONFIG_FIRMWARE_INCLUDE_LANG_RU=y/CONFIG_FIRMWARE_INCLUDE_LANG_RU=n/g" "$FINAL_CONFIG"
            sed -i "s/CONFIG_FIRMWARE_INCLUDE_LANG_UK=y/CONFIG_FIRMWARE_INCLUDE_LANG_UK=n/g" "$FINAL_CONFIG"
         
            # 4. [åœ°æ¯¯å¼ç§»é™¤] 0% ç–æ¼æ¸…å–®
            modules=(
              CIFS NTFS_3G LPRD U2EC USBIP HDPARM PARTED SMBD WINS SMBD_SYSLOG TESTPARM 
              FTPD FTPD_SSL NFSD NFSC
              UVC HID SERIAL AUDIO FIREFLY XUPNPD MINIDLNA FFMPEG_NEW 
              RPL2TP EAP_PEAP OPENVPN SSWAN WIREGUARD AMNEZIAWG ZEROTIER EOIP XFRM
              SHADOWSOCKS XRAY V2RAY TROJAN SSOBFS SINGBOX NAIVEPROXY
              REDSOCKS SRELAY MENTOHUST FRPC FRPS TOR TOR_GEOIP TOR_GEOIPV6
              PRIVOXY NFQWS
              IPSET DNSCRYPT STUBBY DOH QUIC QUIC_NGTCP2 NDISC6_RDISC6
              ADBYBY DNSFORWARDER SMARTDNS ADGUARDHOME WPAD
              LRZSZ IPERF3 DUMP1090 RTL_SDR SOCAT MTR 
              IMQ IFB
              ZRAM ADB LUA SQM ALDRIVER SCUTCLIENT GDUT_DRCOM DOGCOM MINIEAP 
              NJIT_CLIENT SOFTETHERVPN_SERVER SOFTETHERVPN_CLIENT SOFTETHERVPN_CMD
              DROPBEAR DROPBEAR_FAST_CODE VLMCSD TTYD MSD_LITE
              DDNS_SSL
            )
         
            for mod in "${modules[@]}"; do
              sed -i "s/CONFIG_FIRMWARE_INCLUDE_${mod}=y/CONFIG_FIRMWARE_INCLUDE_${mod}=n/g" "$FINAL_CONFIG"
            done
         
            echo "::endgroup::"
          fi

          echo "::group::Core Modules Enforcement"
          # 5. å¼·åˆ¶ä¿ç•™ä¸¦é–‹å•Ÿçš„æ ¸å¿ƒæ¨¡çµ„
          keep_modules=(OPENSSH SFTP TCPDUMP CURL HTTPS OPENSSL_EC OPENSSL_EXE SHORTCUT_FE QOS)

          for kmod in "${keep_modules[@]}"; do
            sed -i "/CONFIG_FIRMWARE_INCLUDE_${kmod}/d" "$FINAL_CONFIG"
            echo "CONFIG_FIRMWARE_INCLUDE_${kmod}=y" >> "$FINAL_CONFIG"
          done
          echo "::endgroup::"

      # 5. æ‡‰ç”¨è‡ªå®šç¾©è¨­å®š (JSON)
      - name: Apply Custom Settings
        run: |
          echo "::group::JSON Parsing"
          echo '${{ inputs.customization }}' | jq -r 'to_entries[] | "\(.key)=\(.value)"' | while IFS='=' read -r k v; do
            export "${k^^}=$v"
          done
          
          LANIP=$(echo '${{ inputs.customization }}' | jq -r .lanip)
          SIGNACCOUNT=$(echo '${{ inputs.customization }}' | jq -r .signaccount)
          SIGNPASSWORD=$(echo '${{ inputs.customization }}' | jq -r .signpassword)
          WIFI2GSSID=$(echo '${{ inputs.customization }}' | jq -r .wifi2gssid)
          WIFI2GPSK=$(echo '${{ inputs.customization }}' | jq -r .wifi2gpsk)
          WIFI5GSSID=$(echo '${{ inputs.customization }}' | jq -r .wifi5gssid)
          WIFI5GPSK=$(echo '${{ inputs.customization }}' | jq -r .wifi5gpsk)
          
          export LANIP SIGNACCOUNT SIGNPASSWORD WIFI2GSSID WIFI2GPSK WIFI5GSSID WIFI5GPSK
          
          if [ -d "padavan-ng/trunk/custom/scripts" ]; then
            cd padavan-ng
            chmod +x trunk/custom/scripts/*.sh
            [ ! -z "$LANIP" ] && bash trunk/custom/scripts/setip.sh "$LANIP" trunk/user/shared/defaults.h trunk/user/www/dict/CN.dict || true
            [ ! -z "$SIGNACCOUNT" ] && bash trunk/custom/scripts/setaccount.sh "$SIGNACCOUNT" "$SIGNPASSWORD" trunk/user/shared/defaults.h || true
            [ ! -z "$WIFI2GSSID" ] && bash trunk/custom/scripts/setwifi.sh "$WIFI2GSSID" "$WIFI2GPSK" "$WIFI5GSSID" "$WIFI5GPSK" trunk/user/shared/defaults.h || true
          fi
          echo "::endgroup::"

      # 6. å®‰è£ Themes
      - name: Install themes
        run: |
          echo "::group::Themes Installation"
          if [ -f "variables" ]; then . variables; fi
          if [[ -n "${PADAVAN_THEMES[*]}" ]]; then
            git clone --depth 1 -b "$PADAVAN_THEMES_BRANCH" "$PADAVAN_THEMES_REPO" themes
            cp -r themes/common-theme themes/jquery.js padavan-ng/trunk/user/www/n56u_ribbon_fixed
            for theme in "${PADAVAN_THEMES[@]}"; do
              [ -d "themes/$theme-theme" ] && cp -r "themes/$theme-theme" padavan-ng/trunk/user/www/n56u_ribbon_fixed
            done
          fi
          echo "::endgroup::"

      # 7. ä¿®æ­£ mkimage
      - name: Fix mkimage
        run: |
          MKIMAGE_FILE="padavan-ng/trunk/tools/mkimage/mkimage.c"
          if [ -f "$MKIMAGE_FILE" ]; then
            sed -i 's/"%d\.%d"/"%hhd.%hhd"/g' "$MKIMAGE_FILE"
            sed -i 's/"%d\.%d%c"/"%hhd.%hhd%c"/g' "$MKIMAGE_FILE"
          fi

      # 7.5. [å…¨å±€ä¿®å¾©] å‡ç´š iptables 1.8.11 + ä¿®å¾©æ‰€æœ‰ä¾è³´åŒ…è·¯å¾‘
      - name: ğŸ”¥ Auto Upgrade iptables 1.8.11 & Patch
        run: |
          echo "::group::Iptables Upgrade & Patching"
          NEW_VER="iptables-1.8.11"
          OLD_VER_STR="iptables-1.8.10"
          
          # --- Part 1: è™•ç† iptables æœ¬é«” ---
          IPT_MAKEFILE=$(find padavan-ng/trunk/user/iptables -name Makefile | head -n 1)
          IPT_DIR=$(dirname "$IPT_MAKEFILE")
          echo "âœ… é–å®š iptables Makefile: $IPT_MAKEFILE"
          
          # 1. ä¿®æ”¹ç‰ˆæœ¬è™Ÿ
          sed -i "s/SRC_NAME=$OLD_VER_STR/SRC_NAME=$NEW_VER/g" "$IPT_MAKEFILE"
          
          # 2. æ¢å¾©æ­£å¸¸çš„æ§‹å»ºæµç¨‹ (è§£æ±º cd error)
          sed -i 's/^all: config_test/all: download_test extract_test config_test/' "$IPT_MAKEFILE"
          
          # 3. ç§»é™¤ autogen.sh (è§£æ±º not found error)
          sed -i '/.\/autogen.sh/d' "$IPT_MAKEFILE"
          
          # 4. æ¸…ç†éæ™‚çš„ extensions/disabled è¤‡è£½æŒ‡ä»¤ (è§£æ±º copy error)
          sed -i '/extensions\/disabled\//d' "$IPT_MAKEFILE"

          # 5. ç”Ÿæˆå±è”½è­¦å‘Šçš„è£œä¸
          cat << 'EOF' > "$IPT_DIR/999-suppress-warnings.patch"
          --- a/libxtables/xtables.c
          +++ b/libxtables/xtables.c
          @@ -809,9 +809,11 @@
           		dptr = &((*dptr)->next);
           	}
           
          +#if 0
           	if (seen && !found)
           		fprintf(stderr,
           			"Warning: Extension %s is not supported, missing kernel module?\n",
           			name);
          +#endif
           
           	for (ptr = xtables_matches; ptr; ptr = ptr->next) {
          @@ -939,9 +941,11 @@
           		dptr = &((*dptr)->next);
           	}
           
          +#if 0
           	if (seen && !found)
           		fprintf(stderr,
           			"Warning: Extension %s is not supported, missing kernel module?\n",
           			name);
          +#endif
           
           	for (ptr = xtables_targets; ptr; ptr = ptr->next) {
          EOF
          
          # 6. æ³¨å…¥è£œä¸æ‡‰ç”¨é‚è¼¯
          sed -i 's|tar xJf $(SRC_NAME).tar.xz;|tar xJf $(SRC_NAME).tar.xz \&\& patch -d $(SRC_NAME) -p1 < 999-suppress-warnings.patch;|' "$IPT_MAKEFILE"
          
          echo "âœ… Iptables æœ¬é«”ä¿®å¾©å®Œæˆã€‚"

          # --- Part 2: [æ–°å¢] ä¿®å¾©æ‰€æœ‰ä¾è³´ iptables çš„å…¶ä»–è»Ÿé«” (MiniUPnPD ç­‰) ---
          echo "ğŸ” é–‹å§‹æƒæä¸¦ä¿®å¾©ä¾è³´èˆŠç‰ˆ iptables çš„å…¶ä»–å¥—ä»¶..."
          
          # æœå°‹ trunk/user ä¸‹æ‰€æœ‰å«æœ‰ "iptables-1.8.10" å­—ä¸²çš„ Makefile
          grep -rl "$OLD_VER_STR" padavan-ng/trunk/user/ | while read -r file ; do
              echo "  - ä¿®å¾©è·¯å¾‘: $file"
              sed -i "s/$OLD_VER_STR/$NEW_VER/g" "$file"
          done
          
          echo "ğŸ‰ å…¨å±€è·¯å¾‘æ›¿æ›å®Œæˆï¼æ‰€æœ‰å¥—ä»¶ç¾åœ¨éƒ½æŒ‡å‘ $NEW_VER"
          echo "::endgroup::"

      # 7.6 [ç¶²è·¯å·¥å…·] Ebtables v2.0.11 & Arptables (v15 ä¿®æ­£æª”åç‰ˆ)
      - name: ğŸ”¥ Network Tools (Final Fix:Correct Binary Names)
        run: |
          echo "::group::Network Tools Upgrade"
          
          # === è¨­å®šè·¯å¾‘ ===
          BASE_DIR="$GITHUB_WORKSPACE/padavan-ng/trunk/user"
          EBT_ROOT="$BASE_DIR/ebtables"
          ARP_ROOT="$BASE_DIR/arptables"
          
          # ========================================
          # 1. Ebtables v2.0.11 (æŠ“å– legacy æª”å)
          # ========================================
          echo "â¬‡ï¸ Upgrading Ebtables to v2.0.11..."
          
          rm -rf "$EBT_ROOT"
          mkdir -p "$EBT_ROOT"
          cd "$EBT_ROOT" || exit 1
          
          wget --no-check-certificate "https://www.netfilter.org/pub/ebtables/ebtables-2.0.11.tar.gz" -O src.tar.gz
          tar -xf src.tar.gz
          rm -f src.tar.gz
          mv ebtables-2.0.11 src
          
          echo "ğŸ”§ Creating Ebtables Smart Wrapper..."
          
          # [Ebtables Wrapper Makefile]
          cat << 'EOF' > Makefile
          SRC_NAME = src
          
          # ç¹¼æ‰¿ç·¨è­¯åƒæ•¸
          CC ?= gcc
          CFLAGS ?= -O2
          LDFLAGS ?= -s
          
          # æ¨¡æ“¬ OpenWrt ç·¨è­¯æŒ‡ä»¤
          CONFIGURE_CMD = ./configure \
                          --host=mipsel-linux \
                          --prefix=/usr \
                          --sbindir=/sbin \
                          --disable-shared \
                          --enable-static \
                          CFLAGS="$(CFLAGS) -static" \
                          LDFLAGS="$(LDFLAGS) -static -all-static"
          
          all:
          	@if [ ! -f $(SRC_NAME)/Makefile ]; then \
          		echo "ğŸ‘‰ [Ebtables] Configuring..."; \
          		(cd $(SRC_NAME) && $(CONFIGURE_CMD)); \
          	fi
          	@echo "ğŸ‘‰ [Ebtables] Building..."; \
          	$(MAKE) -C $(SRC_NAME) all
          
          clean:
          	@if [ -f $(SRC_NAME)/Makefile ]; then \
          		$(MAKE) -C $(SRC_NAME) clean; \
          	fi
          
          romfs:
          	@echo "ğŸ‘‰ [Ebtables] Installing to ROMFS..."
          	# ä¿®æ­£é‡é»ï¼šv2.0.11 ç”¢ç”Ÿçš„æª”æ¡ˆæ˜¯ ebtables-legacy
          	# æˆ‘å€‘æŠŠå®ƒæŠ“å‡ºä¾†ï¼Œä¸¦å­˜æˆç³»çµ±è¦çš„ /bin/ebtables
          	$(ROMFSINST) $(SRC_NAME)/ebtables-legacy /bin/ebtables
          	$(ROMFSINST) $(SRC_NAME)/ethertypes /etc_ro/ethertypes
          EOF
          
          echo "âœ… Ebtables prepared (Targeting ebtables-legacy)."
          
          # ========================================
          # 2. Arptables v0.0.5 (æ‚¨é©—è­‰æˆåŠŸçš„ç‰ˆæœ¬)
          # ========================================
          echo "â¬‡ï¸ Processing Arptables..."
          
          mkdir -p "$ARP_ROOT"
          cd "$ARP_ROOT" || exit 1
          
          if [ ! -f "Makefile" ] || ! grep -q "arptables" "Makefile"; then
            
            wget --no-check-certificate "https://www.netfilter.org/pub/arptables/arptables-0.0.5.tar.gz" -O src.tar.gz
            tar -xf src.tar.gz
            rm -f src.tar.gz
            mv arptables-v0.0.5 src 2>/dev/null || mv arptables-0.0.5 src
            
            echo "ğŸ”§ Creating Arptables Wrapper..."
            
            # [Arptables Wrapper Makefile]
            cat << 'EOF' > Makefile
          SRC_NAME=src
          all:
          	$(MAKE) -C $(SRC_NAME) \
          		CC="$(CC)" \
          		AR="$(AR)" \
          		KERNEL_DIR=$(KERNEL_HEADERS_PATH) \
          		COPT_FLAGS="-Os -static" \
          		LDFLAGS="-static" \
          		arptables-legacy
          romfs:
          	$(ROMFSINST) $(SRC_NAME)/arptables-legacy /bin/arptables
          clean:
          	$(MAKE) -C $(SRC_NAME) clean
          EOF
          
            cd "$BASE_DIR" || exit 1
            if grep -q "ebtables" Makefile; then
               if ! grep -q "arptables" Makefile; then
                   sed -i '/dir_y += ebtables/a dir_y += arptables' Makefile
               fi
            else
               grep -q "arptables" Makefile || echo "dir_y += arptables" >> Makefile
            fi
          fi
          
          # ========================================
          # 3. Kernel Config
          # ========================================
          cd "$GITHUB_WORKSPACE/padavan-ng/trunk/linux-3.4.x"
          if [ -f ".config" ]; then
             sed -i 's/^.*CONFIG_IP_NF_ARPTABLES.*/CONFIG_IP_NF_ARPTABLES=m/' .config
             grep -q "CONFIG_IP_NF_ARPTABLES" .config || echo "CONFIG_IP_NF_ARPTABLES=m" >> .config
             grep -q "CONFIG_IP_NF_ARPFILTER" .config || echo "CONFIG_IP_NF_ARPFILTER=m" >> .config
             grep -q "CONFIG_IP_NF_ARP_MANGLE" .config || echo "CONFIG_IP_NF_ARP_MANGLE=m" >> .config
          fi
          
          echo "::endgroup::"

      # 8. é–‹å§‹ç·¨è­¯
      - name: Build firmware
        run: |
          echo "::group::Build Process"
          cp build.config padavan-ng/trunk/.config
          cd padavan-ng/trunk
          
          ./clear_tree.sh > /dev/null 2>&1
          rm -rf tmp staging
          
          echo "Starting build... Logs will be saved to build.log"
          set -o pipefail
          ./build_firmware.sh 2>&1 | tee build.log
          echo "::endgroup::"

      # 9. æ™ºæ…§æ‰“åŒ…èˆ‡ç”¢ç‰©åµæ¸¬ (å« iptables Debug æª”æ¡ˆ)
      - name: Smart-Pack & Debug Collection
        run: |
          echo "::group::Smart Packing"
          
          # 0. è¼‰å…¥ç·¨è­¯å¾Œçš„è®Šæ•¸ (ä¿®å¾© Partition Check è­¦å‘Š)
          if [ -f "padavan-ng/trunk/.config" ]; then
            source "padavan-ng/trunk/.config"
          fi

          # 1. å®šç¾©çµ•å°è·¯å¾‘
          WORK_DIR=$(pwd)
          PACK_DIR="$WORK_DIR/output_pack"
          IMAGES_DIR="$WORK_DIR/padavan-ng/trunk/images"
          PARTITIONS_FILE="$WORK_DIR/padavan-ng/trunk/configs/boards/$CONFIG_VENDOR/$CONFIG_FIRMWARE_PRODUCT_ID/partitions.config"
          
          mkdir -p "$PACK_DIR"
          
          # åˆå§‹åŒ–å ±å‘Š
          REPORT_FILE="$PACK_DIR/file_report.txt"
          touch "$REPORT_FILE"
          
          echo "Packing Artifacts to: $PACK_DIR"
          
          # 2. å‚™ä»½é—œéµé…ç½®æª”
          echo "Collecting Debug Configurations..."
          [ -f "padavan-ng/trunk/.config" ] && cp "padavan-ng/trunk/.config" "$PACK_DIR/build.config"
          [ -f "padavan-ng/trunk/user/shared/defaults.h" ] && cp "padavan-ng/trunk/user/shared/defaults.h" "$PACK_DIR/defaults.h.txt"
          [ -f "padavan-ng/trunk/user/www/dict/CN.dict" ] && cp "padavan-ng/trunk/user/www/dict/CN.dict" "$PACK_DIR/CN.dict.txt"
          [ -f "padavan-ng/trunk/linux-3.4.x/.config" ] && cp "padavan-ng/trunk/linux-3.4.x/.config" "$PACK_DIR/kernel.config"
          [ -f "padavan-ng/trunk/build.log" ] && cp "padavan-ng/trunk/build.log" "$PACK_DIR/build.log"

          # =======================================================
          # ğŸ”¥ æ–°å¢ï¼šæ”¶é›† iptables ä¿®æ”¹å¾Œçš„æºç¢¼èˆ‡è£œä¸ (ä¾›é©—è­‰ç”¨)
          # =======================================================
          IPT_SRC_DIR="padavan-ng/trunk/user/iptables/iptables-1.8.11"
          IPT_BASE_DIR="padavan-ng/trunk/user/iptables"
          
          mkdir -p "$PACK_DIR/debug_iptables"
          
          # 1. è¤‡è£½ç”Ÿæˆçš„ patch
          if [ -f "$IPT_BASE_DIR/999-suppress-warnings.patch" ]; then
              cp "$IPT_BASE_DIR/999-suppress-warnings.patch" "$PACK_DIR/debug_iptables/"
              echo "- ğŸ›¡ï¸ **Patch**: Included in debug_iptables" >> "$REPORT_FILE"
          fi
          
          # 2. è¤‡è£½ç·¨è­¯å¾Œå¯¦éš›çš„ xtables.c (é©—è­‰æ˜¯å¦è¢«ä¿®æ”¹)
          # æ³¨æ„ï¼šæ­¤æ–‡ä»¶åªæœ‰åœ¨ç·¨è­¯æˆåŠŸå¾Œæ‰æœƒå­˜åœ¨
          if [ -f "$IPT_SRC_DIR/libxtables/xtables.c" ]; then
              cp "$IPT_SRC_DIR/libxtables/xtables.c" "$PACK_DIR/debug_iptables/xtables_patched.c"
              echo "- ğŸ“„ **Source**: xtables.c (patched) included" >> "$REPORT_FILE"
          else
               echo "âš ï¸ Warning: xtables.c not found (Maybe build failed or path differs)"
          fi
          # =======================================================

          # 3. æŠ“å–éŸŒé«”ç”¢ç‰©ä¸¦ç«‹å³æª¢æŸ¥å¤§å°
          if [ -d "$IMAGES_DIR" ]; then
            echo "Scanning $IMAGES_DIR for images..."
            
            # è®€å–åˆ†å€ä¸Šé™
            if [ -f "$PARTITIONS_FILE" ]; then
              MAX_FW_SIZE="$(awk '/Firmware/ { getline; getline; sub(",", ""); print strtonum($2); }' "$PARTITIONS_FILE")"
              echo "Max Firmware Size Allowed: $MAX_FW_SIZE bytes"
            else
              MAX_FW_SIZE=0
              echo "::warning:: Partition config not found, skipping size check."
            fi

            # å°‹æ‰¾æ‰€æœ‰ç”¢ç‰©
            find "$IMAGES_DIR" -maxdepth 1 -type f \( -name "*.trx" -o -name "*.bin" \) | while read -r file; do
              fname=$(basename "$file")
              fsize=$(stat -c %s "$file")
              
              cp -v "$file" "$PACK_DIR/"
              
              if (( fsize < 500000 )); then
                echo "- ğŸ“¦ **U-Boot**: \`$fname\` ($(numfmt --to=iec $fsize))" >> "$REPORT_FILE"
              else
                echo "- ğŸ’¿ **Firmware**: \`$fname\` ($(numfmt --to=iec $fsize))" >> "$REPORT_FILE"
                
                if (( MAX_FW_SIZE > 0 )); then
                  if (( fsize > MAX_FW_SIZE )); then
                    echo "::error:: Firmware $fname ($fsize bytes) exceeds max size ($MAX_FW_SIZE bytes)!"
                    exit 1
                  else
                    echo "::notice:: $fname size check passed ($fsize / $MAX_FW_SIZE)"
                  fi
                fi
              fi
            done
          else
            echo "::warning:: Images directory not found. Build might have failed completely."
            echo "- âŒ **Error**: No images directory found." >> "$REPORT_FILE"
          fi

          # 4. ç”Ÿæˆ MD5 (ä¿®å¾©ï¼šåªå°æª”æ¡ˆç”Ÿæˆï¼Œé¿é–‹è³‡æ–™å¤¾)
          cd "$PACK_DIR"
          for f in *; do
            if [ -f "$f" ]; then
              md5sum "$f" >> md5sum.txt
            fi
          done
          
          # è®€å–å ±å‘Šä¾› Release ä½¿ç”¨
          FILE_REPORT_CONTENT=$(cat file_report.txt)
          {
            echo "FILE_REPORT<<EOF"
            echo "$FILE_REPORT_CONTENT"
            echo "EOF"
          } >> $GITHUB_ENV
          
          # æ‰¾å‡ºæœ€å¤§çš„éŸŒé«”æª”æ¡ˆ (æ’é™¤ uboot) 
          MAIN_FW=$(find . -type f \( -name "*.trx" -o -name "*.bin" \) -printf "%s\t%p\n" | sort -n | tail -1 | cut -f2)
          [ ! -z "$MAIN_FW" ] && echo "MAIN_FW_PATH=$PACK_DIR/${MAIN_FW#./}" >> $GITHUB_ENV
          
          cd "$WORK_DIR"

          # 5. æ‰“åŒ… Zip
          if [ "$(ls -A $PACK_DIR)" ]; then
            ZIP_NAME="padavan_pack_${CONFIG_VENDOR}_${CONFIG_FIRMWARE_PRODUCT_ID}.zip"
            zip -j -r "$ZIP_NAME" "$PACK_DIR"
            echo "ZIP_FILE_PATH=$WORK_DIR/$ZIP_NAME" >> $GITHUB_ENV
          else
            echo "::error:: output_pack is empty!"
            exit 1
          fi
          
          echo "BUILD_TIMESTAMP=$(TZ='Asia/Taipei' date '+%Y.%m.%d_%H.%M.%S')" >> $GITHUB_ENV
          echo "CONFIG_VENDOR=$CONFIG_VENDOR" >> $GITHUB_ENV
          echo "CONFIG_FIRMWARE_PRODUCT_ID=$CONFIG_FIRMWARE_PRODUCT_ID" >> $GITHUB_ENV
          echo "::endgroup::"

      - name: Upload artifacts (ZIP)
        uses: actions/upload-artifact@v4
        with:
          name: padavan_${{ env.CONFIG_VENDOR }}_${{ env.CONFIG_FIRMWARE_PRODUCT_ID }}_${{ env.BUILD_TIMESTAMP }}
          path: ${{ env.ZIP_FILE_PATH }}

      # 10. ç™¼å¸ƒ Release
      - name: Set Release Tag
        if: github.event_name == 'workflow_dispatch'
        run: |
          echo "TAG_NAME=${{ inputs.target_select }}-${{ env.BUILD_TIMESTAMP }}" >> $GITHUB_ENV

      - name: Publish Release
        if: github.event_name == 'workflow_dispatch'
        uses: ncipollo/release-action@v1
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit: ${{ github.sha }}
          tag: ${{ env.TAG_NAME }}
          name: ${{ inputs.target_select }} [${{ env.BUILD_TIMESTAMP }}]
          body: |
            **Padavan ç·¨è­¯å ±å‘Š (Early Check)**
            * **æ©Ÿå‹**: ${{ inputs.target_select }}
            * **æ™‚é–“**: ${{ env.BUILD_TIME }} (Taipei Time)
            * **User**: ${{ env.SIGNACCOUNT }} / **Pass**: ${{ env.SIGNPASSWORD }}
            * **WiFi**: ${{ env.WIFI2GSSID }} / ${{ env.WIFI5GSSID }}
            
            ### ğŸ“¦ ç”¢ç‰©åµæ¸¬
            ${{ env.FILE_REPORT }}
            
            ### ğŸ›  Debug æª”æ¡ˆ (å·²åŒ…å«åœ¨ Zip)
            * `defaults.h.txt` (æª¢æŸ¥ IP/å¸³å¯† æ˜¯å¦ä¿®æ”¹æˆåŠŸ)
            * `CN.dict.txt` (æª¢æŸ¥èªè¨€æª”)
            * `build.log` (ç·¨è­¯æ—¥èªŒ)
            * `build.config` (ç·¨è­¯åƒæ•¸)
            * `kernel.config` (æ ¸å¿ƒåƒæ•¸)
          artifacts: ${{ env.ZIP_FILE_PATH }}
          allowUpdates: true
          artifactErrorsFailBuild: true
